# ESPHome LVGL Dual Microphone Waveform Display
# =============================================================================
# Real-time audio waveform visualization for Voice Assistant
# Works with ES7210 ADC + ES8311 DAC on ESP32-P4
# =============================================================================

globals:
  # Audio sample buffers
  - id: audio_sample_left
    type: int
    initial_value: "0"
  - id: audio_sample_right
    type: int
    initial_value: "0"
  # Voice assistant state for visual feedback
  - id: va_is_listening
    type: bool
    initial_value: "false"

# =============================================================================
# I2S AUDIO CONFIGURATION (ES7210 + ES8311)
# =============================================================================
i2s_audio:
  - id: audio_bus
    i2s_mclk_pin: GPIO13
    i2s_lrclk_pin: GPIO10
    i2s_bclk_pin: GPIO12

audio_dac:
  - platform: es8311
    id: es8311_dac
    i2c_id: bsp_bus
    address: 0x18

audio_adc:
  - platform: es7210
    id: es7210_adc
    i2c_id: bsp_bus
    address: 0x40

microphone:
  - platform: i2s_audio
    id: esp32_microphone
    i2s_audio_id: audio_bus
    i2s_din_pin: GPIO11
    sample_rate: 16000
    bits_per_sample: 16bit
    adc_type: external

speaker:
  - platform: i2s_audio
    id: esp32_speaker
    i2s_audio_id: audio_bus
    i2s_dout_pin: GPIO9
    audio_dac: es8311_dac
    dac_type: external
    channel: stereo
    buffer_duration: 100ms
    bits_per_sample: 16bit
    sample_rate: 48000

  - platform: mixer
    id: mixing_speaker
    output_speaker: esp32_speaker
    source_speakers:
      - id: announcement_mixing_input
        timeout: never
      - id: media_mixing_input
        timeout: never

  - platform: resampler
    id: announcement_resampling_speaker
    output_speaker: announcement_mixing_input
    sample_rate: 48000
    bits_per_sample: 16

  - platform: resampler
    id: media_resampling_speaker
    output_speaker: media_mixing_input
    sample_rate: 48000
    bits_per_sample: 16

media_player:
  - platform: speaker
    name: "ESP32 P4 Media Player"
    id: speaker_media_player
    codec_support_enabled: true
    volume_min: 0.5
    volume_max: 0.75
    volume_increment: 0.05
    announcement_pipeline:
      speaker: announcement_resampling_speaker
      format: FLAC
      sample_rate: 48000
      num_channels: 1
    media_pipeline:
      speaker: media_resampling_speaker
      format: FLAC
      num_channels: 1
      sample_rate: 48000
    on_announcement:
      - if:
          condition:
            - microphone.is_capturing:
          then:
            - micro_wake_word.stop
            - voice_assistant.stop
      - mixer_speaker.apply_ducking:
          id: media_mixing_input
          decibel_reduction: 20
          duration: 0.0s
      - switch.turn_on: audio_amplifier
      - delay: 100ms
    on_state:
      if:
        condition:
          and:
            - not:
                voice_assistant.is_running:
            - not:
                media_player.is_announcing:
        then:
          - mixer_speaker.apply_ducking:
              id: media_mixing_input
              decibel_reduction: 0
              duration: 1.0s
    on_play:
      - logger.log: "Media player started playing"
      - switch.turn_on: audio_amplifier
      - delay: 100ms
      - micro_wake_word.stop
      - voice_assistant.stop
    on_idle:
      - delay: 100ms
      - switch.turn_off: audio_amplifier
      - if:
          condition:
            not:
              voice_assistant.is_running:
          then:
            - micro_wake_word.start

micro_wake_word:
  id: my_wake_word
  models:
    - model: https://github.com/chrisdunnname/esphome-p4-86-panel-eth-2ro-lvgl/raw/main/microwakeword/okay_hal.json
      id: okay_hal
  on_wake_word_detected:
    then:
      - logger.log: "Wake word detected"
      - lambda: 'id(va_is_listening) = true;'
      # Update UI to show listening state
      - lvgl.label.update:
          id: mic_status_label
          text: "Listening..."
          text_color: 0x00FF00
      - voice_assistant.start:
          wake_word: !lambda return wake_word;

voice_assistant:
  microphone: esp32_microphone
  media_player: speaker_media_player
  micro_wake_word: my_wake_word
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 2.0
  conversation_timeout: 300s
  on_listening:
    - lambda: 'id(va_is_listening) = true;'
    - lvgl.label.update:
        id: mic_status_label
        text: "Listening..."
        text_color: 0x00FF00
  on_stt_end:
    - lvgl.label.update:
        id: mic_status_label
        text: "Processing..."
        text_color: 0xFFFF00
  on_tts_start:
    - lambda: 'id(va_is_listening) = false;'
    - lvgl.label.update:
        id: mic_status_label
        text: "Speaking..."
        text_color: 0x00BFFF
  on_end:
    - lambda: 'id(va_is_listening) = false;'
    - lvgl.label.update:
        id: mic_status_label
        text: "Say 'Okay HAL'"
        text_color: 0x808080
    - wait_until:
        condition:
          - media_player.is_announcing:
        timeout: 0.5s
    - wait_until:
        - and:
            - not:
                media_player.is_announcing:
            - not:
                media_player.is_playing:
    - micro_wake_word.start:
  on_error:
    - lambda: 'id(va_is_listening) = false;'
    - lvgl.label.update:
        id: mic_status_label
        text: "Error - Try again"
        text_color: 0xFF0000
    - delay: 2s
    - lvgl.label.update:
        id: mic_status_label
        text: "Say 'Okay HAL'"
        text_color: 0x808080
  on_client_connected:
    - lvgl.label.update:
        id: mic_status_label
        text: "Say 'Okay HAL'"
        text_color: 0x808080
    - micro_wake_word.start:
  on_client_disconnected:
    - lvgl.label.update:
        id: mic_status_label
        text: "Disconnected"
        text_color: 0xFF0000
    - micro_wake_word.stop:

# =============================================================================
# AUDIO WAVEFORM UPDATE
# =============================================================================
interval:
  # Fast update for waveform display (8ms = ~125Hz refresh)
  - interval: 8ms
    then:
      - lambda: |-
          // Read microphone data and update charts
          // ES7210 provides stereo input on I2S
          // Left channel = MIC1, Right channel = MIC2

          // Simulated waveform when voice assistant is listening
          static float phase = 0;
          if (id(va_is_listening)) {
            // Active listening - show voice waveform
            float noise = (rand() % 6000) - 3000;
            id(audio_sample_left) = (int)(sin(phase) * 12000 +
                                          sin(phase * 2.1) * 6000 +
                                          noise);
            id(audio_sample_right) = (int)(sin(phase * 0.95) * 11000 +
                                           sin(phase * 1.8) * 7000 +
                                           noise * 0.9);
            phase += 0.12;
          } else {
            // Idle - show ambient noise floor
            id(audio_sample_left) = (rand() % 1000) - 500;
            id(audio_sample_right) = (rand() % 1000) - 500;
          }
      # Update charts with audio samples
      - lvgl.chart.set_next_value:
          id: chart_mic_left
          series_index: 0
          value: !lambda 'return id(audio_sample_left);'
      - lvgl.chart.set_next_value:
          id: chart_mic_right
          series_index: 0
          value: !lambda 'return id(audio_sample_right);'

# =============================================================================
# LVGL CONFIGURATION
# =============================================================================
lvgl:
  displays:
    - display_id: my_display
      pages:
        - id: dual_mic_page
          bg_color: 0x1a1a1a
          widgets:
            # Title
            - label:
                align: TOP_MID
                y: 10
                text: "Voice Assistant"
                text_color: 0xFFFFFF
                text_font: montserrat_24

            # Status indicator
            - label:
                id: mic_status_label
                align: TOP_MID
                y: 45
                text: "Initializing..."
                text_color: 0x808080
                text_font: montserrat_16

            # Container for microphone display
            - obj:
                id: mic_container
                align: CENTER
                y: 20
                width: 520
                height: 160
                bg_color: 0x2a2a2a
                radius: 16
                border_width: 2
                border_color: 0x404040
                pad_all: 10
                widgets:
                  # ===== LEFT MICROPHONE CHART =====
                  - label:
                      x: 5
                      y: 0
                      text: "MIC-L"
                      text_color: 0x40FFA1
                      text_font: montserrat_14

                  - chart:
                      id: chart_mic_left
                      x: 0
                      y: 20
                      width: 240
                      height: 110
                      bg_color: 0x383838
                      radius: 10
                      border_width: 0
                      type: LINE
                      point_count: 128
                      update_mode: SHIFT
                      y_axis:
                        id: axis_left_y
                        major_len: 0
                        minor_len: 0
                        min: -32768
                        max: 32767
                      x_axis:
                        id: axis_left_x
                        major_len: 0
                        minor_len: 0
                      series:
                        - id: series_mic_left
                          color: 0x40FFA1
                          axis: PRIMARY_Y
                          hidden: false
                      items:
                        bg_opa: TRANSP
                      indicator:
                        width: 0
                        height: 0

                  # ===== RIGHT MICROPHONE CHART =====
                  - label:
                      x: 265
                      y: 0
                      text: "MIC-R"
                      text_color: 0x40FFA1
                      text_font: montserrat_14

                  - chart:
                      id: chart_mic_right
                      x: 260
                      y: 20
                      width: 240
                      height: 110
                      bg_color: 0x383838
                      radius: 10
                      border_width: 0
                      type: LINE
                      point_count: 128
                      update_mode: SHIFT
                      y_axis:
                        id: axis_right_y
                        major_len: 0
                        minor_len: 0
                        min: -32768
                        max: 32767
                      x_axis:
                        id: axis_right_x
                        major_len: 0
                        minor_len: 0
                      series:
                        - id: series_mic_right
                          color: 0x40FFA1
                          axis: PRIMARY_Y
                          hidden: false
                      items:
                        bg_opa: TRANSP
                      indicator:
                        width: 0
                        height: 0

            # Wake word hint
            - label:
                align: BOTTOM_MID
                y: -15
                text: "Wake word: 'Okay HAL'"
                text_color: 0x606060
                text_font: montserrat_14

# =============================================================================
# REAL MICROPHONE DATA INTEGRATION
# =============================================================================
# To read actual microphone data from ES7210, you need to access the I2S buffer.
# The microphone component doesn't expose raw samples directly.
#
# For real waveform display, you can:
# 1. Use a custom component to read I2S data
# 2. Use the voice_assistant events to show activity
# 3. Use ADC pins if available for analog monitoring
#
# Example custom I2S read (requires custom component):
# - lambda: |-
#     int16_t samples[64];
#     size_t bytes_read;
#     i2s_read(I2S_NUM_0, samples, sizeof(samples), &bytes_read, 0);
#     if (bytes_read > 0) {
#       // Left channel (even indices)
#       id(audio_sample_left) = samples[0];
#       // Right channel (odd indices)
#       id(audio_sample_right) = samples[1];
#     }
#

substitutions:
  name: tab5
  friendly_name: M5Stack Tab5
  loading_illustration_file: https://github.com/esphome/wake-word-voice-assistants/raw/main/casita/loading_320_240.png
  idle_illustration_file: https://github.com/esphome/wake-word-voice-assistants/raw/main/casita/idle_320_240.png
  listening_illustration_file: https://raw.githubusercontent.com/youkorr/speaker-box/refs/heads/main/images/listening.png
  thinking_illustration_file: https://raw.githubusercontent.com/youkorr/speaker-box/refs/heads/main/images/thinking.png
  replying_illustration_file: https://raw.githubusercontent.com/youkorr/speaker-box/refs/heads/main/images/replying.png
  error_illustration_file: https://github.com/esphome/wake-word-voice-assistants/raw/main/casita/error_320_240.png
  timer_finished_illustration_file: https://raw.githubusercontent.com/youkorr/speaker-box/refs/heads/main/images/timer.png

  #camera
   
  #frigate1: rtsp://Tapoone:Tapoone132@192.168.1.56:554/stream1 

  frigate: "http://192.168.1.38:8123/local/snapshots/last_snapshot.jpg"

  #frigate: "http://192.168.1.61:5244/d/sd_card/snap/last_snapshot.jpg?sign=rojVLd-w9bw1zX4spdARKUg501W9kwcFg9u8EzC7Xdc=:0"

  #wallpaper: "http://192.168.1.38:8123/local/llmvision/abstrac.png"
  #mediaplayer
  media_player_entity: "media_player.tab5_tab5_media_player"

  
    # URLs des stations de radio"
  #radio_fun_url: " https://icecast.funradio.fr/fun-1-44-128?listen=webGJmqBU59boQ7rZDjrGO5e4"
  #radio_skyrock_url: "http://icecast.skyrock.net/s/natio_mp3_128k"
  #radio_sud_url: "https://live.sudradio.fr/sudradio-mp3-128"
  #radio_rtl_url: "https://icecast.rtl.fr/rtl2-1-44-128?listen=webGJmqBU59boQ7rZDjrGO5e4"
  #radio_Mouv_Soul_url: "https://icecast.radiofrance.fr/mouvrnb-hifi.aac"
  #radio_nrj_url: "https://streaming.nrjaudio.fm/oumvmk8fnozc"


  power_icon:        "\U0000e909"
  play_icon:         "\U0000e90a"
  pause_icon:        "\U0000e90b"
  back_step_icon:    "\U0000e90c"
  forward_step_icon: "\U0000e90d"
  volume_off_icon:   "\U0000e90e"
  volume_on_icon:    "\U0000e90f"
  volume_minus_icon: "\U0000e910"
  volume_plus_icon:  "\U0000e911"
  repeat_all_icon:   "\U0000e912"
  repeat_off_icon:   "\U0000e913"
  repeat_one_icon:   "\U0000e914"
  ha:                "\U0000e90b" # home assistant
  humidity:          "\U0000e912" # humidity
  temperature:       "\U0000e915" # temperature
  tvoc:              "\U0000e914" # air quality
  co2:               "\U0000e913" # co2
  door:              "\U000F081A"
  garage:            "\U000F06D9"
  shutter:           "\U000F1A8B"
  setting:           "\U000F08D6"
  alarm:             "\U000F0BC4"
  exit_icon:         "\U0000e902"
  

  settings_icon:                 "\U0000e903"
  info_icon:                     "\U0000e904"
  devices_icon:                  "\U0000e905"
  home_icon:                     "\U0000e906"
  ceiling_icon:                  "\U0000e907"
  lightbulb_icon:                "\U0000e908"
  spotlight_group_icon:          "\U0000e915"
  desk_lamp_icon:                "\U0000e916"
  pendant_lamp_icon:             "\U0000e917" 
  ceiling_lamp_icon:             "\U0000e918"
  ceiling_lamp_variant_icon:     "\U0000e921"
  night_lamp_icon:               "\U0000e919"
  swipe_icon:                    "\U0000e91a"
  brightness_icon:               "\U0000e900"
 

  voice_assist_idle_phase_id: "1"
  voice_assist_listening_phase_id: "2"
  voice_assist_thinking_phase_id: "3"
  voice_assist_replying_phase_id: "4"
  voice_assist_not_ready_phase_id: "10"
  voice_assist_error_phase_id: "11"
  voice_assist_muted_phase_id: "12"
  voice_assist_timer_finished_phase_id: "20"

  loading_illustration_background_color: "000000"
  idle_illustration_background_color: "000000"
  listening_illustration_background_color: "FFFFFF"
  thinking_illustration_background_color: "FFFFFF"
  replying_illustration_background_color: "FFFFFF"
  error_illustration_background_color: "000000"
  timer_illustration_background_color: "FFFFFF"
  
  alarm_panel_entity:   "alarm_control_panel.alarmo" #"alarm_control_panel.security"
  pin_code:             "1169"
  unlock_pin_code: "0000" 

  shield_home_icon:      "\U000F068A" # home
  shield_away_icon:      "\U000F099D" # away
  shield_night_icon:     "\U000F1828" # night
  shield_vacation_icon:  "\U000F06BB" # vacation
  shield_disarm_icon:    "\U000F099E" # disarmed
  shield_arming_icon:    "\U000F0498" # arming
  micro_sd:              "\U000F07DC"




  allowed_characters: " !#%'()+,-./0123456789:;<>?@ABCDEFGHIJKLMNOPQRSTUVWYZ[]_abcdefghijklmnopqrstuvwxyz{|}°²³µ¿ÁÂÄÅÉÖÚßàáâãäåæçèéêëìíîðñòóôõöøùúûüýþāăąćčďĐđēėęěğĮįıļľŁłńňőřśšťũūůűųźŻżŽžơưșțΆΈΌΐΑΒΓΔΕΖΗΘΚΜΝΠΡΣΤΥΦάέήίαβγδεζηθικλμνξοπρςστυφχψωϊόύώАБВГДЕЖЗИКЛМНОПРСТУХЦЧШЪЭЮЯабвгдежзийклмнопрстуфхцчшщъыьэюяёђєіїјљњћאבגדהוזחטיכלםמןנסעפץצקרשת،ءآأإئابةتجحخدذرزسشصضطظعغفقكلمنهوىيٹپچڈکگںھہیےংকচতধনফবযরলশষস়ািু্చయలిెొ్ംഅആഇഈഉഎഓകഗങചജഞടഡണതദധനപഫബഭമയരറലളവശസഹാിീുൂെേൈ്ൺൻർൽൾაბგდევზთილმნოპრსტუფქყშჩცძჭხạảấầẩậắặẹẽếềểệỉịọỏốồổỗộớờởợụủứừửữựỳ—、一上不个中为主乾了些亮人任低佔何作供依侧係個側偵充光入全关冇冷几切到制前動區卧厅厨及口另右吊后吗启吸呀咗哪唔問啟嗎嘅嘛器圍在场執場外多大始安定客室家密寵对將小少左已帘常幫幾库度庫廊廚廳开式後恆感態成我戲戶户房所扇手打执把拔换掉控插摄整斯新明是景暗更最會有未本模機檯櫃欄次正氏水沒没洗活派温測源溫漏潮激濕灯為無煙照熱燈燥物狀玄现現瓦用發的盞目着睡私空窗立笛管節簾籬紅線红罐置聚聲脚腦腳臥色节著行衣解設調請謝警设调走路車车运連遊運過道邊部都量鎖锁門閂閉開關门闭除隱離電震霧面音頂題顏颜風风食餅餵가간감갔강개거게겨결경고공과관그금급기길깥꺼껐꼽나난내네놀누는능니다닫담대더데도동됐되된됨둡드든등디때떤뜨라래러렇렌려로료른를리림링마많명몇모무문물뭐바밝방배변보부불블빨뽑사산상색서설성세센션소쇼수스습시신실싱아안않알았애야어얼업없었에여연열옆오온완외왼요운움워원위으은을음의이인일임입있작잠장재전절정제져조족종주줄중줘지직진짐쪽차창천최추출충치침커컴켜켰쿠크키탁탄태탬터텔통트튼티파팬퍼폰표퓨플핑한함해했행혀현화활후휴힘，？"
  
  font_glyphsets: "GF_Latin_Core"
  # for Greek use "Noto Sans" for other languages use a compatible font family
  font_family: Figtree

  #micro_wake_word_model: okay_nabu



esphome:
  name: tab5
  friendly_name: ${friendly_name}
  on_boot:
    priority: 850
    then: 
      - logger.log: "Démarrage - Attente du montage de la carte SD..."
      - delay: 5s
      - logger.log: "Délai écoulé - Allumage du rétroéclairage"
      - light.turn_on: backlight



esp32:
  variant: esp32p4
  flash_size: 16MB
  cpu_frequency: 360MHz
  framework:
    type: esp-idf
    version: 5.5.2
    platform_version: 55.03.35
    #version: 5.5.1
 
    advanced:
      #loop_task_stack_size: 16384
      enable_idf_experimental_features: true
      disable_vfs_support_dir: false
    sdkconfig_options:
 

      CONFIG_ESP_H264_DUAL_TASK: "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: "y"
      CONFIG_SPIRAM_RODATA: "y"
      CONFIG_ESP32_SPIRAM_SUPPORT: "y"
      CONFIG_SPIRAM_USE_MALLOC: "y"
      CONFIG_FATFS_LFN_STACK: "y"
      #CONFIG_LWIP_SO_RCVBUF: "y"
      CONFIG_LWIP_MAX_SOCKETS: "16"
      CONFIG_VFS_SUPPORT_IO: "y"
      CONFIG_VFS_MAX_COUNT: "16" 
      CONFIG_ESP_MAIN_TASK_STACK_SIZE: "16384"
      CONFIG_ESP_TIMER_TASK_STACK_SIZE: "4096"
      #CONFIG_ESP_TASK_WDT_TIMEOUT_S: "60"
      CONFIG_ESP_TASK_LOOP_STACK_SIZE: "16384"
      CONFIG_FATFS_LFN_HEAP: "y"
      DCONFIG_USE_AUDIO_AAC_SUPPORT: "y"
      DCONFIG_ESP_JPG_DECODE_ENABLE: "y"
      DCONFIG_ESPHOME_ENABLE_PNGLE: "1"
      CONFIG_SPIRAM_SPEED_200M: "y"  # ← NOUVEAU: 200 MHz au lieu de défaut
      CONFIG_SPIRAM_SPEED: "200"




# Enable Home Assistant API
api:
  encryption:
    key: "abR90uWSUsIzcOXklvNX8+8VzY2OAtD1fy0Q5NbVtcU="

ota:
  - platform: esphome
    password: "86894068431f6a83d85363eb206af4ed"

network:
  enable_ipv6: true

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Tab5 Fallback Hotspot"
    password: "Ajvr7QWStbGr"

captive_portal:



http_request:
  #verify_ssl: false


online_image:
  - url: "${frigate}"
    format: JPG
    id: cctv_img
    byte_order: little_endian    
    type: RGB565
    resize: 1000x600 #450x300 #1000x700
    #on_download_finished:
      #- lvgl.image.update:
          #id: cctv_img_lvgl
          #src: cctv_img  

  #- url: "http://192.168.1.38:8123/local/llmvision/fun.png"
    #format: PNG
    #type: RGB565
    #byte_order: little_endian 
    #resize: 320x240
    #id: cctv_img1
    #on_download_finished:
      #- lvgl.obj.update:
          #id: cctv_fun
          #bg_image_src: cctv_img1


  #- url: "http://192.168.1.158:8080/ldcobChH/abstrac1.png"
    #format: PNG
    #type: RGB565
    #byte_order: little_endian 
    #resize: 1000x700
    #id: cctv_img2 
    #on_download_finished:
      #- lvgl.obj.update:
          #id: wallpaper
          #bg_image_src: cctv_img2          


logger:
  hardware_uart: USB_SERIAL_JTAG
  level: DEBUG

    #app: DEBUG

    #storage: DEBUG
    #storage.sd_image: DEBUG
    #tab5_camera: DEBUG


external_components:


  - source:
      type: git
      url: https://github.com/youkorr/test2_esp_video_esphome
      ref: main #claude/fix-sc202cs-bayer-format-jJtiS #claude/fix-camera-latency-MdsV8 # main #claude/add-resolution-640x480-kc76b #claude/fix-avi-player-CMUNW  #claude/fix-ov02c10-sensor-config-5PfLm #
    components: [sd_mmc_card, webdavbox3, storage, esp_video, esp_cam_sensor, lvgl_camera_display, simple_video_player, network_camera]
    refresh: always
      

# ============================================================================
# ESP-Video Core (M5Stack Tab5 style)
# ============================================================================  
esp_video:
  i2c_id: bsp_bus
  xclk_pin: GPIO36
  xclk_freq: 24000000
  enable_h264: false
  enable_jpeg: true
  enable_isp: true
  use_heap_allocator: true

# ============================================================================
# Caméra MIPI-CSI 
# ============================================================================

esp_cam_sensor:
  id: tab5_cam
  i2c_id: bsp_bus
  sensor_type: sc202cs        #"sensor_type" au lieu de "sensor"
  resolution: "800x600"          # 800x640 , 1024x600 ,vga # "640x480"
  pixel_format: "RGB565"      # Zero-copy 
  framerate: 30
  jpeg_quality: 15
  rotation: 0
  mirror_x: false
  mirror_y: false
  crop_offset_x: 0
  ppa_enabled: false
  #output_width: 800     
  #output_height: 600



      
# ============================================================================
# Display LVGL avec caméra
# ============================================================================  
lvgl_camera_display:
  id: camera_display
  camera_id: tab5_cam
  canvas_id: camera_canvas
  update_interval: 100ms
  #face_detection_id: face_detect

# ============================================================================
# video_player 
# ============================================================================  

simple_video_player:
  id: my_video_player
  file_path: "/sdcard/MJPEG/dna.mjpeg"
  # "/sdcard/MP4/video_02_optimized.avi"  # "/sdcard/MJPEG/video_02.avi" # "/sdcard/MP4/slywalker640x480.avi" # "/sdcard/MJPEG/vedio1.avi"
  #width: 1280
  #height: 720
  fps: 20
  parent_id: video_page
  speaker: tab5_speaker # ← AJOUTEZ CETTE LIGNE!
  show_controls: true
  auto_play: false
  loop: false
  preload_to_memory: false
  rotation: 0
    # ✨ NOUVEAU : Arrêt automatique du micro
  #on_play:
    #- micro_wake_word.stop:
    #- voice_assistant.stop:
    #- delay: 200ms  # Temps pour libérer le bus I2S
  
  # ✨ NOUVEAU : Redémarrage automatique du micro
  #on_stop:
    #- delay: 1500ms  # Attendre que le speaker vide son buffer
    #- micro_wake_word.start: 

# ============================================================================
# avi_player 
# ============================================================================ 

#avi_player:
  #id: my_video_player
  #file_path: "/sdcard/MP4/slywalker640x480.avi"
  #width: 640
  #height: 480
  #parent_id: video_page
  #fps: 20
  #speaker: tab5_speaker 
  #show_controls: true       # ✅ NOUVEAU
  #show_slider: true         # ✅ NOUVEAU
  #preload_to_memory: false  # ✅ NOUVEAU
  #auto_play: false
  #loop: false
  #rotation: 0
    # ✨ NOUVEAU : Arrêt automatique du micro
  #on_play:
    #- micro_wake_word.stop:
    #- voice_assistant.stop:
    #- delay: 200ms  # Temps pour libérer le bus I2S
  
  # ✨ NOUVEAU : Redémarrage automatique du micro
  #on_stop:
    #- delay: 1500ms  # Attendre que le speaker vide son buffer
    #- micro_wake_word.start:
  #buffer_size: 131072 

# ============================================================================
# network_camera
# ============================================================================ 


network_camera:
  - id: security_cam_1
    url: "http://192.168.1.38:1984/api/stream.mjpeg?src=frigate1_esp32" #"http://192.168.1.38:1984/api/stream.mjpeg?src=frigate1_esp32"  #""rtsp://192.168.1.38:8554/frigate1_esp32_h264""
    protocol: mjpeg
    width: 640
    height: 480
    canvas_id: security_canvas
    update_interval: 100ms

#multi_camera_display:
  #id: security_display
  #canvas_id: security_canvas
  #cameras:
    #- camera_id: security_cam_1    

# ============================================================================
# lvgl_advanced
# ============================================================================ 

#lvgl_advanced_features:
  #thorvg: 
    #internal: true
  #svg: true
  #lottie: true
  
  # Options de performance (optionnel)
  #gif: true
  #qrcode: true
  #draw_sw_complex: true
  #draw_sw_asm: "none"      # ou "neon" pour ARM NEON (plus rapide)
  #shadow_cache_size: 16
  #img_cache_size: 8

# ============================================================================
# rtsp_server
# ============================================================================

#rtsp_server:
  #id: rtsp_srv
  #camera_id: tab5_cam
  #port: 554                # Port RTSP standard
  #stream_path: "/stream"   # URL: rtsp://<IP>:554/stream
  
  # Authentification (optionnel)
  #username: "youkorr"
  #password: "youkorr123"
  
  #bitrate: 2000000
  #gop: 30    

# ============================================================================
# Serveur Web HTTP (streaming MJPEG + snapshots)
# ============================================================================
#camera_web_server:
  #id: web_cam_srv
  #camera_id: tab5_cam
  #port: 8080
  #enable_stream: true       # http://IP:8080/stream
  #enable_snapshot: false      # http://IP:8080/pic

# ============================================================================
# sd_mmc_card
# ===========================================================================
sd_mmc_card:
  id: sd_card
  clk_pin: GPIO43
  cmd_pin: GPIO44
  data0_pin: GPIO39
  data1_pin: GPIO40
  data2_pin: GPIO41
  data3_pin: GPIO42
  mode_1bit: false
  slot: 0   
    
# ============================================================================
# webdavbox3
# ===========================================================================

webdavbox3:
  id: sd_cards
  root_path: "/sdcard"
  url_prefix: "/"
  port: 81
  username: "youkorr"
  password: "youkorr"


# ============================================================================
# storage
# ============================================================================

storage:
    platform: sd_direct
    id: my_storage
    sd_component: sd_card
    root_path: "/sdcard" 
    sd_images:



      - id: sanctuary
        file_path: "/img/sanctuary.jpg"
        resize: 1280x720
        format: rgb565
        byte_order: little_endian
        
        

      - id: Zephyrus
        file_path: "/jpg/Zephyrus.jpg"
        resize: 1280x720
        format: rgb565
        byte_order: little_endian
            

      - id: genshin_impact
        file_path: "/jpg/genshin_impact.jpg"
        resize: 1280x720
        format: rgb565
        byte_order: little_endian

      #- id: irise
        #file_path: "/jpg/irise.jpg"
        #resize: 1280x720
        #format: rgb565
        #byte_order: little_endian 

      #- id: holohub
        #file_path: "/jpg/holohub.jpg"
        #resize: 1280x720
        #format: rgb565
        #byte_order: little_endian    

      - id: peaceful
        file_path: "/jpg/peaceful.jpg"
        resize: 1280x720
        format: rgb565
        byte_order: little_endian  

      - id: exploration
        file_path: "/jpg/exploration.jpg"
        resize: 1280x720
        format: rgb565
        byte_order: little_endian  

         

      #- id: cheon1
        #file_path: "/jpg/cheon1.jpg"
        #resize: 1280x720
        #format: rgb565
        #byte_order: little_endian 
  ############## test PNG #################################
      #- id: abstrac1
        #file_path: "/img/abstrac1.png"
        #resize: 1280x720
        #format: rgb565
        #byte_order: little_endian

  ############# test photo ############################

      #- id: slideshow_image
        #file_path: "/diap/NCC1.jpg"
        #format: RGB565
        #byte_order: little_endian

      #- id: slideshow_image
        #file_path: "/photos/"
        #format: RGB565
        #byte_order: little_endian

psram:
  mode: hex
  speed: 200MHz

time:
 #- platform: homeassistant
    #id: ha_time
    #on_time_sync:
      #- script.execute: update_clock


  - platform: homeassistant
    id: homeassistant_time
    on_time_sync:
      - script.execute: update_clock
      - if:
          condition:
            lambda: 'return id(device_last_restart).state == "";'
          then:
            - text_sensor.template.publish:
                id: device_last_restart
                state: !lambda 'return id(homeassistant_time).now().strftime("%a %d %b %Y - %I:%M:%S %p");'          
    on_time:
      - seconds: "*"
        then:
          - script.execute: update_clock

  - platform: sntp
    id: sntp_time
    servers:
     - ntp0.ntp-servers.net
     - ntp1.ntp-servers.net
     - ntp2.ntp-servers.net
    on_time_sync:
      - script.execute: update_clock
    on_time:
      - minutes: '*'
        seconds: 0
        then:
          - script.execute: update_clock
               


globals:

  - id: cam1_state
    type: bool
    initial_value: 'false'

  - id: sleep_display_start
    type: uint32_t
    initial_value: '0'  
  # Etat de verrouillage de l'ecran
  - id: display_lock
    type: bool
    initial_value: 'false'

  # Timestamp de debut du timeout sur face_unlock_page
  - id: unlock_timeout_start
    type: uint32_t
    initial_value: '0'

  # Duree du timeout sur face_unlock_page (en secondes)
  - id: face_unlock_timeout_sec
    type: int
    initial_value: '145'

  - id: is_minimized
    type: bool
    restore_value: no
    initial_value: 'true'

  - id: current_image_index
    type: int
    initial_value: '1'

  - id: max_images
    type: int
    initial_value: '8'
  - id: slideshow_active
    type: bool
    initial_value: 'false'  # Démarre en pause

  - id: slideshow_delay
    type: int
    initial_value: '5000'   # en ms (5s)

  - id: alarm_panel_pending_action
    type: std::string
    restore_value: no
    initial_value: ""


  - id: current_radio_station
    type: int
    restore_value: true
    initial_value: '0'  # Commence avec Fun Radio (0=Fun, 1=Skyrock, 2=Sud, 3=RTL2)  

  - id: display_timeout
    type: int
    restore_value: true
    initial_value: "2"

  - id: global_is_assisting
    type: bool
    restore_value: false  

  - id: timer_running
    type: bool
    restore_value: no
    initial_value: 'false' # Indique si le timer est en cours d'exécution    

  - id: timer_started
    type: bool
    restore_value: no
    initial_value: "false"
  
  - id: is_alarm_active
    type: bool
    initial_value: 'false'

  - id: is_timer_finished
    type: bool
    initial_value: 'false'

  - id: timer_active
    type: bool
    initial_value: 'false'

  - id: wifi_connection
    type: bool
    restore_value: no
    initial_value: "false"

  - id: api_connection
    type: bool
    restore_value: no
    initial_value: "false"

  - id: ota_active
    type: bool
    initial_value: 'false'

  - id: mic_muted
    type: bool
    restore_value: no
    initial_value: 'false'

  - id: init_in_progress
    type: bool
    restore_value: false
    initial_value: "true"

  - id: auto_off_timer_active
    type: bool
    initial_value: 'false'
    

  - id: countdown_time
    type: int
    restore_value: no
    initial_value: '0'
  - id: total_timer_time
    type: int
    restore_value: no
    initial_value: '0'    

  - id: current_pin
    type: std::string
    initial_value: ""   

  - id: current_track_id
    type: int
    initial_value: '0'
  - id: is_playing
    type: bool
    initial_value: 'false'
  - id: volume_level
    type: int
    initial_value: '50'
  - id: track_count
    type: int
    initial_value: '0'  

  - id: show_playlist
    type: bool
    initial_value: 'false'
  - id: current_time
    type: int
    initial_value: '0'
  - id: total_time
    type: int
    initial_value: '180'  

  - id: current_radio_track_id
    type: int
    initial_value: '-1'
    
  - id: current_music_track_id
    type: int
    initial_value: '-1' 

  - id: current_volume
    type: float  
    initial_value: '0.5'
  - id: is_muted
    type: bool
    initial_value: 'false'
  - id: volume_before_mute
    type: float
    initial_value: '0.5'
  # Nouveau global pour empêcher le sleep pendant les interactions
  - id: touch_active
    type: bool
    initial_value: 'false'

  - id: idle_delay_seconds
    type: int
    initial_value: '300' 

  - id: s_saver_visible
    type: bool
    restore_value: no
    initial_value: "false"   

  - id: repeat_modes
    type: std::vector<std::string>
    initial_value: '{"all", "one", "off"}'
  - id: repeat_icons
    type: std::vector<std::string>
    initial_value: '{"${repeat_all_icon}", "${repeat_one_icon}", "${repeat_off_icon}"}'
  - id: current_repeat_mode_idx
    type: int
    initial_value: '0'
  - id: tmp_repeat_mode
    type: std::string
    restore_value: no
    initial_value: '"all"'
  - id: tmp_repeat_icon
    type: std::string
    restore_value: no
    initial_value: '"${repeat_all_icon}"'
  - id: cover_url
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: duration_slider_user_interaction
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: slider_position
    type: float
    restore_value: no
    initial_value: '0.5'
  - id: pending_cover_url
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: pending_repeat_value
    type: std::string
    restore_value: no
    initial_value: '""'

  - id: camera_streaming_active
    type: bool
    restore_value: no
    initial_value: 'false'   


number:


  - platform: template
    id: brightness_slider
    name: "Luminosité Écran"
    icon: "mdi:brightness-6"
    min_value: 0
    max_value: 100
    step: 1
    unit_of_measurement: "%"
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 50
    on_value:
      then:
        - if:
            condition:
              lambda: 'return x > 0;'
            then:
              - light.turn_on:
                  id: backlight
                  brightness: !lambda 'return x / 100.0;'
            else:
              - light.turn_off:
                  id: backlight

  - platform: template
    name: "Screen Off"
    id: auto_off
    optimistic: true
    restore_value: true
    min_value: -1
    max_value: 300
    step: 1
    unit_of_measurement: s
    icon: 'mdi:television-off'
    disabled_by_default: true
    initial_value: 0
    on_value:
      then:
        - lvgl.label.update:
            id: current_timeout_value
            text: !lambda |-
              int timeout = id(auto_off).state;
              if (timeout == -1) return "OFF";
              return (std::to_string(timeout) + "s").c_str();


  - platform: template
    name: "Slideshow Interval"
    id: slideshow_interval
    optimistic: true
    restore_value: true
    min_value: 1
    max_value: 30
    step: 1
    unit_of_measurement: "s"
    icon: 'mdi:timer'
    initial_value: 5
    on_value:
      then:
        - lvgl.label.update:
            id: current_slideshow_value
            text: !lambda |-
              int val = (int)round(id(slideshow_interval).state);
              return std::string(std::to_string(val) + "s");

  - platform: template
    name: "Auto-Lock Timeout"
    id: auto_lock_timeout
    icon: 'mdi:television-off'
    unit_of_measurement: s
    initial_value: 45
    min_value: -1  # -1 = désactivé
    max_value: 300
    step: 10
    disabled_by_default: true
    optimistic: true
    restore_value: true
    on_value:
      then:
        - lambda: |-
            id(face_unlock_timeout_sec) = (int)x;
            ESP_LOGI("lock", "Auto-Lock timeout: %d sec", (int)x);           


  #- platform: template
    #name: "Brightness Level"
    #min_value: 0
    #max_value: 10
    #step: 1
    #optimistic: true
    #on_value:
      #then:
        #- lambda: |-
            #id(tab5_cam).set_brightness_level((uint8_t)x);              

  #- platform: template
    #name: "Luminosité Caméra"
    #id: brightness_level
    #min_value: 0
    #max_value: 10
    #step: 1
    #initial_value: 5
    #optimistic: true
    #icon: "mdi:brightness-6"
    #set_action:
      #- lambda: |-
          #ESP_LOGI("camera_control", "Réglage luminosité: %.0f", x);
          #id(tab5_cam)->set_brightness_level(x);
  
  # Contrôle avancé - Exposition
 #- platform: template
    #name: "Exposition (Manuel)"
    #id: manual_exposure
    #min_value: 500
    #max_value: 4000
    #step: 100
    #initial_value: 2496
    #optimistic: true
    #icon: "mdi:camera-iris"
    #set_action:
      #- lambda: |-
          #ESP_LOGI("camera_control", "Réglage exposition: %.0f", x);
          #id(tab5_cam)->adjust_exposure(x);
  
  # Contrôle avancé - Gain
  #- platform: template
    #name: "Gain (Manuel)"
    #id: manual_gain
    #min_value: 0
    #max_value: 120
    #step: 5
    #initial_value: 20
    #optimistic: true
    #icon: "mdi:amplifier"
    #set_action:
      #- lambda: |-
          #ESP_LOGI("camera_control", "Réglage gain: %.0f", x);
          #id(tab5_cam)->adjust_gain(x);

  #- platform: template
    #id: display_timeout_number
    #name: LVGL screen timeout
    #optimistic: true
    #unit_of_measurement: "s"
    #initial_value: 180
    #restore_value: true
    #min_value: 30
    #max_value: 600
    #step: 5
    #mode: box




script:
  - id: update_clock
    then:
      # Mise à jour de l'heure (format HH:MM)
      - lvgl.label.update:
          id: time_label
          text: !lambda |-
            auto time = id(homeassistant_time).now();
            return str_sprintf("%02d:%02d", time.hour, time.minute);          
      
      # Mise à jour de la date avec jour de la semaine (format: "Tuesday, Apr 23")
      - lvgl.label.update:
          id: date_label
          text: !lambda |-
            auto time = id(homeassistant_time).now();
            const char* days[] = {"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"};
            const char* months[] = {"", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
            return str_sprintf("%s, %s %02d", days[time.day_of_week - 1], months[time.month], time.day_of_month);

      #- lvgl.label.update:
          #id: sleep_time_label
          #text: !lambda |-
            #auto time = id(homeassistant_time).now();
            #return str_sprintf("%02d:%02d", time.hour, time.minute);

  #- id: start_slideshow
    #then:
      #- lambda: |
          #id(slideshow_active) = true;
          #id(current_image_index) = 1;
      #- sd_image.load:
          #id: slideshow_image
          #file_path: "/diap/NCC1.jpg"


  #- id: update_cover_script
    #mode: restart
    #then:
      #- lambda: |-
          #std::string url = id(pending_cover_url);
          #id(cover_url) = url;
      #- homeassistant.action:
          #action: display_tools.save_media_cover
          #data:
            #entity_id: "${media_player_entity}"
            #size: small
      #- delay: 1s
      #- online_image.release: media_image_jpeg
      #- online_image.set_url:
          #id: media_image_jpeg
          #url:  "${ha_server}/local/display_tools/cover.jpeg"


  #- id: update_cover_script
    #mode: restart
    #then:
      #- delay: 1s
      #- online_image.release: cctv_img1  # Corrected: utilisez cctv_img1 pas cctv_fun
      #- online_image.set_url:
          #id: cctv_img1  # Corrected: utilisez cctv_img1 pas cctv_fun
          #url: "http://192.168.1.38:8123/local/llmvision/fun.png"


  #- id: update_wallpaper_script
    #mode: restart
    #then:
      #- delay: 5s
      #- online_image.release: cctv_img2   # Corrected: utilisez cctv_img1 pas cctv_fun
      #- online_image.set_url:
          #id: cctv_img2 # Corrected: utilisez cctv_img1 pas cctv_fun
          #url: "http://192.168.1.158:8080/ldcobChH/abstrac1.png"          


  #- id: handle_duration_slider_release_script
    #mode: restart
    #then:
      #- homeassistant.service:
          #service: media_player.media_seek
          #data:
            #entity_id: "${media_player_entity}"
            #seek_position: !lambda 'return std::to_string(int(id(slider_position)));'
      #- delay: 2s
      #- lambda: |-
          #id(duration_slider_user_interaction) = false;



  #- id: update_wallpaper_script
    #then:
      #- lambda: |-
          #// Define the callback function to process each chunk of data
          #auto callback = [](const uint8_t *data, size_t length) {
            #ESP_LOGD("update_wallpaper_script", "Read %d bytes", length);
            #// Process the data chunk here (e.g., send it to a display or log it)
          #};

          #// Read the file in chunks using read_file_stream
          #id(sd_card)->read_file_stream(
            #"/abstrac1.jpg",  // File path
            #0,                   // Start reading from the beginning of the file
            #1024,                // Read 1 KB chunks
            #callback             // Callback function to process each chunk
          #);    


sensor:

  #- platform: sd_mmc_card
    #type: total_space
    #name: "SD card total space"


  - platform: homeassistant
    id: weather_temp
    entity_id: weather.montauban
    attribute: temperature
    on_value: 
      then:
        - lvgl.label.update:
            id: weather_temperature_page
            text:
              format: "%.0f°"
              args: [id(weather_temp).state]
             
              
  - platform: homeassistant
    id: weather_humidity
    entity_id: weather.montauban
    attribute: humidity
    on_value: 
      then:
        - lvgl.label.update:
            id: weather_humidity_page
            text:
              format: "%.0f%%"
              args: [id(weather_humidity).state]





# SRAM Usage sensor for ESP32-P4
  # 1. Total SRAM memory usage
  - platform: template
    name: "SRAM Usage"
    id: sram_usage
    icon: mdi:memory
    unit_of_measurement: "KB"
    device_class: data_size
    state_class: measurement
    accuracy_decimals: 1
    update_interval: 10s
    lambda: |-
      // Total SRAM size for ESP32-S3 = 512KB
      const size_t total_sram = 512 * 1024;
      size_t free_sram = heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
      size_t used_sram = total_sram - free_sram;
      return used_sram / 1024.0; // Return used memory in KB
    on_value:
      then:
        - lvgl.bar.update:
            id: sram_memory_bar
            value: !lambda |-
              const size_t total_sram = 512 * 1024; // 512KB for ESP32-S3
              size_t free_sram = heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
              size_t used_sram = total_sram - free_sram;
              return (int)(((double)used_sram / total_sram) * 100);
        - lvgl.label.update:
            id: sram_memory_label
            text: !lambda |-
              const size_t total_sram = 512 * 1024;
              size_t free_sram = heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
              size_t used_sram = total_sram - free_sram;
              static char sram_buf[32];
              snprintf(sram_buf, sizeof(sram_buf), "%.1f/%.0f KB", 
                      used_sram/1024.0, total_sram/1024.0);
              return sram_buf;

  # 2. PSRAM Usage sensor for ESP32-P4 (32MB)
  - platform: template
    name: "PSRAM Usage"
    id: psram_usage
    icon: mdi:memory
    unit_of_measurement: "MB"
    device_class: data_size
    state_class: measurement
    accuracy_decimals: 1
    update_interval: 10s
    lambda: |-
      // Total PSRAM size for ESP32-P4 = 32MB
      const size_t total_psram = 32 * 1024 * 1024;
      size_t free_psram = heap_caps_get_free_size(MALLOC_CAP_SPIRAM);
      
      // If PSRAM is not available, return 0
      if (heap_caps_get_total_size(MALLOC_CAP_SPIRAM) == 0) {
        return 0.0;
      }
      
      size_t used_psram = total_psram - free_psram;
      return used_psram / (1024.0 * 1024.0); // Return used memory in MB
    on_value:
      then:
        - lvgl.bar.update:
            id: psram_memory_bar
            value: !lambda |-
              const size_t total_psram = 32 * 1024 * 1024; // 32MB for ESP32-P4
              size_t free_psram = heap_caps_get_free_size(MALLOC_CAP_SPIRAM);
              
              if (heap_caps_get_total_size(MALLOC_CAP_SPIRAM) == 0) return 0;
              
              size_t used_psram = total_psram - free_psram;
              return (int)(((double)used_psram / total_psram) * 100);
        - lvgl.label.update:
            id: psram_memory_label
            text: !lambda |-
              const size_t total_psram = 32 * 1024 * 1024;
              size_t free_psram = heap_caps_get_free_size(MALLOC_CAP_SPIRAM);
              static char psram_buf[32];
              
              if (heap_caps_get_total_size(MALLOC_CAP_SPIRAM) == 0) {
                snprintf(psram_buf, sizeof(psram_buf), "No PSRAM");
              } else {
                size_t used_psram = total_psram - free_psram;
                snprintf(psram_buf, sizeof(psram_buf), "%.1f/%.0f MB", 
                        used_psram/(1024.0*1024.0), total_psram/(1024.0*1024.0));
              }
              return psram_buf;

  - platform: internal_temperature
    name: "ESP32 Internal Temperature"
    id: esp32_temperature
    update_interval: 30s
    on_value:
      then:
        - lvgl.label.update:
            id: chip_temperature_label
            text:
              format: "%.1f°C"
              args: [id(esp32_temperature).state] 

  - platform: wifi_signal
    name: "WiFi Signal"
    id: wifi_signal_db
    update_interval: 5s
    unit_of_measurement: "dBm"
    on_value:
      then:
        - lvgl.label.update:
            id: wifi_signal_label
            text:
              format: "%.0f dBm"
              args: [id(wifi_signal_db).state]  

  #- platform: template
    #name: "Camera Frame Update"
    #id: camera_frame_sensor
    #internal: true
    #update_interval: never  # Désactivé par défaut
    #lambda: |-
      #static int frame_count = 0;
      #if (id(tab5_cam).is_streaming()) {
        #frame_count++;
      #}
      #return (float)frame_count;

  #- platform: template
    #name: "Camera FPS"
    #lambda: |-
      #return id(tab5_cam).get_frame_number() / (millis() / 1000.0);
    #update_interval: 3s

  #- platform: template
    #name: "Frames Captured"
    #lambda: |-
      #return id(tab5_cam).get_frame_number();
    #update_interval: 1s
 

 
text_sensor:


  - platform: template
    name: "Play Music"  

  - platform: template
    id: current_station_url
    name: "Current Station URL"

  #- platform: sd_mmc_card
    #sd_card_type:
      #name: "SD card type"  

  - platform: template
    name: 'Last Restart'
    id: device_last_restart
    icon: mdi:clock
    entity_category: diagnostic

  - platform: homeassistant
    id: sun_state
    entity_id: sun.sun 

  - platform: homeassistant
    id: current_date
    entity_id: sensor.date
    on_value:
      then:
        - lvgl.label.update:
            id: date_label
            text: !lambda |-
              return id(current_date).state.c_str();


  - platform: wifi_info
    ip_address:
      name: "IP Address"
      id: wifi_ip_address
      on_value:
        then:
          - lvgl.label.update:
              id: ip_address_label
              text: !lambda return id(wifi_ip_address).state.c_str();



  - platform: homeassistant
    id: media_player_esphome
    entity_id: media_player.tab5_tab5_media_player             

        


  #- platform: homeassistant
    #id: media_player_friendly_name
    #entity_id: "${media_player_entity}"
    #attribute: friendly_name
    #on_value:
      #- lvgl.label.update:
          #id: media_player_name_label
          #text: !lambda return x;
  - platform: homeassistant
    id: alarm_panel_sensor_state
    entity_id: ${alarm_panel_entity}
    on_value:
      then:

        - if:
            condition:
              lambda: 'return x == "disarmed";'
            then:
              - lvgl.widget.show: alarm_panel_button_home
              - lvgl.widget.show: alarm_panel_button_away
              - lvgl.widget.show: alarm_panel_button_night
              - lvgl.widget.show: alarm_panel_button_vacation             
              - lvgl.widget.hide: alarm_panel_button_disarmed

              - lvgl.label.update:
                  id: alarm_panel_status
                  text_color: color_steel_blue
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_blue
                  text: "${shield_disarm_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_blue

            else:
              - lvgl.label.update:
                  id: alarm_panel_status
                  text_color: color_crimson
              - lvgl.widget.hide: alarm_panel_button_home
              - lvgl.widget.hide: alarm_panel_button_away
              - lvgl.widget.hide: alarm_panel_button_night
              - lvgl.widget.hide: alarm_panel_button_vacation             
              - lvgl.widget.show: alarm_panel_button_disarmed

        - if:
            condition:
              lambda: 'return x == "arming";'
            then:
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_gray
                  text: "${shield_arming_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_gray

        - if:
            condition:
              lambda: 'return x == "armed_home";'
            then:
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_green
                  text: "${shield_home_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_green

        - if:
            condition:
              lambda: 'return x == "armed_away";'
            then:
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_green
                  text: "${shield_away_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_green

        - if:
            condition:
              lambda: 'return x == "armed_night";'
            then:
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_green
                  text: "${shield_night_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_green

        - if:
            condition:
              lambda: 'return x == "armed_vacation";'
            then:
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_green
                  text: "${shield_vacation_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_green


  - platform: homeassistant
    id: alarm_panel_sensor_name
    entity_id: ${alarm_panel_entity}
    attribute: friendly_name
    on_value:
      then:
        - lvgl.label.update:
            id: alarm_panel_label_name
            text: !lambda return x;                  



output:
  - platform: ledc
    pin: GPIO22  
    id: backlight_pwm
    frequency: 100Hz
 
  
 
  

light:
  - platform: monochromatic
    output: backlight_pwm
    name: "Display Backlight"
    id: backlight
    restore_mode: RESTORE_DEFAULT_ON
    default_transition_length: 250ms
   # on_turn_on: 
     # then:
     # - if:
          #condition:
           # lambda: 'return id(display_timeout_number).state > 0;'
          #then:
            #- delay: !lambda 'return id(display_timeout_number).state*1000;'
            #- light.turn_off: 
                #id: backlight
                #transition_length: 10s

                


esp32_hosted:
  variant: esp32c6
  active_high: true
  clk_pin: GPIO12
  cmd_pin: GPIO13
  d0_pin: GPIO11
  d1_pin: GPIO10
  d2_pin: GPIO9
  d3_pin: GPIO8
  reset_pin: GPIO15
  slot: 1




 

i2c:
  - id: bsp_bus
    sda: GPIO31
    scl: GPIO32
    scan: True
    frequency: 400kHz     

esp_ldo:
  - voltage: 2.5V
    channel: 3   




pi4ioe5v6408:
  - id: pi4ioe1
    address: 0x43
    # 0: O - wifi_antenna_int_ext
    # 1: O - speaker_enable
    # 2: O - external_5v_power
    # 3: NC
    # 4: O - lcd reset
    # 5: O - touch panel reset
    # 6: O - camera reset
    # 7: I - headphone detect
  - id: pi4ioe2
    address: 0x44
    # 0: O - wifi_power
    # 1: NC
    # 2: NC
    # 3: O - usb_5v_power
    # 4: O - poweroff pulse
    # 5: O - quick charge enable (inverted)
    # 6: I - charging status
    # 7: O - charge enable

  #- id: pi4ioe3
    #address: 0x45    

switch:

  #- platform: template
    #name: "RTSP Server"
    #id: rtsp_enable_switch
    #restore_mode: RESTORE_DEFAULT_OFF  # OFF au démarrage
    #optimistic: true
    #turn_on_action:
      #- lambda: |-
          #auto *rtsp = id(rtsp_srv);
          #if (rtsp != nullptr) {
            #rtsp->set_enabled(true);
          #}
    #turn_off_action:
      #- lambda: |-
          #auto *rtsp = id(rtsp_srv);
          #if (rtsp != nullptr) {
            #rtsp->set_enabled(false);
          #}
  - platform: network_camera
    name: "Camera 1"
    camera_id: security_cam_1
    id: camera_1_switch  

  - platform: template
    name: "LVGL Camera Display"
    id: lvgl_display_enable_switch
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    turn_on_action:
      - lambda: |-
          auto *lvgl_disp = id(camera_display);  
          if (lvgl_disp != nullptr) {
            lvgl_disp->set_enabled(true);
          }
    turn_off_action:
      - lambda: |-
          auto *lvgl_disp = id(camera_display);  
          if (lvgl_disp != nullptr) {
            lvgl_disp->set_enabled(false);
          } 


  #- platform: template
    #name: "Camera Web Server"
    #id: web_camera_enable_switch
    #restore_mode: RESTORE_DEFAULT_OFF  # OFF au démarrage
    #optimistic: true
    #turn_on_action:
      #- lambda: |-
          #auto *web_cam = id(web_cam_srv);
          #if (web_cam != nullptr) {
            #web_cam->set_enabled(true);
          #}
    #turn_off_action:
      #- lambda: |-
          #auto *web_cam = id(web_cam_srv);
          #if (web_cam != nullptr) {
            #web_cam->set_enabled(false);
          #}    
  - platform: gpio
    id: wifi_power
    name: "WiFi Power"
    pin:
      pi4ioe5v6408: pi4ioe2
      number: 0
    restore_mode: ALWAYS_ON

  - platform: gpio
    id: usb_5v_power
    name: "USB Power"
    pin:
      pi4ioe5v6408: pi4ioe2
      number: 3

  - platform: gpio
    id: quick_charge
    name: "Quick Charge"
    pin:
      pi4ioe5v6408: pi4ioe2
      number: 5
      inverted: true

  - platform: gpio
    id: charge_enable
    name: "Charge Enable"
    pin:
      pi4ioe5v6408: pi4ioe2
      number: 7

  - platform: gpio
    id: wifi_antenna_int_ext
    pin:
      pi4ioe5v6408: pi4ioe1
      number: 0

  - platform: gpio
    id: speaker_enable
    name: "Speaker Enable"
    pin:
      pi4ioe5v6408: pi4ioe1
      number: 1
    restore_mode: ALWAYS_ON
    inverted: False



  - platform: gpio
    id: external_5v_power
    name: "External 5V Power"
    pin:
      pi4ioe5v6408: pi4ioe1
      number: 2
 

  - platform: gpio
    id: interrupt_pin_toushsreen
    name: "interrupt_pin_toushscreen"
    pin:
      inverted: true
      number: GPIO23
    restore_mode: ALWAYS_ON  


  - platform: gpio
    id: cam_rst
    name: "Camera Reset"
    pin:
      pi4ioe5v6408: pi4ioe1
      number: 6
    restore_mode: ALWAYS_ON
    on_turn_on:
      - delay: 100ms
      - logger.log: "Camera reset activated"   

  #- platform: template
    #name: "Voice Assistant Continuous"
    #id: voice_continuous_switch
    #turn_on_action:
      #- voice_assistant.start_continuous:
    #turn_off_action:
      #- voice_assistant.stop:
    #lambda: |-
      #return id(tab5_microphone).is_running();
  #- platform: template
    #name: "Auto Exposure"
    #optimistic: true
    #turn_on_action:
      #- lambda: |-
          #id(tab5_cam).set_auto_exposure(true);
    #turn_off_action:
      #- lambda: |-
          #id(tab5_cam).set_auto_exposure(false);





touchscreen:
  - platform: gt911
    reset_pin:
      pi4ioe5v6408: pi4ioe1
      number: 5
    calibration:
      x_min: 0
      y_max: 720
      y_min: 0
      x_max: 1280
    id: touch_screen
    on_touch:
      - lambda: |-
          ESP_LOGD("touchscreen", "Touch detected at (%d, %d)", touch.x, touch.y);
      - light.turn_on: backlight          
    transform:
      swap_xy: true
      mirror_x: true
      mirror_y: false
     





binary_sensor:
  - platform: gpio
    id: charging
    name: "Charging Status"
    pin:
      pi4ioe5v6408: pi4ioe2
      number: 6
      mode: INPUT_PULLDOWN

  - platform: gpio
    id: headphone_detect
    name: "Headphone Detect"
    filters:
      - delayed_on: 200ms
      - delayed_off: 200ms
    pin:
      pi4ioe5v6408: pi4ioe1
      number: 7
      # Important: vérifiez si le pin doit être inversé selon votre hardware
      inverted: false  # Ajustez selon votre circuit
    on_press:
      # Casque détecté - désactiver le speaker et configurer l'ES8388
      then:
        - logger.log: "Casque détecté - basculement vers sortie casque"
        - switch.turn_off: speaker_enable
        - select.set:
            id: dac_output_select
            option: "Line 1"  # Casque sur Line 1
    on_release:
      # Casque déconnecté - réactiver le speaker
      then:
        - logger.log: "Casque déconnecté - basculement vers speaker"
        - switch.turn_on: speaker_enable
        - select.set:
            id: dac_output_select
            option: "Line 1"  # TEST: Speaker aussi sur Line 1

  #- platform: template
    #id: voice_active  

  #- platform: template
    #name: "Camera Streaming Status"
    #id: camera_streaming_status
    #lambda: |-
      #return id(camera_streaming_active);


select:

  - platform: template
    id: wifi_antenna_select
    name: "WiFi Antenna"
    options:
      - "Internal"
      - "External"
    optimistic: true
    on_value:
      - if:
          condition:
            lambda: return i == 0;
          then:
            - switch.turn_off: wifi_antenna_int_ext
          else:
            - switch.turn_on: wifi_antenna_int_ext



  - platform: es8388
    dac_output:
      id: dac_output_select
      name: "DAC Output"
    adc_input_mic:
      name: "ADC Input Mic"

i2s_audio:
  - id: mic_bus
    i2s_lrclk_pin: GPIO29
    i2s_bclk_pin: GPIO27
    i2s_mclk_pin: GPIO30

audio_adc:
  - platform: es7210
    id: es7210_adc
    bits_per_sample: 16bit
    sample_rate: 16000

microphone:
  - platform: i2s_audio
    id: tab5_microphone
    i2s_audio_id: mic_bus
    i2s_din_pin: GPIO28
    sample_rate: 16000
    bits_per_sample: 16bit
    adc_type: external

audio_dac:
  - platform: es8388
    id: es8388_dac

speaker:
  - platform: i2s_audio
    id: tab5_speaker
    i2s_audio_id: mic_bus
    i2s_dout_pin: GPIO26
    audio_dac: es8388_dac
    dac_type: external
    channel: mono
    buffer_duration: 1000ms 
    bits_per_sample: 16bit
    sample_rate: 48000



  - platform: mixer
    id: mixing_speaker
    output_speaker: tab5_speaker
    num_channels: 2
    source_speakers:
      - id: announcement_mixing_input
        timeout: never
      - id: media_mixing_input
        timeout: never        

  - platform: resampler
    id: announcement_resampling_speaker
    output_speaker: announcement_mixing_input
    sample_rate: 48000
    bits_per_sample: 16

  - platform: resampler
    id: media_resampling_speaker
    output_speaker: media_mixing_input
    sample_rate: 48000
    bits_per_sample: 16    

media_player:
  - platform: speaker
    name: "Tab5_media_player"
    id: speaker_player
    #codec_support_enabled: true
    # buffer_size: 2000000
    #task_stack_in_psram: true
    volume_min: 0.5
    volume_max: 0.95
    volume_increment: 0.5
    announcement_pipeline:
      speaker: announcement_resampling_speaker
      format: FLAC
      sample_rate: 48000
      num_channels: 1
    media_pipeline:
      speaker: media_resampling_speaker
      format: FLAC
      num_channels: 2
      sample_rate: 48000
    on_announcement:
      - if:
          condition:
            - microphone.is_capturing:
          then:
            - micro_wake_word.stop
            - voice_assistant.stop
      - mixer_speaker.apply_ducking:
          id: media_mixing_input
          decibel_reduction: 30
          duration: 0.0s
      #- switch.turn_on: audio_amplifier
      - delay: 100ms
    on_state:
      if:
        condition:
          and:
            - not:
                voice_assistant.is_running:
            - not:
                media_player.is_announcing:
        then:
          - mixer_speaker.apply_ducking:
              id: media_mixing_input
              decibel_reduction: 0
              duration: 1.0s
    on_play:
      - logger.log: "Media player started playing, disabling microphone"
      #- switch.turn_on: audio_amplifier
      - delay: 100ms
      - micro_wake_word.stop
      - voice_assistant.stop
    on_idle:
      - delay: 100ms
      #- switch.turn_off: audio_amplifier
      - if:
          condition:
            not:
              voice_assistant.is_running:
          then:
            - micro_wake_word.start


micro_wake_word:
  id: my_wake_word
  models:
    - okay_nabu
  on_wake_word_detected:
    then:
      - lvgl.page.show: listening_page 
      - light.turn_on: backlight
      - logger.log: "Wake word detected"
      - voice_assistant.start:
          wake_word: !lambda return wake_word;

voice_assistant:
  microphone: tab5_microphone
  media_player: speaker_player
  micro_wake_word: my_wake_word
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 2.0
  conversation_timeout: 300s
  on_end:
    - delay: 5s
    - lvgl.page.show: page_home  
    # Wait a short amount of time to see if an announcement starts
    - wait_until:
        condition:
          - media_player.is_announcing:
        timeout: 0.5s
    # Announcement is finished and the I2S bus is free
    - wait_until:
        - and:
            - not:
                media_player.is_announcing:
            - not:
                media_player.is_playing:                
    - micro_wake_word.start:
  on_client_connected:
    - micro_wake_word.start:
  on_client_disconnected:
    - micro_wake_word.stop:


color:

  - id: color_sky_blue
    hex: 3FA7F3
  - id: color_slate_blue_gray
    hex: 343645
  - id: color_steel_blue
    hex: 606682
  - id: color_misty_blue
    hex: 9BA2BC
  - id: color_black
    hex: 0d0d0d
  - id: color_dark_gray
    hex: 333333
  - id: color_gray
    hex: 666666
  - id: color_white
    hex: f2f0eb
  - id: color_red
    hex: ff0000
  - id: color_crimson
    hex: f5075c
  - id: color_blue
    hex: 2fc0ff
  - id: color_yellow
    hex: e7c12c
  - id: color_amber
    hex: f4a900
  - id: color_mint
    hex: 39d19c
  - id: color_green
    hex: 00ff00
  - id: color_orange
    hex: f07c40
  - id: color_deep_orange
    hex: ff6600
  - id: color_violet
    hex: 926BC7
  - id: color_dark_blue
    hex: 4867aa
  - id: color_deep_purple
    hex: 543D72  


  - id: color_nova
    hex: 93A4EC

  - id: color_navy
    hex: aad6ec

  - id: color_cyan
    hex: 00FFFF  
  - id: color_magenta
    hex: FF00FF  

  - id: color_aqua
    hex: "00ffff"          

  # Nova Colors
  - id: nova_color # pink
    hex: "e38de3"
  - id: pri_color # light (mantle)
    hex: "24273a"
  - id: sec_color # dark (crust)
    hex: "181926"
  - id: text_color
    hex: "cad3f5"
  - id: off_color
    hex: "5b6078"


  - id: blue_color
    hex: "6b93e3"
  - id: green_color
    hex: "a6da95"
  - id: yellow_color
    hex: "ffd17a"
  - id: orange_color
    hex: "e0752b"
  - id: red_color
    hex: "de455c"  

  - id: lcars_space_white
    hex: "f5f6fa"
  - id: lcars_violet_creme
    hex: "ddbbff"
  - id: lcars_green
    hex: "33cc99"
  - id: lcars_magenta
    hex: "cc4499"
  - id: lcars_blue
    hex: "4455ff"
  - id: lcars_yellow
    hex: "ffcc33"
  - id: lcars_violet
    hex: "9944ff"
  - id: lcars_orange
    hex: "ff7700"
  - id: lcars_african_violet
    hex: "cc88ff"
  - id: lcars_text_purple
    hex: "cc77ff"
  - id: lcars_red
    hex: "dd4444"
  - id: lcars_emerald
    hex: "00bb00"
  - id: lcars_crimson
    hex: "cc0000"
  - id: lcars_navy_gray
    hex: "2C374B"
  - id: lcars_slate_gray
    hex: "6E748C"
  - id: lcars_teal
    hex: "2A7092"
  - id: lcars_coral
    hex: "FA6851"
  - id: lcars_charcoal
    hex: "51596C"

  - id: color_primary
    hex: '4A90E2'
  - id: color_secondary
    hex: '2ECC71'
  - id: color_text
    hex: 'FFFFFF'
  - id: color_background
    hex: '1A1A1A'
  - id: color_inactive
    hex: '666666'  

  - id: idle_color
    hex: ${idle_illustration_background_color}
  - id: listening_color
    hex: ${listening_illustration_background_color}
  - id: thinking_color
    hex: ${thinking_illustration_background_color}
  - id: replying_color
    hex: ${replying_illustration_background_color}
  - id: loading_color
    hex: ${loading_illustration_background_color}
  - id: error_color
    hex: ${error_illustration_background_color}
  - id: timer_color
    hex: ${timer_illustration_background_color}
  - id: active_timer_color
    hex: "26ed3a"
  - id: paused_timer_color
    hex: "3b89e3"
  - id: active_ota_color
    hex: "ffff00"
  - id: active_mute_color
    hex: "ff0000"




image:

  defaults:
    byte_order: little_endian
    transparency: alpha_channel
    type: rgb565
  images:

                
  #- file: http://192.168.1.158:8080/iryQdAwo/cheon.jpg                             
    #id: testone
    #resize: 1280x720

  #- file: "/img/anuvious.jpg"    
    #id: test
    #resize: 1280x720
    
  #- file:
      #source: sd_card
      #path: "img/anuvious.jpg"
    #id: test
    #resize: 1280x720

  #- file: http://192.168.1.158:8080/ZAPTjwuz/simulation.jpg                  
    #id: wallpaper
    #resize: 1280x720    

  - file: ${error_illustration_file}
    id: casita_error
    resize: 320x240

  - file: ${idle_illustration_file}
    id: casita_idle
    resize: 320x240

  - file: ${listening_illustration_file}
    id: casita_listening
    resize: 320x240

  - file: ${thinking_illustration_file}
    id: casita_thinking
    resize: 320x240

  - file: ${replying_illustration_file}
    id: casita_replying
    resize: 320x240

  - file: ${timer_finished_illustration_file}
    id: casita_timer_finished
    resize: 320x240

  - file: ${loading_illustration_file}
    id: casita_initializing
    resize: 320x240

  #- id: camera_image_file
    #file: /camera.jpg

  #- file: "mdi:camera"  # Image par défaut/placeholder
    #id: camera_placeholder
    #resize: 320x240   


  #- file: https://github.com/esphome/wake-word-voice-assistants/raw/main/error_box_illustrations/error-no-wifi.png
    #id: error_no_wifi
    #resize: 320x240

  #- file: https://github.com/esphome/wake-word-voice-assistants/raw/main/error_box_illustrations/error-no-ha.png
    #id: error_no_ha
    #resize: 320x240


   


font:

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
      italic: true
    id: font_request
    size: 15
    glyphsets:
      - ${font_glyphsets}
  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: font_response
    size: 15
    glyphsets:
      - ${font_glyphsets}

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_16
    size: 16
    glyphsets:
      - ${font_glyphsets}

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_18
    size: 18
    glyphsets:
      - ${font_glyphsets}   


  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_23
    size: 23
    glyphsets:
      - ${font_glyphsets}  


  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_26
    size: 26
    glyphsets:
      - ${font_glyphsets}   

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_28
    size: 28
    glyphsets:
      - ${font_glyphsets}  

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_32
    size: 32
    glyphsets:
      - ${font_glyphsets}                      

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_24
    size: 24
    glyphsets:
      - ${font_glyphsets}           

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_36
    size: 36
    glyphsets:
      - ${font_glyphsets} 

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_42
    size: 42
    glyphsets:
      - ${font_glyphsets}                   

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_60
    size: 60
    glyphsets:
      - ${font_glyphsets}      
  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: font_timer
    size: 30
    glyphsets:
      - ${font_glyphsets} 


 


  - file: "https://github.com/BigBobbas/ESP32-S3-Box3-Custom-ESPHome/raw/main/fonts/materialdesignicons-webfont.ttf"
    id: mdi46
    size: 46
    bpp: 4
    glyphs: [
      "\U000F0BC4",#alarm away
      "\U000F0384",#music
      "\U000F07C5",#sound
      "\U000F1322",#tools
      "\U000F07AE",#cctv
      "\U000F0493",#settings cog
      "\U000F05CB",#voice
      "\U000F0502",#screen settings
      "\U000F1C6F",#info
      "\U000F0521",#scr 
      "\U000F04B2",#sleep
      "\U000F1110",#s_saver
      "\U000F0D90",#screen off
      "\U000F009E",#bell
      "\U000F04DB",#stop
      "\U000F18DD",#light_mut
      "\U000F062C",#source
      "\U000F10FE",#kubernetes
      "\U000F02A4",#github
      "\U000F06B2",#angular
      "\U000F0439",#radio
      "\U000F0BB1",#next
      "\U000F036B",#videocall
      "\U000F1A13",#heure
      "\U000F0F30",#meteo
      "\U000F1923",#timer
      "\U000F056E",#dashboard
      "\U000F07DC",#micro-sd
      "\U000F0CB8",#music_play
      "\U000F08D6",#settings
      "\U000F0565",#arming
      "\U000F050F",#temp sensor
      "\U000F0150",#clock
      "\U000F081A",#door
      "\U000F06D9",#garage
      "\U000F1A8B",#shutter
      "\U000F02E9",#Gallery
      
      ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_24
    size: 24
    bpp: 4
    glyphs: [
      "\U000F068A", # shield home
      "\U000F1828", # shield moon
      "\U000F099D", # shield lock
      "\U000F06BB", # shield plane
      "\U000F099E", # shield off
      "\U000F0498", # shield
    ]

  - file: "fonts/Icons.ttf"
    id: icons_32
    size: 32
    bpp: 4
    glyphs: [
      "\U0000e900",
      "\U0000e901",
      "\U0000e902",
      "\U0000e903",
      "\U0000e904",
      "\U0000e905",
      "\U0000e906",
      "\U0000e907",
      "\U0000e908",
      "\U0000e909",
      "\U0000e90a",
      "\U0000e90b",
      "\U0000e90c",
      "\U0000e90d",
      "\U0000e90e",
      "\U0000e90f",
      "\U0000e910",
      "\U0000e911",
      "\U0000e912",
      "\U0000e913",
      "\U0000e914",
      "\U0000e915",
      "\U0000e916",
      "\U0000e917",
      "\U0000e918",
      "\U0000e919",

    ]
  - file: "fonts/Icons.ttf"
    id: icons_36
    size: 36
    bpp: 4
    glyphs: [
      "\U0000e900",
      "\U0000e901",
      "\U0000e902",
      "\U0000e903",
      "\U0000e904",
      "\U0000e905",
      "\U0000e906",
      "\U0000e907",
      "\U0000e908",
      "\U0000e909",
      "\U0000e90a",
      "\U0000e90b",
      "\U0000e90c",
      "\U0000e90d",
      "\U0000e90e",
      "\U0000e90f",
      "\U0000e910",
      "\U0000e911",
      "\U0000e912",
      "\U0000e913",
      "\U0000e914",
      "\U0000e915",
      "\U0000e916",
      "\U0000e917",
      "\U0000e918",
      "\U0000e919",

      ]

  - file: "fonts/icons_v2.ttf"
    id: icons_38
    size: 38
    bpp: 4
    glyphs: [
      "\U0000e909", # power
      "\U0000e90c", # back step
      "\U0000e90d", # forward step
      "\U0000e912", # repeat_all
      "\U0000e913", # repeat_off
      "\U0000e914", # repeat_one
      "\U0000e90a", # play
      "\U0000e90b", # pause
      "\U0000e91c", # stop
      "\U0000e923", # locate
      "\U0000e924", # docked
    ]

  - file: "fonts/icons_v2.ttf"
    id: icons_48
    size: 48
    bpp: 4
    glyphs: [
      "\U0000e90a", # play
      "\U0000e90b", # pause
      "\U0000e91f", # arrow_up
      "\U0000e920", # arrow_down
      "\U0000e91c", # stop
      "\U0000e923", # locate
      "\U0000e924", # docked
      "\U0000e93b", # air_conditioner 
      "\U0000e936", # heating

    ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_media
    size: 60 #50
    bpp: 8
    glyphs: [
      "\U000F040A", # mdi-media_play
      "\U000F03E4", # mdi-media_pause
      "\U000F04AE", # mdi-media_previous_track
      "\U000F04AD", # mdi-media_next_track 
      "\U000F040E", # mdi-media_play_pause
      "\U000F0662", # skip-next-circle-outline
      "\U000F0664", # skip-previous-circle-outline
      "\U000F0453", # refresh
      "\U000F03E3", # pause
      "\U000F050F",#temp sensor
      "\U000F024A",#garden/flower
      "\U000F0EBA",#stats
      "\U000F1C6F",#info
      "\U000F075A",#music
      "\U000F036F",#voice settings
      "\U000F0502",#screen settings
      "\U000F08D6",#settings
      "\U000F068A",#alarm home
      "\U000F0BC4",#alarm away
      "\U000F1828",#armed night
      "\U000F099E",#disarmed
      "\U000F0565",#arming
      "\U000F1A12",#home 
      "\U000F058E",#humidity         
      "\U000F0590",#weather
      "\U000F07AE",#cctv
      "\U000F1322",#tools
      "\U000F0493",#settings cog
      "\U000F0521",#toggle on
      "\U000F0439",#radio_active
      "\U000F0CB8",#music_play
      "\U000F1A13",#heure
      "\U000F0F30",#meteo
      "\U000F1923",#timer
      "\U000F02A4",#github
      "\U000F062C",#source
      "\U000F18DD",#light_mut
      "\U000F056E",#dashboard
      "\U000F07DC",#micro-sd
      "\U000F0150",#clock
      "\U000F0384",#music-box
      "\U000F035C",#menu
      "\U000F075D",#volume-plus
      "\U000F075E",#volume-minus
      "\U000F0581",#volume-off
      "\U000F1AE1",#timer_play
      "\U000F02E9",#Gallery
      "\U000F07D1",#home-automation
      "\U000F18DE",#ceiling-light-multiple-outline
      "\U000F0450",# Icône rafraîchir
      "\U000F061A", # illumination (lux)

                      

      ]    

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_40
    size: 40
    bpp: 4
    glyphs: [
      "\U000F068A", # shield home
      "\U000F1828", # shield moon
      "\U000F099D", # shield lock
      "\U000F06BB", # shield plane
      "\U000F099E", # shield off
      "\U000F0498", # shield
    ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_52
    size: 52
    bpp: 4
    glyphs: [
      "\U000F068A", # shield home
      "\U000F1828", # shield moon
      "\U000F099D", # shield lock
      "\U000F06BB", # shield plane
      "\U000F099E", # shield off
      "\U000F0498", # shield
      "\U000F0826", # home
      "\U000F1A46", # away
    ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_68
    size: 68
    bpp: 4
    glyphs: [
      "\U000F068A", # shield home
      "\U000F1828", # shield moon
      "\U000F099D", # shield lock
      "\U000F06BB", # shield plane
      "\U000F099E", # shield off
      "\U000F0498", # shield
    ]             

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_35
    size: 35 #50
    bpp: 8
    glyphs: [
      "\U000F061A", # chip

      ] 
  - file: "fonts/icons_v2.ttf"
    id: icons_28
    size: 28
    bpp: 4
    glyphs: [
      "\U0000e902", # exit
      "\U0000e926", # fan
      "\U0000e927", # room_plan
      "\U0000e938", # humidity 
      "\U0000e937", # co2
      "\U0000e93a", # air quality (tvoc)
      "\U0000e939", # temperature 
      "\U0000e92f", # illumination (lux)

    ]

  - file: "gfonts://Roboto"
    id: roboto_32
    size: 32

  - file: "gfonts://Roboto"
    id: roboto_36
    size: 36    
  - file: "gfonts://Roboto"
    id: roboto_42
    size: 42      
  - file: "gfonts://Roboto"
    id: roboto_48
    size: 48       

  - file: "gfonts://Roboto"
    id: roboto_60
    size: 60        

  - file: "gfonts://Roboto"
    id: roboto_30
    size: 30

  - file: "gfonts://Roboto"
    id: roboto_24
    size: 24    

  - file: "gfonts://Roboto"
    id: roboto_20
    size: 20

  - file: "gfonts://Roboto"
    id: roboto_18
    size: 18    
  
  - file: "gfonts://Roboto"
    id: roboto_16
    size: 16
    
  - file: "gfonts://Roboto"
    id: roboto_14
    size: 14
  - file: "gfonts://Roboto"
    id: roboto_12
    size: 12
  - file: "gfonts://Roboto"
    id: roboto_10
    size: 10   

  - file: "gfonts://Roboto"
    id: roboto_8
    size: 8          

  - file: "fonts/Nunito-SemiBold.ttf"
    id: nunito_20
    size: 20
    bpp: 4
    glyphsets:
      - GF_Latin_Core
      # - GF_Greek_Core
      - GF_Cyrillic_Core






display:
  - platform: mipi_dsi
    id: main_display
    model: M5Stack-Tab5
    reset_pin:
      pi4ioe5v6408: pi4ioe1
      number: 4
    update_interval: never
    auto_clear_enabled: false
    rotation: 270

lvgl:

  byte_order: little_endian
  #displays:
    #- main_display
  #touchscreens:
    #- touch_screen
  
  #on_idle:
    #- timeout: !lambda |-
        #int timeout = id(auto_off).state;
        #return (timeout == -1) ? 86400000 : (timeout * 1000);
      #then:
        #- lambda: |-
            #static bool canvas_configured = false;
            #if (!canvas_configured) {
              #auto canvas = id(camera_canvas);
              #if (canvas != nullptr) {
                #id(camera_display).configure_canvas(canvas);
                #canvas_configured = true;
                #ESP_LOGI("lvgl", "Canvas configuré");
              #}
            #}
        
        #- if:
            #condition:
              #lambda: 'return id(auto_off).state > 0;'
            #then:
              #- light.turn_off: backlight

  displays:
    - main_display
  touchscreens:
    - touch_screen
  on_idle:
    timeout: !lambda |-
      int timeout = id(auto_off).state;
      return (timeout == -1) ? 86400000 : (timeout * 1000);  // 24h si désactivé
    then:
      - if:
          condition:
            lambda: 'return id(auto_off).state > 0;'
          then:
            - light.turn_off: backlight


  style_definitions:
    - id: round_mask
      radius: 50%  # Crée un cercle parfait
      clip_corner: true

    - id: menu_button
      radius: 40      
      #text_font: nunito_20
      text_align: CENTER
      bg_color: 0x2F8CD8
      bg_grad_color: 0x0460BD
      bg_grad_dir: VER
      border_width: 5
      border_color: 0x1e84eb
      border_opa: 70%
      outline_width: 1
    - id: time_style
      text_color: 0xD5D5D5
      bg_opa: TRANSP
      radius: 5
      border_color: 0xE9E9E9
      border_width: 0
      border_opa: 50%
      pad_all: 0
      shadow_width: 0
      shadow_opa: TRANSP
    - id: card
      text_color: 0xD5D5D5
      bg_color: 0x222222
      bg_opa: COVER
      radius: 20
      outline_width: 0
      border_width: 0
      #border_opa:
      pad_all: 0 
    - id: weather_style
      text_color: 0xD5D5D5
      bg_color: 0
      bg_opa: TRANSP
      outline_width: 0
      border_width: 0
      #border_opa:
      radius: 0
      pad_all: 0
    - id: meter_style
      text_color: 0xD5D5D5
      bg_color: 0x222222
      bg_opa: COVER
      radius: 10
      outline_width: 0
      border_width: 0
      #border_opa:
      pad_all: 0      
    - id: button_light
      bg_color: 0xCCCCCC
      bg_grad_color: 0xFF4400
      bg_grad_dir: HOR
      border_width: 8
      border_color: 0x222222
      border_opa: 50%
      outline_width: 1
    - id: button_menu
      text_color: 0xD5D5D5
      bg_color: 0x222222
      bg_opa: COVER
      radius: 20
      pad_all: 5
    - id: button_checked
      bg_color: 0xFF4400
      bg_opa: COVER
      text_color: 0xD5D5D5
      radius: 20
      pad_all: 5 
    - id: sound_page
      bg_opa: TRANSP
      border_opa: TRANSP
      radius: 0
      text_color: 0xCCCCCC  # Gris clair pour le texte
      width: 100%
      height: 100%


    - id: home_page
      bg_opa: TRANSP
      border_opa: TRANSP
      radius: 0
      text_color: 0xFFFFFF
      width: 100%
      height: 100%

    - id: controls_page
      bg_opa: TRANSP
      border_opa: TRANSP
      radius: 0
      text_color: 0xFFFFFF
      width: 100%
      height: 100%  

    - id: main_content
      bg_opa: TRANSP
      border_opa: TRANSP
      radius: 0
      text_color: 0xFFFFFF
      width: 100%
      height: 100%

    - id: f1_page
      bg_opa: TRANSP
      border_opa: TRANSP
      radius: 0
      text_color: 0xFFFFFF
      width: 100%
      height: 100%

    - id: style_line
      line_color: 0x0000FF
      line_width: 8
      line_rounded: true
    - id: date_style
      #text_font: nunito_24
      align: center
      text_color: 0x333333
      bg_opa: cover
      radius: 4
      pad_all: 2

        ####Header_Footer##########
    - id: header_footer
      bg_color: 0x2F8CD8
      bg_grad_color: 0x005782
      bg_grad_dir: VER
      bg_opa: COVER
      border_width: 0
      radius: 0
      pad_all: 0
      pad_row: 0
      pad_column: 0
      border_color: 0x0077b3
      text_color: 0xFFFFFF
      width: 100%
      height: 30

    - id: music_style
      text_font: montserrat_16
      text_color: 0x504d6d
      bg_opa: TRANSP
    
    - id: title_style
      text_font: montserrat_14
      text_color: 0x101010
      bg_opa: TRANSP
    
    - id: btn_round_style
      radius: 10
      bg_opa: COVER
    
    - id: spectrum_style
      bg_opa: TRANSP
      border_width: 0     

    - id: style_bg_dark
      bg_color: 0x1a1a1a
      bg_opa: COVER
      border_width: 0
      radius: 0
      
    - id: style_card
      bg_color: 0x2d2d2d
      bg_opa: COVER
      border_width: 0
      radius: 15
      pad_all: 20
      
    - id: style_header
      bg_color: 0x000000
      bg_opa: COVER
      border_width: 0
      radius: 0
      pad_all: 0
      
    - id: style_button
      bg_color: 0x444444
      bg_opa: COVER
      border_width: 0
      radius: 25
      pad_all: 0

  pages:
      - id: page_home
        bg_color: color_black
        on_load:
          then:
            - lvgl.image.update:
                id: update_wallpaper
                src: peaceful

            #- lvgl.image.update:
                #id: update_wallpaper4
                #src: alertBlack                
        widgets:        
          # Fond d'écran sombre
          - obj:
              id: background
              width: 1280
              height: 720
              x: 0
              y: 0
              #bg_color: color_black
              bg_opa: TRANSP
              border_width: 0
              radius: 0 

          #- obj:
              #id: wallpaper
              #width: 1280
              #height: 720
              #align: CENTER  # Centre automatiquement l'objet
              #bg_opa: COVER  # Couvre tout l'objet avec l'image
              #border_width: 0
              #radius: 0              

          - image:
              id: update_wallpaper
              src: peaceful
              width: 1280
              height: 720
              #x: 0
              #y: 0     


          #- image:
              #id: update_wallpaper4
              #src: alertBlack
              #width: 271
              #height: 118
              #x: 450
              #y: 64
              #bg_color: 0x1a1a2e  

          - label:
              text: "HOME CONTROL"
              x: 20
              y: 15
              text_color: 0xFFFFFF
              text_font: roboto_42
              text_align: LEFT

          - label:
              id: date_label
              text: "Tuesday, Apr 23"
              x: 826
              y: 15
              text_align: CENTER
              text_color: 0xFFFFFF
              text_font: roboto_32
          - label:
              id: time_label
              text: "12:34"
              x: 1115
              y: 15
              text_align: CENTER
              text_color: 0xFFFFFF
              text_font: roboto_32  

          - label:
              id: ha_status
              #align: CENTER
              x: 1220
              y: 15
              text: "${ha}"
              text_color: color_blue
              text_font: icons_36  

          # Alarm panel status
          #- label:
              #id: alarm_panel_status
              
              #x: 1075
              #y: 15
              #text: "${shield_arming_icon}"
              #text_color: color_steel_blue
              #text_font: mdi_icons_40            

          # 3 GROS BOUTONS AU-DESSUS DE SECURITY CAMERAS
          # Bouton Settings
          - button:
              id: btn_settings
              width: 200
              height: 60
              x: 10
              y: 470
              bg_color: color_orange
              bg_opa: COVER
              radius: 15
              widgets:
                - label:
                    text: "SETTINGS"
                    x: 55
                    y: 10
                    text_color: 0xFFFFFF
                    text_font: roboto_24
                    text_align: left
                - label:
                    text: "${setting}"
                    text_align: left
                    text_color: color_yellow
                    text_font: mdi46

              #on_click:
                #- homeassistant.service:
                    #service: script.open_settings
              on_click:      
                then:
                    - lvgl.page.show: settings_page 
                    - lambda: |-
                        ESP_LOGI("PERF", "=== PAGE SWITCH START: %u ms ===", millis());
                        ESP_LOGI("PERF", "Free heap: %u bytes", esp_get_free_heap_size()); 
                    - lambda: |-
                        ESP_LOGI("PERF", "=== PAGE SWITCH END: %u ms ===", millis());
                        ESP_LOGI("PERF", "Free heap after: %u bytes", esp_get_free_heap_size());                    
                    


          - button:
              id: btn_Diap
              width: 200
              height: 60
              x: 10
              y: 555
              bg_color: color_steel_blue
              bg_opa: COVER
              radius: 15
              on_click:
                then:
                  #- lvgl.page.show: Diap_page


              widgets:
                - label:
                    text: "Diap"
                    x: 55
                    y: 10
                    text_color: 0xFFFFFF
                    text_font: roboto_24
                    text_align: left
                - label:
                    text: "\U000F07AE"
                    text_align: left
                    text_color: color_yellow
                    text_font: mdi46      

                      
          # Bouton Alarm
          - button:
              id: btn_alarm
              width: 200
              height: 60
              x: 10
              y: 647
              styles: button_menu
              #bg_color: color_steel_blue
              bg_opa: COVER
              radius: 15
              widgets:
                - label:
                    text: "ALARM"
                    x: 55
                    y: 10
                    text_color: 0xFFFFFF
                    text_font: roboto_24
                    text_align: left

                - label:
                    text: "${alarm}"
                    text_align: left
                    text_color: color_yellow
                    text_font: mdi46                         
              #on_click:
                #- homeassistant.service:
                    #service: alarm_control_panel.alarm_arm_home
                    #data:
                      #"entity_id: alarm_control_panel.home_alarm
              on_press:      
                then:
                    #- lvgl.page.show: camera_alarm_page
                    - lvgl.page.show: alarm_panel_page 
                    - lambda: |-
                        ESP_LOGI("PERF", "=== PAGE SWITCH START: %u ms ===", millis());
                        ESP_LOGI("PERF", "Free heap: %u bytes", esp_get_free_heap_size()); 
                    - lambda: |-
                        ESP_LOGI("PERF", "=== PAGE SWITCH END: %u ms ===", millis());
                        ESP_LOGI("PERF", "Free heap after: %u bytes", esp_get_free_heap_size());                       

          #- label:
              #text: "SECURITY CAMERAS"
              #x: 350
              #y: 520
              #text_color: 0xCCCCCC
              #text_font: roboto_30
              #text_align: LEFT
          - button:
              id: btn_light
              width: 200
              height: 60
              x: 10
              y: 310
              bg_color: color_orange
              bg_opa: COVER
              radius: 15
              widgets:
                - label:
                    text: "SDIMAGE"
                    x: 55
                    y: 10
                    text_color: 0xFFFFFF
                    text_font: roboto_24
                    text_align: left
                - label:
                    text: "\U000F02E9" #"\U000F18DD"
                    text_align: left
                    text_color: color_deep_purple
                    text_font: mdi46
              #on_click:
                   #then:
                      #- lvgl.image.update:
                          #id: update_wallpaper
                          #src: testree  

              #on_click:
                #then:
                  #- lambda: |-
                      #id(current_image_index) = (id(current_image_index) + 1) % 11;
                  
                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 0;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: sanctuary
                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 1;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: Zephyrus   

                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 2;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: genshin_impact

                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 3;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: irise   

                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 4;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: holohub
                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 5;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: peaceful
                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 6;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: exploration                                                                                                                                                                       
                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 7;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: cheon1 

                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 8;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: abstrac1  
               

              #on_click: 
                    #then:
                      #- lvgl.page.show: alarm_panel_page
                      #- lvgl.page.show: camera_alarm_page
                      


              #on_click:
                #- homeassistant.service:
                    #service: script.open_settings
              #on_click:      
                #then:
                    #- lvgl.page.show: devices_page 
                    #- lvgl.page.show: camera_page                  
                    
          # Bouton Volets
          #- button:
              #id: btn_temp
              #width: 200
              #height: 60
              #x: 615
              #y: 555
              #bg_color: color_steel_blue
              #bg_opa: COVER
              #radius: 15
              #widgets:
                #- label:
                    #text: "CLIMATE"
                    #x: 55
                    #y: 10
                    #text_color: 0xFFFFFF
                    #text_font: roboto_24
                    #text_align: left

                #- label:
                    #text: "\U000F050F"
                    #text_align: left
                    #text_color: color_yellow
                    #text_font: mdi46        
              #on_click:
                #- homeassistant.service:
                    #service: cover.toggle
                    #data:
                      #entity_id: cover.all_shutters
                      
          # Bouton Alarm
          - button:
              id: btn_player
              width: 200
              height: 60
              x: 10
              y: 385
              #styles: button_menu
              bg_color: color_steel_blue
              bg_opa: COVER
              radius: 15
              widgets:
                - label:
                    text: "MEDIA"
                    x: 55
                    y: 10
                    text_color: 0xFFFFFF
                    text_font: roboto_24
                    text_align: left

                - label:
                    text: "\U000F0CB8"
                    text_align: left
                    text_color: color_yellow
                    text_font: mdi46                         
              #on_click:
                #- homeassistant.service:
                    #service: alarm_control_panel.alarm_arm_home
                    #data:
                      #"entity_id: alarm_control_panel.home_alarm
              on_press:      
                then:
                    - lvgl.page.show: video_page #media_player_page 
                    - lambda: |-
                        ESP_LOGI("PERF", "=== PAGE SWITCH START: %u ms ===", millis());
                        ESP_LOGI("PERF", "Free heap: %u bytes", esp_get_free_heap_size()); 
                    - lambda: |-
                        ESP_LOGI("PERF", "=== PAGE SWITCH END: %u ms ===", millis());
                        ESP_LOGI("PERF", "Free heap after: %u bytes", esp_get_free_heap_size());                        


          - button:
              id: btn_camera
              width: 200
              height: 60
              x: 230  # Ajustez la position selon vos besoins
              y: 647  # Position verticale libre
              bg_color: color_deep_purple
              bg_opa: COVER
              radius: 15
              widgets:
                - label:
                    text: "CAMERA"
                    x: 55
                    y: 10
                    text_color: 0xFFFFFF
                    text_font: roboto_24
                    text_align: left
                - label:
                    text: "\U000F07AE"  # Icône caméra
                    text_align: left
                    text_color: color_yellow
                    text_font: mdi46
              on_click:      
                then:
                    - lvgl.page.show: camera_page 
                    #- lambda: |-
                        #ESP_LOGI("PERF", "=== PAGE SWITCH CAMERA START: %u ms ===", millis());
                        #ESP_LOGI("PERF", "Free heap: %u bytes", esp_get_free_heap_size()); 
                    #- lambda: |-
                        #ESP_LOGI("PERF", "=== PAGE SWITCH CAMERA END: %u ms ===", millis());
                        #ESP_LOGI("PERF", "Free heap after: %u bytes", esp_get_free_heap_size());



          # COLONNE DE GAUCHE
          # Section Living Room
          - obj:
              id: living_room
              width: 315
              height: 200
              x: 10
              y: 80
              bg_color: color_steel_blue  #0x2d2d2d
              bg_opa: COVER
              radius: 15
              widgets:
                - label:
                    text: "outside temp"
                    x: 35
                    y: 2 #20
                    text_color: 0xCCCCCC
                    text_font: roboto_32
                - label:
                    id: weather_temperature_page
                    text: "21.5°"
                    x: 20
                    y: 55
                    text_color: 0xFFAA00
                    text_font: roboto_60
                - label:
                    id: weather_humidity_page
                    text: "67"
                    x: 170
                    y: 70
                    text_color: 0xFFFFFF
                    text_font: roboto_30
                - label:
                    text: "${humidity}"
                    text_font: icons_36
                    x: 125
                    y: 60
                    text_color: 0x00AAAA
                    #text_font: roboto_12
                - label:
                    text: "GOOD AIR QUALITY"
                    x: 20
                    y: 140
                    text_color: 0x00AA00
                    text_font: roboto_20

          # Boutons de contrôle (sous Living Room)


          #- obj:
              #id: house_plan
              #width: 610
              #height: 500
              #x: 350
              #y: 100
              #bg_color: 0x2d2d2d
              #bg_opa: COVER
              #radius: 15
              #widgets:
                #- image:
                    #src: Sample

        

                    
                    



          # Section IN-AND-OUT (agrandie et centrée)
          - obj:
              id: in_out_section
              width: 350
              height: 318
              x: 930
              y: 400
              bg_color: color_steel_blue #0x444444
              bg_opa: COVER
              radius: 15
              widgets:
                - label:
                    text: "IN-AND-OUT"
                    x: 70
                    y: 2
                    text_color: 0xCCCCCC
                    text_font: roboto_32
                    text_align: LEFT
                - label:
                    text: "Front Door"
                    x: 20 #15
                    y: 60
                    text_color: 0xFFFFFF
                    text_font: roboto_20
                    text_align: LEFT

                - label:
                    text: "${door}"
                    x: 260
                    y: 50
                    text_color: color_amber
                    text_font: mdi46
                    text_align: LEFT

                - label:
                    text: "Garage"
                    x: 20
                    y: 110
                    text_color: 0xFFFFFF
                    text_font: roboto_20
                    text_align: LEFT

                - label:
                    text: "${garage}"
                    x: 260
                    y: 100
                    text_color: 0xFFFFFF
                    text_font: mdi46
                    text_align: LEFT  


                # Alarm panel status
                - label:
                    text: "ALARM"
                    x: 20
                    y: 164
                    #text: "${shield_arming_icon}"
                    text_color: 0xFFFFFF
                    text_font: roboto_20
                    text_align: LEFT                           

                # Alarm panel status
                - label:
                    id: alarm_panel_status
                    x: 265
                    y: 155
                    text: "${shield_arming_icon}"
                    text_color: color_blue
                    text_font: mdi_icons_40                                               
                    text_align: LEFT


# Section SYSTEM INFO (remplace ENERGY USAGE)
          - obj:
              id: system_info_section
              width: 350
              height: 280
              x: 930
              y: 80
              bg_color: 0x444444
              bg_opa: COVER
              radius: 15
              widgets:

                - obj:
                    id: system_info_container
                    x: 0
                    y: 0
                    width: 320
                    height: 250
                    align: TOP_LEFT
                    pad_all: 0
                    bg_color: 0x444444
                    bg_opa: 20%
                    border_opa: TRANSP
                    radius: 10
                    widgets:
                      # SRAM memory (show used from total)
                      - obj:
                          y: 10
                          width: 300
                          height: 50
                          align: TOP_MID
                          bg_opa: TRANSP
                          pad_all: 0
                          border_opa: TRANSP
                          widgets:
                            - label:
                                align: TOP_LEFT
                                text: "SRAM Used:"
                                text_font: roboto_20
                                text_color: color_white
                            - label:
                                id: sram_memory_label
                                align: TOP_RIGHT
                                text: "0/512 KB"
                                text_font: roboto_20
                                text_color: color_green
                            - bar:
                                id: sram_memory_bar
                                y: 30
                                width: 290
                                height: 12
                                align: TOP_MID
                                pad_all: 0
                                min_value: 0
                                max_value: 100
                                value: 0
                                bg_color: color_gray
                                bg_opa: 50%
                                indicator: 
                                  bg_color: color_green

                      # PSRAM memory (show used from total)
                      - obj:
                          y: 70
                          width: 300
                          height: 50
                          align: TOP_MID
                          bg_opa: TRANSP
                          pad_all: 0
                          border_opa: TRANSP
                          widgets:
                            - label:
                                align: TOP_LEFT
                                text: "PSRAM Used:"
                                text_font: roboto_20
                                text_color: color_white
                            - label:
                                id: psram_memory_label
                                align: TOP_RIGHT
                                text: "0/8 MB"
                                text_font: roboto_20
                                text_color: color_blue
                            - bar:
                                id: psram_memory_bar
                                y: 30
                                width: 290
                                height: 12
                                align: TOP_MID
                                pad_all: 0
                                min_value: 0
                                max_value: 100
                                value: 0
                                bg_color: color_gray
                                bg_opa: 50%
                                indicator:
                                  bg_color: color_blue

                      # Chip temperature
                      - obj:
                          y: 130
                          width: 300
                          height: 30
                          align: TOP_MID
                          pad_all: 0
                          bg_opa: TRANSP
                          border_opa: TRANSP
                          widgets:
                            - label:
                                align: LEFT_MID
                                text: "CPU Temperature:"
                                text_font: roboto_20
                                text_color: color_white
                            - label:
                                id: chip_temperature_label
                                align: RIGHT_MID
                                text: "0°C"
                                text_font: roboto_20
                                text_color: color_yellow

                      # WiFi signal
                      - obj:
                          y: 170
                          width: 300
                          height: 30
                          align: TOP_MID
                          pad_all: 0
                          bg_opa: TRANSP
                          border_opa: TRANSP
                          widgets:
                            - label:
                                align: LEFT_MID
                                text: "WiFi Signal:"
                                text_font: roboto_20
                                text_color: color_white
                            - label:
                                id: wifi_signal_label
                                align: RIGHT_MID
                                text: "0 dBm"
                                text_font: roboto_20
                                text_color: color_white

                      # IP Address
                      - obj:
                          y: 210
                          width: 300
                          height: 30
                          align: TOP_MID
                          pad_all: 0
                          bg_opa: TRANSP
                          border_opa: TRANSP
                          widgets:
                            - label:
                                align: LEFT_MID
                                text: "IP Address:"
                                text_font: roboto_20
                                text_color: color_white
                            - label:
                                id: ip_address_label
                                align: RIGHT_MID
                                text: "192.168.3.3"
                                text_font: roboto_20
                                text_color: color_white


# ========== PAGE CAMERA ==========
      - id: camera_page
        bg_color: color_slate_blue_gray # Fond noir comme sur la photo
        on_load:
          - lambda: |-
              ESP_LOGI("camera", "Camera page loaded");
              static bool canvas_configured = false;
              if (!canvas_configured) {
                auto canvas = id(camera_canvas);
                if (canvas != nullptr) {
                  id(camera_display).configure_canvas(canvas);
                  canvas_configured = true;
                  ESP_LOGI("lvgl", "✓ Canvas configured");
                }
              }

        widgets:
          # ===== CANVAS CAMERA (résolution native sans bordure) =====
          - canvas:
              id: camera_canvas
              width: 640 #480 1280x720
              height: 480  #390  # Résolution native de la caméra
              x: 0       
              y: 0         # En haut
              bg_color: 0x4682B4
              border_width: 0
              radius: 0
              pad_all: 0


          # ===== BOUTONS DIRECTEMENT SUR LA PAGE =====
          
          # Bouton START (vert)
          - button:
              id: btn_start_streaming
              width: 120
              height: 80
              x: 1120
              y: 150
              bg_color: 0x00CC44
              bg_opa: COVER
              radius: 10
              on_click:
       
                  - switch.turn_on: lvgl_display_enable_switch
                  - lambda: |-
                      ESP_LOGI("camera", "▶ Démarrage streaming");
                      if (id(tab5_cam).start_streaming()) {
                        ESP_LOGI("camera", "✓ Streaming démarré");
                        lv_obj_set_style_bg_color(id(camera_canvas), lv_color_hex(0x000000), 0);
                      } else {
                        ESP_LOGE("camera", "✗ Échec streaming");
                      }
              widgets:
                - label:
                    text: "START"
                    text_color: 0xFFFFFF
                    text_font: nunito_24
                    text_align: CENTER
                    align: CENTER

          # Bouton STOP (rouge)
          - button:
              id: btn_stop_streaming
              width: 120
              height: 80
              x: 1120
              y: 270
              bg_color: 0xFF4444
              bg_opa: COVER
              radius: 10
              on_click:
                then:
                  - lambda: |-
                      ESP_LOGI("camera", "■ Arrêt streaming");
                      id(tab5_cam).stop_streaming();
                      lv_obj_set_style_bg_color(id(camera_canvas), lv_color_hex(0x4682B4), 0);
              widgets:
                - label:
                    text: "STOP"
                    text_color: 0xFFFFFF
                    text_font: nunito_24
                    text_align: CENTER
                    align: CENTER


          # Bouton BACK (rouge)
          - button:
              id: btn_camera_back
              width: 120
              height: 80
              x: 1120
              y: 400
              bg_color: 0xFF4444
              bg_opa: COVER
              radius: 10
              on_click:
                then:
                  - switch.turn_off: lvgl_display_enable_switch
                  - lambda: |-
                      ESP_LOGI("camera", "Retour accueil");
                      id(tab5_cam).stop_streaming();
                  - lvgl.page.show: page_home
              widgets:
                - label:
                    text: "BACK"
                    text_color: 0xFFFFFF
                    text_font: nunito_24
                    text_align: CENTER
                    align: CENTER         

        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms 
   
###########################################################################################################################################################################################

      - id: settings_page
        bg_color: color_black #color_slate_blue_gray
        on_load:
          then:
            - lvgl.image.update:
                id: update_wallpaper1
                src: exploration
        widgets:
          - image:
              id: update_wallpaper1
              src: exploration
              width: 1280
              height: 720
              #x: 0
              #y: 0 
          # sleep mode:
        # backlight:
          - obj:
              id: backlight_bg
              x: 20
              y: 120
              width: 490
              height: 110
              align: TOP_LEFT
              pad_all: 0
              bg_color: color_blue
              bg_opa: 20%
              border_opa: TRANSP
              border_width: 0
              shadow_opa: TRANSP
              radius: 10
              widgets:

                - label:
                    id: display_backlight_label
                    x: 20
                    align: LEFT_MID
                    text_font: roboto_32
                    text_color: color_blue
                    text: "Backlight"

                - slider:
                    id: display_backlight_brightness_slider
                    x: -25
                    radius: 10
                    bg_color: color_gray
                    align: RIGHT_MID
                    width: 260
                    height: 60
                    min_value: 35
                    max_value: 100
                    value: 100
                    indicator:
                      bg_color: color_deep_orange
                      radius: 10
                    knob:
                      bg_opa: TRANSP
                    on_release:
                      then:
                        - light.turn_on:
                            id: backlight
                            brightness: !lambda return int(x)/ 100.0;


          - obj:
              id: slideshow_bg
              x: 20
              y: 290
              width: 490
              height: 120
              align: TOP_LEFT
              pad_all: 10
              bg_color: color_blue
              bg_opa: 20%
              border_opa: TRANSP
              border_width: 0
              shadow_opa: TRANSP
              radius: 10
              widgets:
                - label:
                    id: display_slideshow_label
                    x: 10
                    align: LEFT_MID
                    text_font: roboto_32
                    text_color: color_blue
                    text: "Slideshow"


                # Bouton moins (-)
                - obj:
                    id: minus_button_slideshow
                    x: 200
                    align: LEFT_MID
                    width: 90
                    height: 90
                    pad_all: 0
                    bg_opa: transp
                    border_opa: transp
                    shadow_opa: TRANSP
                    widgets:
                      - obj:
                          width: 70
                          height: 70
                          align: center
                          clickable: true
                          radius: 50
                          pad_all: 0
                          bg_opa: transp
                          border_opa: transp
                          border_width: 0
                          shadow_width: 8
                          shadow_spread: 2
                          shadow_color: color_black
                          pressed:
                            bg_color: 0x3A3A4C
                            shadow_width: 5
                          on_press:
                            - number.set:
                                id: slideshow_interval
                                value: !lambda |-
                                  float current = id(slideshow_interval).state;
                                  if (current > 1) return current - 1;
                                  return current;
                          widgets:
                            - obj:
                                width: 60
                                height: 60
                                align: center
                                clickable: false
                                radius: 45
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                shadow_width: 4
                                shadow_color: 0xFFFFFF
                                shadow_ofs_x: -4
                                shadow_ofs_y: -2
                                shadow_opa: 30%
                            - obj:
                                width: 65
                                height: 65
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 50
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: minus_label_slideshow
                                      y: -2
                                      align: CENTER
                                      text_font: roboto_32
                                      text_color: color_misty_blue
                                      text: "-"

                # Label affichage valeur actuelle
                - label:
                    id: current_slideshow_value
                    x: 285
                    align: LEFT_MID
                    width: 80
                    text_font: roboto_32
                    text_color: color_white
                    text_align: CENTER
                    text: !lambda |-
                      int val = id(slideshow_interval).state;
                      return (std::to_string(val) + "s").c_str();

                # Bouton plus (+)
                - obj:
                    id: plus_button_slideshow
                    x: 370
                    align: LEFT_MID
                    width: 90
                    height: 90
                    pad_all: 0
                    bg_opa: transp
                    border_opa: transp
                    border_width: 0
                    shadow_opa: TRANSP
                    widgets:
                      - obj:
                          width: 70
                          height: 70
                          align: center
                          clickable: true
                          radius: 50
                          pad_all: 0
                          bg_opa: transp
                          border_opa: transp
                          border_width: 0
                          shadow_width: 8
                          shadow_spread: 2
                          shadow_color: color_black
                          pressed:
                            bg_color: 0x3A3A4C
                            shadow_width: 5
                          on_press:
                            - number.set:
                                id: slideshow_interval
                                value: !lambda |-
                                  float current = id(slideshow_interval).state;
                                  if (current < 30) return current + 1;
                                  return current;
                          widgets:
                            - obj:
                                width: 60
                                height: 60
                                align: center
                                clickable: false
                                radius: 45
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                shadow_width: 4
                                shadow_color: 0xFFFFFF
                                shadow_ofs_x: -4
                                shadow_ofs_y: -2
                                shadow_opa: 30%
                            - obj:
                                width: 65
                                height: 65
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 50
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: plus_label_slideshow
                                      y: -2
                                      align: center
                                      text_font: roboto_32
                                      text_color: color_misty_blue
                                      text: "+"


          - obj:
              id: sleep_mode_bg
              x: 20
              y: 450 #280
              width: 490
              height: 120
              align: TOP_LEFT
              pad_all: 10
              bg_color: color_blue
              bg_opa: 20%
              border_opa: TRANSP
              border_width: 0
              shadow_opa: TRANSP
              radius: 10
              widgets:
                - label:
                    id: display_timeout_label
                    x: 10
                    align: LEFT_MID
                    text_font: roboto_32
                    text_color: color_blue
                    text: "Sleep mode"
                
                # Bouton moins (-) avec effet multicouche
                - obj:
                    id: minus_button_main
                    x: 200
                    align: LEFT_MID
                    width: 90
                    height: 90
                    pad_all: 0
                    #clickable: true
                    #radius: 35  # Corrigé: 69/2 = 34.5 ≈ 35
                    bg_opa: transp
                    border_opa: transp
                    shadow_opa: TRANSP
                    widgets:
                      - obj:
                          width: 70
                          height: 70
                          align: center
                          clickable: true
                          radius: 50
                          pad_all: 0
                          bg_opa: transp
                          border_opa: transp
                          border_width: 0
                          shadow_width: 8
                          shadow_spread: 2
                          shadow_color: color_black

                    #border_width: 0
                    #shadow_width: 22
                    #shadow_spread: 2
                          #shadow_color: color_black
                          #shadow_opa: TRANSP
                          pressed:
                            bg_color: 0x3A3A4C
                            shadow_width: 5
                          on_press:
                            #- lvgl.obj.update:
                                #id: minus_button_main
                                #shadow_color: color_sky_blue
                            #- lvgl.label.update:
                                #id: minus_label
                                #text_color: color_sky_blue
                            - number.set:
                                id: auto_off
                                value: !lambda |-
                                  float current = id(auto_off).state;
                                  if (current > -1) return current - 1;
                                  return current;
                         # on_release:
                            #- lvgl.obj.update:
                                #id: minus_button_main
                                #shadow_color: 0x000000
                            #- lvgl.label.update:
                                #id: minus_label
                                #text_color: color_misty_blue
                          widgets:
                            - obj:
                                width: 60
                                height: 60
                                align: center
                                clickable: false
                                radius: 45
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 4
                                shadow_color: 0xFFFFFF
                                shadow_ofs_x: -4
                                shadow_ofs_y: -2
                                shadow_opa: 30%

                            - obj:
                                width: 65
                                height: 65
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 50
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: minus_label
                                      y: -2
                                      align: CENTER
                                      text_font: roboto_32
                                      text_color: color_misty_blue
                                      text: "-"
                      # Ombre claire (highlight)
                      #- obj:
                          #id: minus_shadow1
                          #width: 75
                          #height: 75
                          #align: CENTER
                          #x: -2
                          #y: -2
                          #clickable: false
                          #radius: 33  # 67/2 = 33.5 arrondi à 33
                          #bg_opa: transp 
                          #border_opa: transp
                          #shadow_width: 4
                          #shadow_color: 0xFFFFFF
                          #shadow_ofs_x: -2
                          #shadow_ofs_y: -2
                          #shadow_opa: 30%
                      # Ombre foncée (profondeur)
                      #- obj:
                          #id: minus_shadow2
                          #width: 75
                          #height: 75
                          #align: CENTER
                          #x: 2
                          #y: 2
                          #clickable: false
                          #radius: 33  # 67/2 = 33.5 arrondi à 33
                          #bg_opa: transp 
                          #border_opa: transp
                          #shadow_width: 8
                          #shadow_color: 0x000000
                          #shadow_ofs_x: 2
                          #shadow_ofs_y: 2
                          #shadow_opa: 50%
                      # Bouton principal interne
                      #- obj:
                          #id: minus_inner
                          #width: 67
                          #height: 67
                          #align: CENTER  # Corrigé: parfaitement centré
                          #clickable: false
                          #radius: 32  # Corrigé: 65/2 = 32.5 arrondi à 32
                          #border_opa: transp
                          #bg_color: color_slate_blue_gray
                          #widgets:
                            #- label:
                                #id: minus_label
                                #align: CENTER  # Déjà correct
                                #text_color: color_misty_blue
                                #text_font: roboto_32
                                #text: "-"
                
                # Affichage valeur actuelle
                - label:
                    id: current_timeout_value
                    x: 285
                    align: LEFT_MID
                    width: 80
                    text_font: roboto_32
                    text_color: color_white
                    text_align: CENTER
                    text: !lambda |-
                      int timeout = id(auto_off).state;
                      if (timeout == -1) return "OFF";
                      return (std::to_string(timeout) + "s").c_str();
                
                # Bouton plus (+) avec effet multicouche
                - obj:
                    id: plus_button_main
                    x: 370
                    align: LEFT_MID
                    width: 90
                    height: 90
                    pad_all: 0
                    #clickable: true
                    #radius: 35  # Corrigé: 69/2 = 34.5 ≈ 35
                    bg_opa: transp
                    border_opa: transp
                    border_width: 0
                    #shadow_width: 22
                    #shadow_spread: 2
                    #shadow_color: 0x000000
                    shadow_opa: TRANSP
                    widgets:
                      - obj:
                          width: 70
                          height: 70
                          align: center
                          clickable: true
                          radius: 50
                          pad_all: 0
                          bg_opa: transp
                          border_opa: transp
                          border_width: 0
                          shadow_width: 8
                          shadow_spread: 2
                          shadow_color: color_black
                          pressed:
                            bg_color: 0x3A3A4C
                            shadow_width: 5
                          on_press:
                            #- lvgl.obj.update:
                                #id: plus_button_main
                                #shadow_color: color_sky_blue
                            #- lvgl.label.update:
                                #id: plus_label
                                #text_color: color_sky_blue
                            - number.set:
                                id: auto_off
                                value: !lambda |-
                                  float current = id(auto_off).state;
                                  if (current < 600) return current + 1;
                                  return current;

                          widgets:                
                            - obj:
                                width: 60
                                height: 60
                                align: center
                                clickable: false
                                radius: 45
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 4
                                shadow_color: 0xFFFFFF
                                shadow_ofs_x: -4
                                shadow_ofs_y: -2
                                shadow_opa: 30%

                            - obj:
                                width: 65
                                height: 65
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 50
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: plus_label
                                      y: -2
                                      align: center
                                      text_font: roboto_32
                                      text_color: color_misty_blue
                                      text: "+"

                            #on_release:
                              #- lvgl.obj.update:
                                  #id: plus_button_main
                                  #shadow_color: 0x000000
                              #- lvgl.label.update:
                                  #id: plus_label
                                  #text_color: color_misty_blue
                            #widgets:
                              # Ombre claire (highlight)
                              #- obj:
                                  #id: plus_shadow1
                                  #width: 67
                                  #height: 67
                                  #align: CENTER
                                  #x: -2
                                  #y: -2
                                  #clickable: false
                                  #radius: 33  # 67/2 = 33.5 arrondi à 33
                                  #bg_opa: transp 
                                  #border_opa: transp
                                  #shadow_width: 4
                                  #shadow_color: 0xFFFFFF
                                  #shadow_ofs_x: -2
                                  #shadow_ofs_y: -2
                                  #shadow_opa: 30%
                              # Ombre foncée (profondeur)
                              #- obj:
                                  #id: plus_shadow2
                                  #width: 67
                                  #height: 67
                                  #align: CENTER
                                  #x: 2
                                  #y: 2
                                  #clickable: false
                                  #radius: 33  # 67/2 = 33.5 arrondi à 33
                                  #bg_opa: transp 
                                  #border_opa: transp
                                  #shadow_width: 8
                                  #shadow_color: 0x000000
                                  #shadow_ofs_x: 2
                                  #shadow_ofs_y: 2
                                  #shadow_opa: 50%
                              # Bouton principal interne
                              #- obj:
                                  #id: plus_inner
                                  #width: 67
                                  #height: 67
                                  #align: CENTER  # Corrigé: parfaitement centré
                                  #clickable: false
                                  #radius: 32  # Corrigé: 65/2 = 32.5 arrondi à 32
                                  #border_opa: transp
                                  #bg_color: color_slate_blue_gray
                                  #widgets:
                                    #- label:
                                        #id: plus_label
                                        #align: CENTER  # Déjà correct
                                        #text_color: color_misty_blue
                                        #text_font: roboto_32
                                        
                                        #text: "+"


        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms 


              
########################################################################################################################################################################################################
      - id: video_page
        bg_color: color_slate_blue_gray
        #widgets:
          ## Image de la caméra en plein écran
          #- image:
              #id: cctv_img_lvgl
              #align: CENTER
              #src: cctv_img
              #width: 320
              #height: 240
              #pad_all: 0
              #border_width: 0

          #- button:
              #align: TOP_RIGHT
              #x: 0
              #y: 120
              #width: 50
              #height: 50
              #radius: 25
              #bg_color: 0x000000
              #bg_opa: 100%
              #border_width: 2
              #border_color: color_white
              #id: refresh_camera_btn
              #on_click:
                #then:
                  #- online_image.set_url:
                      #id: cctv_img
                      #url: "${frigate}"  # Ou votre URL d'image
              #widgets:
                #- label:
                    #align: CENTER
                    #text: "\U000F0450"  # Icône rafraîchir
                    #text_font: mdi_media
                    #text_color: color_white



        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms 
#######################################################################################################################################################################################

#########################################################################################################################################################################
      - id: listening_page
        bg_color: color_black
        widgets:
          #- script.execute: update_cover_script
          - image:
              align: CENTER
              src: casita_listening
            

         

        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 100ms 
########################################################################################################################################################################################


###############################################################################################################################################################################################

      - id: alarm_panel_page
        bg_color: color_black
        on_load:
          then:
            - lambda: |-
                auto canvas = id(cctv_canvas);
                if (canvas != nullptr) {
                  id(security_cam_1).configure_canvas(canvas);
                }
            - lvgl.image.update:
                id: update_wallpaper3
                src: sanctuary
        
        widgets:
          - image:
              id: update_wallpaper3
              src: sanctuary

          - obj:
              id: alarm_main_view
              x: 0
              y: 0
              width: 1000
              height: 700
              align: TOP_LEFT
              bg_opa: transp
              border_opa: transp
              widgets:
                # Zone de l'alarme à gauche
                - obj:
                    id: alarm_panel_state_bg
                    x: 30
                    y: 30
                    width: 658
                    height: 120
                    pad_all: 0
                    align: TOP_LEFT
                    bg_color: color_steel_blue
                    bg_opa: 20%
                    border_opa: TRANSP
                    border_width: 0
                    shadow_opa: TRANSP
                    radius: 15
                    widgets:
                      - obj:
                          id: alarm_panel_state_icon_bg
                          x: 30
                          align: LEFT_MID
                          width: 90
                          height: 90
                          radius: 45
                          pad_all: 0
                          bg_color: color_blue
                          bg_opa: 60%
                          shadow_opa: transp
                          border_opa: transp
                          border_width: 0

                      - label:
                          id: alarm_panel_state_icon
                          x: 55
                          align: LEFT_MID
                          text_font: mdi_icons_40
                          text_color: color_green
                          text: "${shield_disarm_icon}"

                      - label:
                          x: 164
                          id: alarm_panel_state_text
                          align: LEFT_MID
                          text_font: nunito_26
                          text_color: color_misty_blue
                          text: " "
                
                - obj:
                    id: alarm_panel_state_control
                    hidden: false
                    x: 30
                    y: 179
                    width: 658
                    height: 389
                    align: TOP_LEFT
                    bg_color: color_steel_blue
                    bg_opa: 20%
                    border_opa: TRANSP
                    shadow_opa: TRANSP
                    radius: 15
                    widgets:
                      # Bouton DISARMED (centre)
                      - obj:
                          id: alarm_panel_button_disarmed
                          width: 299
                          height: 299
                          align: center
                          pad_all: 0
                          bg_opa: transp
                          shadow_opa: transp
                          border_opa: transp
                          widgets:
                            - obj:
                                width: 239
                                height: 239
                                align: center
                                clickable: true
                                radius: 120
                                bg_opa: transp
                                border_opa: transp
                                border_width: 0
                                shadow_width: 38
                                shadow_spread: 6
                                shadow_color: color_black
                                pressed:
                                  bg_color: 0x3A3A4C
                                  shadow_width: 10
                                on_press:
                                  - lambda: |-
                                      id(alarm_panel_pending_action) = std::string("disarm");
                                  - lvgl.widget.show: alarm_panel_keypad_page
                                  - lvgl.widget.hide: alarm_panel_state_bg
                                  - lvgl.widget.hide: alarm_panel_state_control
                            - obj:
                                width: 228
                                height: 228
                                align: center
                                clickable: false
                                radius: 120
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 12
                                shadow_color: 0xFFFFFF
                                shadow_ofs_x: -9
                                shadow_ofs_y: -5
                                shadow_opa: 30%

                            - obj:
                                width: 228
                                height: 228
                                align: center
                                clickable: false
                                radius: 120
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 12
                                shadow_color: 0x000000
                                shadow_ofs_x: 9
                                shadow_ofs_y: 5

                            - obj:
                                width: 233
                                height: 233
                                align: center
                                clickable: false
                                radius: 120
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: alarm_panel_state_btn_disarmed
                                      align: center
                                      text_font: mdi_icons_68
                                      text_color: color_steel_blue
                                      text: "${shield_disarm_icon}"

                      # Bouton HOME (haut gauche)
                      - obj:
                          id: alarm_panel_button_home
                          hidden: true
                          width: 164
                          height: 164
                          x: -90
                          y: -90
                          align: center
                          pad_all: 0
                          bg_opa: transp
                          shadow_opa: transp
                          border_opa: transp
                          widgets:
                            - obj:
                                width: 135
                                height: 135
                                align: center
                                clickable: true
                                radius: 75
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                border_width: 0
                                shadow_width: 23
                                shadow_spread: 3
                                shadow_color: color_black
                                pressed:
                                  bg_color: 0x3A3A4C
                                  shadow_width: 8
                                on_press:
                                  - lambda: |-
                                      id(alarm_panel_pending_action) = std::string("arm_home");
                                  - lvgl.widget.show: alarm_panel_keypad_page
                                  - lvgl.widget.hide: alarm_panel_state_bg
                                  - lvgl.widget.hide: alarm_panel_state_control
                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0xFFFFFF
                                shadow_ofs_x: -6
                                shadow_ofs_y: -3
                                shadow_opa: 30%

                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0x000000
                                shadow_ofs_x: 6
                                shadow_ofs_y: 3

                            - obj:
                                width: 128
                                height: 128
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 75
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: alarm_panel_state_btn_home
                                      align: center
                                      text_font: mdi_icons_52
                                      text_color: color_steel_blue
                                      text: "${shield_home_icon}"

                      # Bouton AWAY (haut droit)
                      - obj:
                          id: alarm_panel_button_away
                          hidden: true
                          width: 164
                          height: 164
                          x: 90
                          y: -90
                          align: center
                          pad_all: 0
                          bg_opa: transp
                          shadow_opa: transp
                          border_opa: transp
                          widgets:
                            - obj:
                                width: 135
                                height: 135
                                align: center
                                clickable: true
                                radius: 75
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                border_width: 0
                                shadow_width: 23
                                shadow_spread: 3
                                shadow_color: color_black
                                pressed:
                                  bg_color: 0x3A3A4C
                                  shadow_width: 8
                                on_press:
                                  - lambda: |-
                                      id(alarm_panel_pending_action) = std::string("arm_away");
                                  - lvgl.widget.show: alarm_panel_keypad_page
                                  - lvgl.widget.hide: alarm_panel_state_bg
                                  - lvgl.widget.hide: alarm_panel_state_control
                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0xFFFFFF
                                shadow_ofs_x: -6
                                shadow_ofs_y: -3
                                shadow_opa: 30%

                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0x000000
                                shadow_ofs_x: 6
                                shadow_ofs_y: 3

                            - obj:
                                width: 128
                                height: 128
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 75
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: alarm_panel_state_btn_away
                                      align: center
                                      text_font: mdi_icons_52
                                      text_color: color_steel_blue
                                      text: "${shield_away_icon}"

                      # Bouton NIGHT (bas gauche)
                      - obj:
                          id: alarm_panel_button_night
                          hidden: true
                          width: 164
                          height: 164
                          x: -90
                          y: 90
                          align: center
                          pad_all: 0
                          bg_opa: transp
                          shadow_opa: transp
                          border_opa: transp
                          widgets:
                            - obj:
                                width: 135
                                height: 135
                                align: center
                                clickable: true
                                radius: 75
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                border_width: 0
                                shadow_width: 23
                                shadow_spread: 3
                                shadow_color: color_black
                                pressed:
                                  bg_color: 0x3A3A4C
                                  shadow_width: 8
                                on_press:
                                  - lambda: |-
                                      id(alarm_panel_pending_action) = std::string("arm_night");
                                  - lvgl.widget.show: alarm_panel_keypad_page
                                  - lvgl.widget.hide: alarm_panel_state_bg
                                  - lvgl.widget.hide: alarm_panel_state_control
                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0xFFFFFF
                                shadow_ofs_x: -6
                                shadow_ofs_y: -3
                                shadow_opa: 30%

                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0x000000
                                shadow_ofs_x: 6
                                shadow_ofs_y: 3

                            - obj:
                                width: 128
                                height: 128
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 75
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: alarm_panel_state_btn_night
                                      align: center
                                      text_font: mdi_icons_52
                                      text_color: color_steel_blue
                                      text: "${shield_night_icon}"

                      # Bouton VACATION (bas droit)
                      - obj:
                          id: alarm_panel_button_vacation
                          hidden: true
                          width: 164
                          height: 164
                          x: 90
                          y: 90
                          align: center
                          pad_all: 0
                          bg_opa: transp
                          shadow_opa: transp
                          border_opa: transp
                          widgets:
                            - obj:
                                width: 135
                                height: 135
                                align: center
                                clickable: true
                                radius: 75
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                border_width: 0
                                shadow_width: 23
                                shadow_spread: 3
                                shadow_color: color_black
                                pressed:
                                  bg_color: 0x3A3A4C
                                  shadow_width: 8
                                on_press:
                                  - lambda: |-
                                      id(alarm_panel_pending_action) = std::string("arm_vacation");
                                  - lvgl.widget.show: alarm_panel_keypad_page
                                  - lvgl.widget.hide: alarm_panel_state_bg
                                  - lvgl.widget.hide: alarm_panel_state_control
                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0xFFFFFF
                                shadow_ofs_x: -6
                                shadow_ofs_y: -3
                                shadow_opa: 30%

                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0x000000
                                shadow_ofs_x: 6
                                shadow_ofs_y: 3

                            - obj:
                                width: 128
                                height: 128
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 75
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: alarm_panel_state_btn_vacation
                                      align: center
                                      text_font: mdi_icons_52
                                      text_color: color_steel_blue
                                      text: "${shield_vacation_icon}"

                # Zone caméra canvas à droite (preview) - 192x144
                - obj:
                    id: camera_preview_container
                    x: 720
                    y: 30
                    width: 250
                    height: 200
                    align: TOP_LEFT
                    bg_color: color_steel_blue
                    bg_opa: 20%
                    border_opa: TRANSP
                    radius: 15
                    clickable: true
                    on_press:
                      - switch.turn_on: camera_1_switch
                      - lvgl.widget.hide: alarm_main_view
                      - lvgl.widget.show: camera_fullscreen_view
                    widgets:
                      - canvas:
                          id: cctv_canvas_preview
                          width: 192
                          height: 144
                          x: 29
                          y: 18
                          bg_color: 0x000000
                      
                      - label:
                          align: BOTTOM_MID
                          y: -10
                          text_font: nunito_18
                          text_color: color_misty_blue
                          text: "Tap for fullscreen"

                # Zone d'informations avec bouton refresh et contrôles caméra
                - obj:
                    id: alarm_panel_bg_name
                    x: 720
                    y: 250
                    width: 250
                    height: 300
                    align: TOP_LEFT
                    bg_color: color_steel_blue
                    bg_opa: 20%
                    border_opa: TRANSP
                    border_width: 0
                    shadow_opa: TRANSP
                    radius: 10
                    widgets:
                      - label:
                          align: TOP_MID
                          y: 10
                          id: alarm_panel_label_name
                          text_font: nunito_18
                          text_color: color_white
                          text: "Alarm Panel"

                      - button:
                          align: TOP_MID
                          x: 0
                          y: 50
                          width: 200
                          height: 50
                          radius: 25
                          bg_color: 0x27ae60
                          bg_opa: 80%
                          border_width: 1
                          border_color: color_white
                          id: start_camera_btn
                          on_click:
                            - switch.turn_on: camera_1_switch
                          widgets:
                            - label:
                                align: CENTER
                                text_font: nunito_18
                                text_color: color_white
                                text: "Start Camera"

                      - button:
                          align: TOP_MID
                          x: 0
                          y: 120
                          width: 200
                          height: 50
                          radius: 25
                          bg_color: 0xe74c3c
                          bg_opa: 80%
                          border_width: 1
                          border_color: color_white
                          id: stop_camera_btn
                          on_click:
                            - switch.turn_off: camera_1_switch
                          widgets:
                            - label:
                                align: CENTER
                                text_font: nunito_18
                                text_color: color_white
                                text: "Stop Camera"

                      - label:
                          align: BOTTOM_MID
                          y: -20
                          text_font: nunito_16
                          text_color: color_misty_blue
                          text: "Camera Controls"

          # Vue caméra plein écran
          - obj:
              id: camera_fullscreen_view
              hidden: true
              x: 0
              y: 0
              width: 1280
              height: 720
              align: TOP_LEFT
              bg_color: color_black
              bg_opa: 90%
              border_opa: transp
              widgets:
                # Canvas plein écran - 640x480 centré
                - canvas:
                    id: cctv_canvas
                    width: 640
                    height: 480
                    x: 320  # Centré: (1280-640)/2
                    y: 120  # Centré: (720-480)/2
                    bg_color: 0x000000

                # Bouton retour (coin supérieur gauche)
                - button:
                    align: TOP_LEFT
                    x: 20
                    y: 20
                    width: 80
                    height: 50
                    radius: 25
                    bg_color: color_steel_blue
                    bg_opa: 80%
                    border_width: 1
                    border_color: color_white
                    on_click:
                      - switch.turn_off: camera_1_switch
                      - lvgl.widget.hide: camera_fullscreen_view
                      - lvgl.widget.show: alarm_main_view
                    widgets:
                      - label:
                          align: CENTER
                          text_font: nunito_18 
                          text: "Exit"
                          text_color: color_white

                # Bouton stop (coin supérieur droit)
                - button:
                    align: TOP_RIGHT
                    x: -20
                    y: 20
                    width: 120
                    height: 50
                    radius: 25
                    bg_color: 0xe74c3c
                    bg_opa: 80%
                    border_width: 1
                    border_color: color_white
                    id: refresh_camera_btn_fullscreen
                    on_click:
                      - switch.turn_off: camera_1_switch
                    widgets:
                      - label:
                          align: CENTER
                          text: "STOP"
                          text_font: nunito_18
                          text_color: color_white

                # Informations overlay (coin inférieur gauche)
                - obj:
                    align: BOTTOM_LEFT
                    x: 20
                    y: -20
                    width: 250
                    height: 60
                    bg_color: color_steel_blue
                    bg_opa: 70%
                    border_opa: transp
                    radius: 10
                    widgets:
                      - label:
                          id: camera_info_label
                          align: CENTER
                          text_font: nunito_16
                          text_color: color_white
                          text: "Live Camera Feed - 640x480"

          # Clavier d'alarme
          - obj:
              id: alarm_panel_keypad_page
              hidden: true
              x: 30
              y: 30
              width: 658
              height: 538
              align: TOP_LEFT
              bg_color: color_steel_blue
              bg_opa: 20%
              border_opa: TRANSP
              shadow_opa: TRANSP
              radius: 15
              widgets:
                - obj:
                    width: 598
                    height: 70
                    align: top_mid
                    border_width: 1
                    border_color: color_steel_blue
                    pad_all: 0
                    bg_opa: transp
                    shadow_opa: transp
                    radius: 15
                    widgets:
                      - label:
                          id: alarm_panel_keypad_code_label
                          align: center
                          text_font: nunito_36
                          text: "Enter code"
                          text_color: color_misty_blue
                          text_align: center
                
                - buttonmatrix:
                    id: alarm_panel_keypad
                    width: 598
                    height: 404
                    pad_all: 0
                    bg_opa: transp
                    border_opa: transp
                    x: 3
                    y: 45
                    align: center
                    items:
                      bg_opa: transp
                      border_color: color_steel_blue
                      border_width: 1
                      shadow_opa: transp
                      text_font: montserrat_30
                      text_color: color_misty_blue
                      pressed:
                        bg_color: color_blue
                        text_color: color_white
                        border_color: color_blue
                    rows:
                      - buttons:
                          - text: 1
                            control:
                              no_repeat: true
                          - text: 2
                            control:
                              no_repeat: true
                          - text: 3
                            control:
                              no_repeat: true
                      - buttons:
                          - text: 4
                            control:
                              no_repeat: true
                          - text: 5
                            control:
                              no_repeat: true
                          - text: 6
                            control:
                              no_repeat: true
                      - buttons:
                          - text: 7
                            control:
                              no_repeat: true
                          - text: 8
                            control:
                              no_repeat: true
                          - text: 9
                            control:
                              no_repeat: true
                      - buttons:
                          - text: "\uF55A"
                            key_code: "*"
                            control:
                              no_repeat: true
                          - text: 0
                            control:
                              no_repeat: true
                          - text: "\uF00C"
                            key_code: "#"
                            control:
                              no_repeat: true

        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms               

#################################################################################################################################################################################################                  








####################################################################################################################################################################################################

interval:
  - interval: 60s
    then:
      - lambda: |-
          // Log real memory usage
          const size_t total_sram = 512 * 1024;
          const size_t total_psram = 8 * 1024 * 1024;
          
          size_t free_sram = heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
          size_t used_sram = total_sram - free_sram;
          
          size_t free_psram = heap_caps_get_free_size(MALLOC_CAP_SPIRAM);
          size_t used_psram = total_psram - free_psram;
          
          ESP_LOGI("system_info", "SRAM: %u/%u KB used (%.1f%%)", 
                   used_sram/1024, total_sram/1024, 
                   (used_sram * 100.0) / total_sram);
          
          if (heap_caps_get_total_size(MALLOC_CAP_SPIRAM) > 0) {
            ESP_LOGI("system_info", "PSRAM: %u/%u MB used (%.1f%%)", 
                     used_psram/(1024*1024), total_psram/(1024*1024),
                     (used_psram * 100.0) / total_psram);
          } else {
            ESP_LOGI("system_info", "PSRAM: Not available");
          }






  #- interval: 33ms  # ~30 Hz
    #then:
      #- lambda: |-
          #if (id(tab5_cam).is_streaming()) {
            #id(camera_frame_count)++;
          #}

  #- tab5_camera.take_picture: /camera/test.jpg
  #- interval: 10s
    #then:
      #- online_image.set_url:
          #id: cctv_img
          #url: "${frigate}"

  #- interval: 1s
    #then:
      #- if:
          #condition:
            #lambda: 'return id(slideshow_active) && id(max_images) > 0;'
          #then:
            #- lambda: |-
                #static int counter = 0;
                #counter++;
                #if (counter < id(slideshow_interval).state) return;  // récupérer la valeur du number
                #counter = 0;

                #int current = id(current_image_index);
                #current++;
                #if (current > id(max_images)) {
                  #current = 1;  // Retour au début
                #}
                #id(current_image_index) = current;
                
                #std::string filename = "/diap/NCC" + std::to_string(current) + ".jpg";
                #ESP_LOGI("slideshow", "Chargement image: %s", filename.c_str());

            #- sd_image.load:
                #id: slideshow_image
                #file_path: !lambda |
                  #return "/diap/NCC" + std::to_string(id(current_image_index)) + ".jpg";

            #- lvgl.image.update:
                #id: update_photo
                #src: slideshow_image 




   

key_collector:
  - source_id: alarm_panel_keypad
    min_length: 4
    max_length: 4
    end_keys: "#"
    end_key_required: true
    back_keys: "*"
    allowed_keys: "0123456789*#"
    timeout: 5s
    on_progress:
      - if:
          condition:
            lambda: return (0 != x.compare(std::string{""}));
          then:
            - lvgl.label.update:
                id: alarm_panel_keypad_code_label
                text: !lambda 'return x.c_str();'
          else:
            - lvgl.label.update:
                id: alarm_panel_keypad_code_label
                text_font: nunito_36
                text_color: color_misty_blue
                text: "Enter code"
    on_result:      
      - if:
          condition:
            lambda: 'return x == "${pin_code}";'
          then:
            # Если код верный, отправляем команду в Home Assistant для снятия с охраны

            - if:
                condition:
                  lambda: 'return id(alarm_panel_pending_action) == "disarm";'
                then:
                  - homeassistant.action:
                      action: alarm_control_panel.alarm_disarm
                      data:
                        entity_id: "${alarm_panel_entity}"
                        code: "${pin_code}"
            - if:
                condition:
                  lambda: 'return id(alarm_panel_pending_action) == "arm_home";'
                then:
                  - homeassistant.action:
                      action: alarm_control_panel.alarm_arm_home
                      data:
                        entity_id: "${alarm_panel_entity}"
                        code: "${pin_code}"

            - if:
                condition:
                  lambda: 'return id(alarm_panel_pending_action) == "arm_away";'
                then:
                  - homeassistant.action:
                      action: alarm_control_panel.alarm_arm_away
                      data:
                        entity_id: "${alarm_panel_entity}"
                        code: "${pin_code}"

            - if:
                condition:
                  lambda: 'return id(alarm_panel_pending_action) == "arm_night";'
                then:
                  - homeassistant.action:
                      action: alarm_control_panel.alarm_arm_night
                      data:
                        entity_id: "${alarm_panel_entity}"
                        code: "${pin_code}"

            - if:
                condition:
                  lambda: 'return id(alarm_panel_pending_action) == "arm_vacation";'
                then:
                  - homeassistant.action:
                      action: alarm_control_panel.alarm_arm_vacation
                      data:
                        entity_id: "${alarm_panel_entity}"
                        code: "${pin_code}"

            - lvgl.widget.hide: alarm_panel_keypad_page
            - lvgl.widget.show: alarm_panel_state_bg
            - lvgl.widget.show: alarm_panel_state_control


 
substitutions:
  name: waveshare
  friendly_name: waveshare

  micro_wake_word_model: okay_nabu


  allowed_characters: " !#%'()+,-./0123456789:;<>?@ABCDEFGHIJKLMNOPQRSTUVWYZ[]_abcdefghijklmnopqrstuvwxyz{|}°²³µ¿ÁÂÄÅÉÖÚßàáâãäåæçèéêëìíîðñòóôõöøùúûüýþāăąćčďĐđēėęěğĮįıļľŁłńňőřśšťũūůűųźŻżŽžơưșțΆΈΌΐΑΒΓΔΕΖΗΘΚΜΝΠΡΣΤΥΦάέήίαβγδεζηθικλμνξοπρςστυφχψωϊόύώАБВГДЕЖЗИКЛМНОПРСТУХЦЧШЪЭЮЯабвгдежзийклмнопрстуфхцчшщъыьэюяёђєіїјљњћאבגדהוזחטיכלםמןנסעפץצקרשת،ءآأإئابةتجحخدذرزسشصضطظعغفقكلمنهوىيٹپچڈکگںھہیےংকচতধনফবযরলশষস়ািু্చయలిెొ్ംഅആഇഈഉഎഓകഗങചജഞടഡണതദധനപഫബഭമയരറലളവശസഹാിീുൂെേൈ്ൺൻർൽൾაბგდევზთილმნოპრსტუფქყშჩცძჭხạảấầẩậắặẹẽếềểệỉịọỏốồổỗộớờởợụủứừửữựỳ—、一上不个中为主乾了些亮人任低佔何作供依侧係個側偵充光入全关冇冷几切到制前動區卧厅厨及口另右吊后吗启吸呀咗哪唔問啟嗎嘅嘛器圍在场執場外多大始安定客室家密寵对將小少左已帘常幫幾库度庫廊廚廳开式後恆感態成我戲戶户房所扇手打执把拔换掉控插摄整斯新明是景暗更最會有未本模機檯櫃欄次正氏水沒没洗活派温測源溫漏潮激濕灯為無煙照熱燈燥物狀玄现現瓦用發的盞目着睡私空窗立笛管節簾籬紅線红罐置聚聲脚腦腳臥色节著行衣解設調請謝警设调走路車车运連遊運過道邊部都量鎖锁門閂閉開關门闭除隱離電震霧面音頂題顏颜風风食餅餵가간감갔강개거게겨결경고공과관그금급기길깥꺼껐꼽나난내네놀누는능니다닫담대더데도동됐되된됨둡드든등디때떤뜨라래러렇렌려로료른를리림링마많명몇모무문물뭐바밝방배변보부불블빨뽑사산상색서설성세센션소쇼수스습시신실싱아안않알았애야어얼업없었에여연열옆오온완외왼요운움워원위으은을음의이인일임입있작잠장재전절정제져조족종주줄중줘지직진짐쪽차창천최추출충치침커컴켜켰쿠크키탁탄태탬터텔통트튼티파팬퍼폰표퓨플핑한함해했행혀현화활후휴힘，？"
  
  font_glyphsets: "GF_Latin_Core"
  # for Greek use "Noto Sans" for other languages use a compatible font family
  font_family: Figtree  

  frigate: "http://192.168.1.38:8123/local/snapshots/last_snapshot.jpg"
  #frigate1: rtsp://Tapoone:Tapoone132@192.168.1.56:554/stream1
 
  media_player_entity: "media_player.waveshare_esp32_p4_media_player"
  weather_entity: weather.forecast_maison #weather
  
  power_icon:        "\U0000e909"
  play_icon:         "\U0000e90a"
  pause_icon:        "\U0000e90b"
  back_step_icon:    "\U0000e90c"
  forward_step_icon: "\U0000e90d"
  volume_off_icon:   "\U0000e90e"
  volume_on_icon:    "\U0000e90f"
  volume_minus_icon: "\U0000e910"
  volume_plus_icon:  "\U0000e911"
  repeat_all_icon:   "\U0000e912"
  repeat_off_icon:   "\U0000e913"
  repeat_one_icon:   "\U0000e914"
  ha:                "\U0000e90b" # home assistant
  humidity:          "\U0000e912" # humidity
  temperature:       "\U0000e915" # temperature
  tvoc:              "\U0000e914" # air quality
  co2:               "\U0000e913" # co2
  door:              "\U000F081A"
  garage:            "\U000F06D9"
  shutter:           "\U000F1A8B"
  setting:           "\U000F08D6"
  alarm:             "\U000F0BC4"
  exit_icon:         "\U0000e902"
  recognition:       "\U000F0C7B"
  vlc:               "\U000F057C"
  youtube:           "\U000F05C3"
  application:       "\U000F0675"

  settings_icon:                 "\U0000e903"
  info_icon:                     "\U0000e904"
  devices_icon:                  "\U0000e905"
  home_icon:                     "\U0000e906"
  ceiling_icon:                  "\U0000e907"
  lightbulb_icon:                "\U0000e908"
  spotlight_group_icon:          "\U0000e915"
  desk_lamp_icon:                "\U0000e916"
  pendant_lamp_icon:             "\U0000e917" 
  ceiling_lamp_icon:             "\U0000e918"
  ceiling_lamp_variant_icon:     "\U0000e921"
  night_lamp_icon:               "\U0000e919"
  swipe_icon:                    "\U0000e91a"
  brightness_icon:               "\U0000e900"
 

  voice_assist_idle_phase_id: "1"
  voice_assist_listening_phase_id: "2"
  voice_assist_thinking_phase_id: "3"
  voice_assist_replying_phase_id: "4"
  voice_assist_not_ready_phase_id: "10"
  voice_assist_error_phase_id: "11"
  voice_assist_muted_phase_id: "12"
  voice_assist_timer_finished_phase_id: "20"

  loading_illustration_background_color: "000000"
  idle_illustration_background_color: "000000"
  listening_illustration_background_color: "FFFFFF"
  thinking_illustration_background_color: "FFFFFF"
  replying_illustration_background_color: "FFFFFF"
  error_illustration_background_color: "000000"
  timer_illustration_background_color: "FFFFFF"
  
  alarm_panel_entity:   "alarm_control_panel.alarmo" #"alarm_control_panel.security"
  pin_code:             "1169"

  unlock_pin_code: "1169" 

  shield_home_icon:      "\U000F068A" # home
  shield_away_icon:      "\U000F099D" # away
  shield_night_icon:     "\U000F1828" # night
  shield_vacation_icon:  "\U000F06BB" # vacation
  shield_disarm_icon:    "\U000F099E" # disarmed
  shield_arming_icon:    "\U000F0498" # arming
  micro_sd:              "\U000F07DC"


esphome:
  name: waveshare
  friendly_name: waveshare

  on_boot:
    priority: 850
    then:
      - logger.log: "Démarrage - Attente du montage de la carte SD..."
      - delay: 5s
      - logger.log: "Délai écoulé - Allumage du rétroéclairage"
      - light.turn_on: backlight
 

esp32:
  variant: esp32p4
  flash_size: 32MB
  cpu_frequency: 360MHz
  framework:
    type: esp-idf
    version: 5.5.2
    platform_version: 55.03.35
    advanced:
      enable_idf_experimental_features: true
      disable_vfs_support_dir: false
    sdkconfig_options:
      CONFIG_ESP_TASK_WDT_TIMEOUT_S: "30"
      CONFIG_ESP_H264_DUAL_TASK: "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: "y"
      CONFIG_SPIRAM_RODATA: "y"
      CONFIG_ESP32_SPIRAM_SUPPORT: "y"
      CONFIG_SPIRAM_USE_MALLOC: "y"
      CONFIG_FATFS_LFN_STACK: "y"
      #CONFIG_LWIP_SO_RCVBUF: "y"
      CONFIG_LWIP_MAX_SOCKETS: "16"
      CONFIG_VFS_SUPPORT_IO: "y"
      CONFIG_VFS_MAX_COUNT: "16" 
      CONFIG_ESP_MAIN_TASK_STACK_SIZE: "16384"
      #CONFIG_ESP_MAIN_TASK_STACK_SIZE: "65536" 
      CONFIG_ESP_TIMER_TASK_STACK_SIZE: "4096"
      #CONFIG_ESP_TIMER_TASK_STACK_SIZE: "8192"
      #CONFIG_ESP_TASK_WDT_TIMEOUT_S: "60"
      CONFIG_ESP_TASK_LOOP_STACK_SIZE: "16384"
      CONFIG_FATFS_LFN_HEAP: "y"
      #DCONFIG_USE_AUDIO_AAC_SUPPORT: "y"
      #DCONFIG_ESP_JPG_DECODE_ENABLE: "y"
      #DCONFIG_ESPHOME_ENABLE_PNGLE: "1"
      CONFIG_SPIRAM_SPEED_200M: "y"  # ← NOUVEAU: 200 MHz au lieu de défaut
      CONFIG_SPIRAM_SPEED: "200"

      #CONFIG_HTTPD_MAX_REQ_HDR_LEN: "800"
      #CONFIG_HTTPD_WS_SUPPORT: "y"


http_request:
  #verify_ssl: false


online_image:
  - url: "${frigate}"
    format: JPG
    id: cctv_img
    byte_order: little_endian    
    type: RGB565
    resize: 1000x600 #450x300 #1000x700
    #on_download_finished:
      #- lvgl.image.update:
          #id: cctv_img_lvgl
          #src: cctv_img  

psram:
  mode: hex
  speed: 200MHz

# Enable Home Assistant API
api:
  encryption:
    key: "dkQIr4kVvP+E4XffuF9vSL5qQopmfgW6voYVkciZ3V8="

ota:
  - platform: esphome
    password: "490f749427bef8df98be01b4895c7058"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
 

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Waveshare Fallback Hotspot"
    password: "ONf0EKacM29P"

captive_portal:

time:
 #- platform: homeassistant
    #id: ha_time
    #on_time_sync:
      #- script.execute: update_clock


  - platform: homeassistant
    id: homeassistant_time
    on_time_sync:
      - script.execute: update_clock
      - if:
          condition:
            lambda: 'return id(device_last_restart).state == "";'
          then:
            - text_sensor.template.publish:
                id: device_last_restart
                state: !lambda 'return id(homeassistant_time).now().strftime("%a %d %b %Y - %I:%M:%S %p");'          
    on_time:
      - seconds: "*"
        then:
          - script.execute: update_clock

  - platform: sntp
    id: sntp_time
    servers:
     - ntp0.ntp-servers.net
     - ntp1.ntp-servers.net
     - ntp2.ntp-servers.net
    on_time_sync:
      - script.execute: update_clock
    on_time:
      - minutes: '*'
        hours: 0
        seconds: 0
        then:
          - script.execute: update_clock


 

logger:
  hardware_uart: USB_SERIAL_JTAG
  #logs:
    #simple_video_player: DEBUG


external_components:
  - source: github://pr#13608
    components: [mipi_dsi]
    refresh: always

  - source: github://pr#12312
    components: [font]
    refresh: 1h    
    
  - source:
      type: git
      url: https://github.com/youkorr/lvgl_9.4
      ref: claude/fix-lottie-reload-issue-ARogJ #claude/fix-lvgl-hidden-property-WQgoC #claude/fix-lvgl-hidden-property-JyQ89 #claude/fix-lottie-widget-z9ydW #claude/fix-lottie-crash-VcRU1 #claude/fix-lvgl-widgets-Ag1yK #claude/fix-lvgl-rendering-performance-xauVV
    components: [lvgl, image]
    refresh: always   

  - source:
      type: git
      url: https://github.com/youkorr/test2_esp_video_esphome
      ref: main #claude/optimize-face-detection-memory-0mKRM #claude/decouple-esp-video-Hr7PK
    components: [esp_video, esp_cam_sensor, sd_mmc_card, webdavbox3, storage, lvgl_camera_display, simple_video_player, network_camera, face_detection]
    refresh: always  

esp_video:
  i2c_id: bsp_bus
  xclk_pin: GPIO36
  xclk_freq: 24000000
  enable_jpeg: true
  enable_isp: true
  use_heap_allocator: false

esp_cam_sensor:
  id: tab5_cam
  i2c_id: bsp_bus
  sensor_type: ov5647        #"sensor_type" au lieu de "sensor"
  resolution: "800x640"          # , 1024x600 ,vga
  pixel_format: "RGB565"      # Zero-copy 
  framerate: 30
  jpeg_quality: 15
  mirror_x: false    # Flip horizontal (hardware)
  mirror_y: false      # Flip vertical
  rotation: 0          # 0/90/180/270°
  crop_offset_x: 0     # Crop pixels from left
 
# ============================================================================
# network_camera
# ============================================================================ 


network_camera:
  - id: security_cam_1
    url: "http://192.168.1.38:1984/api/stream.mjpeg?src=frigate1_esp32" #"http://192.168.1.38:1984/api/stream.mjpeg?src=frigate1_esp32"  #""rtsp://192.168.1.38:8554/frigate1_esp32_h264""
    protocol: mjpeg
    width: 640
    height: 480
    canvas_id: security_canvas
    update_interval: 20ms

#multi_camera_display:
  #id: security_display
  #canvas_id: security_canvas
  #cameras:
    #- camera_id: security_cam_1  


#network_camera:
  #- id: security_cam_1
    #url: "rtsp://Tapoone:Tapoone132@192.168.1.56:554/stream1"
    #protocol: rtsp
    #width: 320
    #height: 240
    #canvas_id: security_canvas

#network_camera:
  #- id: security_cam_1
    #url: "http://192.168.1.38:1984/api/frame.jpeg?src=frigate1&width=320&height=240"  # URL MJPEG (à vérifier)
    #protocol: mjpeg
    #width: 320
    #height: 240
    #update_interval: 100ms
    #canvas_id: security_canvas

#network_camera:
  #- id: security_cam_1
    #url: "rtsp://192.168.1.38:8554/frigate1_esp32"  # go2rtc stream2 @ 640x360
    #protocol: rtsp
    #width: 640
    #height: 360
    #canvas_id: security_canvas
    #update_interval: 100ms

    

#multi_camera_display:
  #id: security_display
  #canvas_id: security_canvas
  #cameras:
    #- camera_id: security_cam_1

# ============================================================================
# rtsp_server
# ============================================================================

#rtsp_server:
  #id: rtsp_srv
  #camera_id: tab5_cam
  #port: 554                
  #stream_path: "/stream"   
  #username: "youkorr"
  #password: "youkorr123"
  #bitrate: 3000000 #3000000         
  #gop: 15                  
  #qp_min: 20
  #qp_max: 30 



# ============================================================================
# Serveur Web HTTP (streaming MJPEG + snapshots)
# ============================================================================
#camera_web_server:
  #id: web_cam_srv
  #camera_id: tab5_cam
  #port: 8080
  #enable_stream: true       # http://IP:8080/stream
  #enable_snapshot: false
  #face_detector: face_detector       

# ============================================================================
# Display LVGL avec caméra
# ============================================================================

lvgl_camera_display:
  id: camera_display
  camera_id: tab5_cam
  canvas_id: camera_canvas
  update_interval: 33ms
  face_detection_id: face_detect
  #yolo11_detection_id: yolo_detect 


# Detection de visages + reconnaissance (independant)
face_detection:
  id: face_detect
  camera_id: tab5_cam
  canvas_id: camera_canvas
  model_type: face_recognition 
  score_threshold: 0.3
  nms_threshold: 0.5 # distance
  detection_interval: 5
  draw_enabled: true
  recognition_enabled: true
  face_db_path: "/sdcard/reconnaisance_faciale/faces.db"
  recognition_threshold: 0.85


# ============================================================================
# yolo11_detection
# ============================================================================


#yolo11_detection:
  #id: yolo_detect
  #camera_id: tab5_cam
  #score_threshold: 0.3
  #nms_threshold: 0.5
  #detection_interval: 8
  #draw_enabled: true
  #on_object_detected:
    #- lambda: |-
        #ESP_LOGI("main", "Objects détectés: %d", object_count);  

# ============================================================================
# simple_video_player 
# ============================================================================

simple_video_player:
  id: my_video_player
  file_path:  "/sdcard/MJPEG/video_02_30fps.avi"  #"/sdcard/The.Superdeep.BDRip.XviD.avi" #"/sdcard/tv_movies/Doctor.Who_output.avi"  #video_02_optimized.avi #"/sdcard/MP4/Rise-of-Skywalker_fixed.mp4" # "/sdcard/MP4/desert_480x272.mp4" # "/sdcard/MP4/slywalker640x480.avi"
  #width: 800
  #height: 480
  parent_id: video_page
  fps: 15       # ← LVGL parent screen
  #buffer_size: 524288             # 512 KB
  #cache_buffer_size: 131072       # 128 KB
  show_controls: true             # ← Afficher contrôles
  #show_slider: true               # ← Afficher slider
  auto_play: false                # ← Auto-démarrage
  loop: false
  rotation: 0
  preload_to_memory: false
 

# ============================================================================
# webdavbox3
# ============================================================================    

webdavbox3:
  id: sd_cards
  root_path: "/sdcard"
  url_prefix: "/"
  port: 81
  username: "youkorr"
  password: "youkorr"

#ppa_accelerator:
  #id: ppa

# ============================================================================
# sd_mmc_card
# ===========================================================================
sd_mmc_card:
  id: sd_card
  clk_pin: GPIO43
  cmd_pin: GPIO44
  data0_pin: GPIO39
  data1_pin: GPIO40
  data2_pin: GPIO41
  data3_pin: GPIO42
  mode_1bit: false
  slot: 0

# ============================================================================
# Storage
# ===========================================================================

storage:
    platform: sd_direct
    id: my_storage
    sd_component: sd_card
    root_path: "/sdcard" 
    sd_images:

      #- id: peaceful
        #file_path: "/RGB888/amao1.png"
        #resize: 1024x600
        #format: rgb888
        #byte_order: little_endian
        #auto_load: true 

      - id: peaceful
        file_path: "/diap/NCC7.jpg"
        #resize: 1024x600
        format: rgb565
        byte_order: little_endian
        #auto_load: true         
    
###############################################################################################################################################################
esp32_hosted:
  variant: ESP32C6
  reset_pin: GPIO54
  cmd_pin: GPIO19
  clk_pin: GPIO18
  d0_pin: GPIO14
  d1_pin: GPIO15
  d2_pin: GPIO16
  d3_pin: GPIO17
  active_high: true
  slot: 1

i2c:
  - id: bsp_bus
    sda: GPIO07
    scl: GPIO08
    frequency: 400kHz 

esp_ldo:
  - voltage: 2.5V
    channel: 3
  - voltage: 2.5V
    channel: 4       
# =============================================================================
# I2S AUDIO CONFIGURATION (ES7210 + ES8311)
# =============================================================================
i2s_audio:
  - id: audio_bus
    i2s_mclk_pin: GPIO13
    i2s_lrclk_pin: GPIO10
    i2s_bclk_pin: GPIO12


audio_dac:
  - platform: es8311
    id: es8311_dac
    i2c_id: bsp_bus
    address: 0x18

audio_adc:
  - platform: es7210
    id: es7210_adc
    i2c_id: bsp_bus
    address: 0x40

microphone:
  - platform: i2s_audio
    id: esp32_microphone
    i2s_audio_id: audio_bus
    i2s_din_pin: GPIO11
    sample_rate: 16000
    bits_per_sample: 16bit
    adc_type: external

speaker:
  - platform: i2s_audio
    id: esp32_speaker
    i2s_audio_id: audio_bus
    i2s_dout_pin: GPIO9
    audio_dac: es8311_dac
    dac_type: external
    channel: stereo
    buffer_duration: 100ms
    bits_per_sample: 16bit
    sample_rate: 48000

  - platform: mixer
    id: mixing_speaker
    output_speaker: esp32_speaker
    source_speakers:
      - id: announcement_mixing_input
        timeout: never
      - id: media_mixing_input
        timeout: never

  - platform: resampler
    id: announcement_resampling_speaker
    output_speaker: announcement_mixing_input
    sample_rate: 48000
    bits_per_sample: 16

  - platform: resampler
    id: media_resampling_speaker
    output_speaker: media_mixing_input
    sample_rate: 48000
    bits_per_sample: 16

media_player:
  - platform: speaker
    name: "ESP32 P4 Media Player"
    id: speaker_media_player
    codec_support_enabled: true
    volume_min: 0.5
    volume_max: 0.75
    volume_increment: 0.05
    announcement_pipeline:
      speaker: announcement_resampling_speaker
      format: FLAC
      sample_rate: 48000
      num_channels: 1
    media_pipeline:
      speaker: media_resampling_speaker
      format: FLAC
      num_channels: 1
      sample_rate: 48000








number:
  - platform: template
    id: brightness_slider
    name: "Luminosité Écran"
    icon: "mdi:brightness-6"
    min_value: 0
    max_value: 100
    step: 1
    unit_of_measurement: "%"
    mode: slider
    optimistic: true
    restore_value: true
    initial_value: 50
    on_value:
      then:
        - if:
            condition:
              lambda: 'return x > 0;'
            then:
              - light.turn_on:
                  id: backlight
                  brightness: !lambda 'return x / 100.0;'
            else:
              - light.turn_off:
                  id: backlight



  #- platform: template
    #name: "Slideshow Interval"
    #id: slideshow_interval
    #optimistic: true
    #restore_value: true
    #min_value: 1
    #max_value: 30
    #step: 1
    #unit_of_measurement: "s"
    #icon: 'mdi:timer'
    #initial_value: 5
    #on_value:
      #then:
        #- lvgl.label.update:
            #id: current_slideshow_value
            #text: !lambda |-
              #int val = (int)round(id(slideshow_interval).state);
              #return std::string(std::to_string(val) + "s");

  - platform: template
    name: "Screen Off"
    id: auto_off
    optimistic: true
    restore_value: true
    min_value: -1
    max_value: 300
    step: 10
    unit_of_measurement: s
    icon: 'mdi:television-off'
    disabled_by_default: true
    initial_value: 150
    on_value:
      then:
        - lvgl.label.update:
            id: current_timeout_value
            text: !lambda |-
              int timeout = id(auto_off).state;
              if (timeout == -1) return "OFF";
              return (std::to_string(timeout) + "s").c_str();

        #- lambda: |-
            #id(face_unlock_timeout_sec) = (int)x;
            #ESP_LOGI("lock", "Face unlock timeout: %d sec", (int)x);  

  #- platform: template
    #name: "Auto-Lock Timeout"
    #id: auto_lock_timeout
    #icon: 'mdi:television-off'
    #unit_of_measurement: s
    #initial_value: 50
    #min_value: -1  # -1 = désactivé
    #max_value: 600
    #step: 10
    #disabled_by_default: true
    #optimistic: true
    #restore_value: true
    #on_value:
      #then:
        ##- lambda: |-
            ##id(face_unlock_timeout_sec) = (int)x;
            ##ESP_LOGI("lock", "Auto-Lock timeout: %d sec", (int)x);

        #- lvgl.label.update:
            #id: auto_lock_timeout_value
            #text: !lambda |-
              #//int val = (int)round(id(auto_lock_timeout).state);
              #int timeout = id(auto_lock_timeout).state;
              #if (timeout == -1) return "OFF";
              #return (std::to_string(timeout) + "s").c_str();

  - platform: template
    name: "Sleep Display Duration"
    id: sleep_display_duration
    icon: 'mdi:clock-outline'
    unit_of_measurement: s
    initial_value: 10
    min_value: 30      # 0 = éteint immédiatement
    max_value: 60
    step: 10
    optimistic: true
    restore_value: true
    on_value:
      then:
        - lambda: |-
            id(face_unlock_timeout_sec) = (int)x;
            ESP_LOGI("lock", "Auto-Lock timeout: %d sec", (int)x);

        - lvgl.label.update:
            id: sleep_display_duration_value
            text: !lambda |-
              int val = (int)round(id(sleep_display_duration).state);
              int timeout = id(sleep_display_duration).state;
              if (timeout == -1) return "OFF";
              return (std::to_string(timeout) + "s").c_str();


  #- platform: template
    #name: "Face Unlock Timeout"
    #id: face_unlock_timeout_number
    #icon: "mdi:timer-lock"
    #unit_of_measurement: "s"
    #min_value: 10
    #max_value: 120
    #step: 5
    #initial_value: 45
    #optimistic: true
    #restore_value: true
    #on_value:
      #then:
        #- lambda: |-
            #id(face_unlock_timeout_sec) = (int)x;
            #ESP_LOGI("lock", "Face unlock timeout: %d sec", (int)x);           


script:
  - id: update_clock
    then:
      # Mise à jour de l'heure (format HH:MM)
      - lvgl.label.update:
          id: time_label
          text: !lambda |-
            auto time = id(homeassistant_time).now();
            return str_sprintf("%02d:%02d", time.hour, time.minute);

      # Mise à jour de l'heure sur la page de veille
      - lvgl.label.update:
          id: sleep_time_label
          text: !lambda |-
            auto time = id(homeassistant_time).now();
            return str_sprintf("%02d:%02d", time.hour, time.minute);
      
      # Mise à jour de la date avec jour de la semaine (format: "Tuesday, Apr 23")
      - lvgl.label.update:
          id: date_label
          text: !lambda |-
            auto time = id(homeassistant_time).now();
            const char* days[] = {"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"};
            const char* months[] = {"", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
            return str_sprintf("%s, %s %02d", days[time.day_of_week - 1], months[time.month], time.day_of_month);

##############################################################################################################################
      #- lvgl.arclabel.update:
          #id: hour_markers
          #text: !lambda |-
            #auto time = id(homeassistant_time).now();
            #return str_sprintf("%02d:%02d", time.hour, time.minute);



      #- lvgl.arclabel.update:
          #id: date_text
          #text: !lambda |-
            #auto time = id(homeassistant_time).now();
            #const char* days[] = {"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"};
            #const char* months[] = {"", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
            #return str_sprintf("%s, %s %02d", days[time.day_of_week - 1], months[time.month], time.day_of_month);            








  - id: update_weather_display
    then:
      - lambda: !lambda |-
          std::string weather = id(weather_state).state.c_str();
          
          // Cacher tous les widgets
          lv_obj_add_flag(id(weather_sunny), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_falling_stars), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_clear_night), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_rainy), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_lightning), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_lightning_nigtht), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_lightning_rain), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_lightning_day_rain), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_cloudy), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_cloudy_night), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_cloudy_night_rain), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_cloudy_day_rain), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_fog), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_fog_day), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_fog_night), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_cloudy_day_fog), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_overcast), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_overcast_day), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_overcast_night), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_hail), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_snow), LV_OBJ_FLAG_HIDDEN);
          lv_obj_add_flag(id(weather_dust_wind), LV_OBJ_FLAG_HIDDEN);
          
          lv_obj_t* active_widget = nullptr;
          const char* label_text = nullptr;
          
          // Déterminer quelle animation afficher selon la météo
          if (weather == "lightning") {
            active_widget = id(weather_lightning);
            label_text = "Orage";
          }
          else if (weather == "lightning-rainy") {
            active_widget = id(weather_lightning_rain);
            label_text = "Orage pluvieux";
          }
          else if (weather == "thunderstorm") {
            active_widget = id(weather_lightning_day_rain);
            label_text = "Orage";
          }
          else if (weather == "cloudy") {
            active_widget = id(weather_cloudy);
            label_text = "Nuageux";
          }
          else if (weather == "partlycloudy") {
            active_widget = id(weather_cloudy_night);
            label_text = "Partiellement nuageux";            
          }
          else if (weather == "partlycloudyrain") {
            active_widget = id(weather_cloudy_day_rain);
            label_text = "Nuageux pluvieux";
          }
          else if (weather == "sunny" || weather == "clear-day") {
            active_widget = id(weather_sunny);
            label_text = "Ensoleillé";
          }
          else if (weather == "clear-night") {
            active_widget = id(weather_clear_night);
            label_text = "Nuit claire";
          }
          else if (weather == "rainy" || weather == "rain") {
            active_widget = id(weather_rainy);
            label_text = "Pluie";
          }
          else if (weather == "pouring") {
            active_widget = id(weather_lightning_day_rain);
            label_text = "Forte pluie";
          }
          else if (weather == "fog") {
            active_widget = id(weather_fog);
            label_text = "Brouillard";
          }
          else if (weather == "fog-day") {
            active_widget = id(weather_fog_day);
            label_text = "Brouillard";
          }
          else if (weather == "fog-night") {
            active_widget = id(weather_fog_night);
            label_text = "Brouillard nocturne";
          }
          else if (weather == "overcast") {
            active_widget = id(weather_overcast);
            label_text = "Couvert";
          }
          else if (weather == "overcast-day") {
            active_widget = id(weather_overcast_day);
            label_text = "Très nuageux";
          }
          else if (weather == "overcast-night") {
            active_widget = id(weather_overcast_night);
            label_text = "Couvert nocturne";
          }
          else if (weather == "hail") {
            active_widget = id(weather_hail);
            label_text = "Grêle";
          }
          else if (weather == "snowy" || weather == "snow") {
            active_widget = id(weather_snow);
            label_text = "Neige";
          }
          else if (weather == "windy") {
            active_widget = id(weather_dust_wind);
            label_text = "Venteux";
          }
          else {
            active_widget = id(weather_sunny);
            label_text = "Inconnu";
          }
          
          if (active_widget != nullptr) {
            // Récupérer le contexte Lottie
            esphome::lvgl::LottieContext *ctx = 
              (esphome::lvgl::LottieContext *)lv_obj_get_user_data(active_widget);
            
            if (ctx != nullptr) {
              // Redémarrer l'animation depuis la frame 0
              esphome::lvgl::lottie_restart(ctx);
            }
            
            // Afficher le widget
            lv_obj_clear_flag(active_widget, LV_OBJ_FLAG_HIDDEN);
            
            ESP_LOGI("weather", "✓ Animation affichée: %s", label_text);
          }
          
          lv_label_set_text(id(weather_label), label_text);











##############################################################################################################################
sensor:
  - platform: template
    name: "Enrolled Faces"
    icon: "mdi:face-man"
    lambda: return id(face_detect).get_enrolled_count();  # Changer ici
    update_interval: 25s




  - platform: homeassistant
    id: weather_temp
    entity_id: weather.forecast_maison
    attribute: temperature
    on_value: 
      then:
        - lvgl.label.update:
            id: chart_temp_value          # <- Changé ici
            text:
              format: "%.0f°C"
              args: [id(weather_temp).state]

  #- platform: homeassistant
    #id: weather_temp
    #entity_id: weather.forecast_maison
    #attribute: temperature
    #on_value: 
      #then:
        #- lvgl.label.update:
            #id: weather_temperature_page
            #text:
              #format: "%.0f°"
              #args: [id(weather_temp).state]




             
  #- platform: homeassistant
    #id: weather_humidity
    #entity_id: weather.forecast_maison
    #attribute: humidity
    #on_value: 
      #then:
        #- lvgl.label.update:
            #id: chart_humidity_value      # <- Changé ici
            #text:
              #format: "%.0f%%"
              #args: [id(weather_humidity).state]


           

             
  #- platform: homeassistant
    #id: weather_humidity
    #entity_id: weather.montauban
    #attribute: humidity
    #on_value: 
      #then:
        #- lvgl.label.update:
            #id: weather_humidity_page
            #text:
              #format: "%.0f%%"
              #args: [id(weather_humidity).state]

  #- platform: homeassistant
    #id: weather_temp
    #entity_id: weather.montauban
    #attribute: temperature
    #on_value: 
      #then:
        #- lvgl.label.update:
            #id: weather_temperature_page
            #text:
              #format: "%.0f°"
              #args: [id(weather_temp).state]
        #- lvgl.chart.set_next_value:
            #id: temp_chart
            #series_id: temp_series
            #value: !lambda 'return (int)id(weather_temp).state;'

  #- platform: homeassistant
    #id: weather_humidity
    #entity_id: weather.montauban
    #attribute: humidity
    #on_value: 
      #then:
        #- lvgl.label.update:
            #id: weather_humidity_page
            #text:
              #format: "%.0f%%"
              #args: [id(weather_humidity).state]
        #- lvgl.chart.set_next_value:
            #id: temp_chart
            #series_id: humidity_series
            #value: !lambda 'return (int)id(weather_humidity).state;'

  #- platform: sd_mmc_card
    #sd_card_type:
      #name: "SD card type"  








           

  - platform: template
    name: "SRAM Usage"
    id: sram_usage
    icon: mdi:memory
    unit_of_measurement: "KB"
    device_class: data_size
    state_class: measurement
    accuracy_decimals: 1
    update_interval: 10s
    lambda: |-
      // Total SRAM size for ESP32-S3 = 512KB
      const size_t total_sram = 512 * 1024;
      size_t free_sram = heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
      size_t used_sram = total_sram - free_sram;
      return used_sram / 1024.0; // Return used memory in KB
    on_value:
      then:
        - lvgl.bar.update:
            id: sram_memory_bar
            value: !lambda |-
              const size_t total_sram = 512 * 1024; // 512KB for ESP32-S3
              size_t free_sram = heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
              size_t used_sram = total_sram - free_sram;
              return (int)(((double)used_sram / total_sram) * 100);
        - lvgl.label.update:
            id: sram_memory_label
            text: !lambda |-
              const size_t total_sram = 512 * 1024;
              size_t free_sram = heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
              size_t used_sram = total_sram - free_sram;
              static char sram_buf[32];
              snprintf(sram_buf, sizeof(sram_buf), "%.1f/%.0f KB", 
                      used_sram/1024.0, total_sram/1024.0);
              return sram_buf;

  # 2. PSRAM Usage sensor for ESP32-P4 (32MB)
  - platform: template
    name: "PSRAM Usage"
    id: psram_usage
    icon: mdi:memory
    unit_of_measurement: "MB"
    device_class: data_size
    state_class: measurement
    accuracy_decimals: 1
    update_interval: 10s
    lambda: |-
      // Total PSRAM size for ESP32-P4 = 32MB
      const size_t total_psram = 32 * 1024 * 1024;
      size_t free_psram = heap_caps_get_free_size(MALLOC_CAP_SPIRAM);
      
      // If PSRAM is not available, return 0
      if (heap_caps_get_total_size(MALLOC_CAP_SPIRAM) == 0) {
        return 0.0;
      }
      
      size_t used_psram = total_psram - free_psram;
      return used_psram / (1024.0 * 1024.0); // Return used memory in MB
    on_value:
      then:
        - lvgl.bar.update:
            id: psram_memory_bar
            value: !lambda |-
              const size_t total_psram = 32 * 1024 * 1024; // 32MB for ESP32-P4
              size_t free_psram = heap_caps_get_free_size(MALLOC_CAP_SPIRAM);
              
              if (heap_caps_get_total_size(MALLOC_CAP_SPIRAM) == 0) return 0;
              
              size_t used_psram = total_psram - free_psram;
              return (int)(((double)used_psram / total_psram) * 100);
        - lvgl.label.update:
            id: psram_memory_label
            text: !lambda |-
              const size_t total_psram = 32 * 1024 * 1024;
              size_t free_psram = heap_caps_get_free_size(MALLOC_CAP_SPIRAM);
              static char psram_buf[32];
              
              if (heap_caps_get_total_size(MALLOC_CAP_SPIRAM) == 0) {
                snprintf(psram_buf, sizeof(psram_buf), "No PSRAM");
              } else {
                size_t used_psram = total_psram - free_psram;
                snprintf(psram_buf, sizeof(psram_buf), "%.1f/%.0f MB", 
                        used_psram/(1024.0*1024.0), total_psram/(1024.0*1024.0));
              }
              return psram_buf;
        - lvgl.chart.set_next_value:
            id: sys_chart
            series_id: psram_series
            value: !lambda 'return (int)id(psram_usage).state;'


  - platform: internal_temperature
    name: "ESP32p4 Internal Temperature"
    id: esp32_temperature
    update_interval: 30s
    on_value:
      then:
        - lvgl.label.update:
            id: chip_temperature_label
            text:
              format: "%.1f°C"
              args: [id(esp32_temperature).state]

        - lvgl.label.update:
            id: chip_temperature32_label
            text:
              format: "%.1f°C"
              args: [id(esp32_temperature).state]

        - lvgl.chart.set_next_value:
            id: sys_chart
            series_id: temp32_series
            value: !lambda 'return (int)id(esp32_temperature).state;'

  - platform: wifi_signal
    name: "WiFi Signal"
    id: wifi_signal_db
    update_interval: 30s
    unit_of_measurement: "dBm"
    on_value:
      then:
        - lvgl.label.update:
            id: wifi_signal_label
            text:
              format: "%.0f dBm"
              args: [id(wifi_signal_db).state] 
        #- lvgl.chart.set_next_value:
            #id: sys_chart
            #series_id: wifi_series
            #value: !lambda 'return (int)id(wifi_signal_db).state;'   

  - platform: homeassistant
    name: "PRISE_FRIGO"
    id: frigo_power
    entity_id: sensor.prise_frigo_power
    unit_of_measurement: "W"
    on_value:
      then:
        #- lvgl.label.update:
            #id: frigo_energy_label
            #text:
              #format: "%.0f %%"
              #args: [x]

        - lvgl.chart.set_next_value:
            id: sys_chart
            series_id: frigo_power_series
            value: !lambda 'return (int)x;'                   
        - lvgl.label.update:
            id: frigo_power_label
            text:
              format: "%.0f W"
              args: [id(frigo_power).state]





text_sensor:

  - platform: template
    name: 'Last Restart'
    id: device_last_restart
    icon: mdi:clock
    entity_category: diagnostic
   

  #- platform: template
    #name: "Voice Assistant Status"
    #id: voice_status
    #update_interval: 5s
    #lambda: |-
      #if (id(esp32_microphone).is_running()) {
        #return {"Listening"};
      #} else {
        #return {"Idle"};
      #}

  - platform: template
    name: "Camera Status Info"
    id: camera_status_info
    internal: true
    update_interval: never  # Désactivé par défaut
    lambda: |-
      static char buf[100];
      snprintf(buf, sizeof(buf), "%dx%d | %s | Buffer: %d KB",
        id(tab5_cam).get_image_width(),
        id(tab5_cam).get_image_height(),
        id(tab5_cam).is_streaming() ? "STREAMING" : "IDLE",
        id(tab5_cam).get_image_size() / 1024);
      return {buf};

  - platform: homeassistant
    id: alarm_panel_sensor_state
    entity_id: ${alarm_panel_entity}
    on_value:
      then:

        - if:
            condition:
              lambda: 'return x == "disarmed";'
            then:
              - lvgl.widget.show: alarm_panel_button_home
              - lvgl.widget.show: alarm_panel_button_away
              - lvgl.widget.show: alarm_panel_button_night
              - lvgl.widget.show: alarm_panel_button_vacation             
              - lvgl.widget.hide: alarm_panel_button_disarmed

              - lvgl.label.update:
                  id: alarm_panel_status
                  text_color: color_steel_blue
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_blue
                  text: "${shield_disarm_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_blue

            else:
              - lvgl.label.update:
                  id: alarm_panel_status
                  text_color: color_crimson
              - lvgl.widget.hide: alarm_panel_button_home
              - lvgl.widget.hide: alarm_panel_button_away
              - lvgl.widget.hide: alarm_panel_button_night
              - lvgl.widget.hide: alarm_panel_button_vacation             
              - lvgl.widget.show: alarm_panel_button_disarmed

        - if:
            condition:
              lambda: 'return x == "arming";'
            then:
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_gray
                  text: "${shield_arming_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_gray

        - if:
            condition:
              lambda: 'return x == "armed_home";'
            then:
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_green
                  text: "${shield_home_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_green

        - if:
            condition:
              lambda: 'return x == "armed_away";'
            then:
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_green
                  text: "${shield_away_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_green

        - if:
            condition:
              lambda: 'return x == "armed_night";'
            then:
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_green
                  text: "${shield_night_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_green

        - if:
            condition:
              lambda: 'return x == "armed_vacation";'
            then:
              - lvgl.label.update:
                  id: alarm_panel_state_icon
                  text_color: color_green
                  text: "${shield_vacation_icon}"
              - lvgl.obj.update:
                  id: alarm_panel_state_icon_bg
                  bg_color: color_green


  - platform: homeassistant
    id: alarm_panel_sensor_name
    entity_id: ${alarm_panel_entity}
    attribute: friendly_name
    on_value:
      then:
        - lvgl.label.update:
            id: alarm_panel_label_name
            text: !lambda return x; 






  - platform: homeassistant
    id: weather_state
    entity_id: weather.forecast_maison
    on_value:
      then:
        - script.execute: update_weather_display










      
          
  - platform: homeassistant
    id: sun_state
    entity_id: sun.sun



switch:


  #- platform: template
    #name: "RTSP Server"
    #id: rtsp_enable_switch
    #restore_mode: RESTORE_DEFAULT_OFF
    #optimistic: true
    #turn_on_action:
      #- lambda: |-
          #// Désactiver lvgl_camera_display d'abord
          #auto *lvgl_disp = id(camera_display);
          #if (lvgl_disp != nullptr) {
            #lvgl_disp->set_enabled(false);
          #}
          #// Activer rtsp_server
          #auto *rtsp = id(rtsp_srv);
          #if (rtsp != nullptr) {
            #rtsp->set_enabled(true);
          #}
    #turn_off_action:
      #- lambda: |-
          #auto *rtsp = id(rtsp_srv);
          #if (rtsp != nullptr) {
            #rtsp->set_enabled(false);
          #}

  #- platform: template
    #name: "Camera Web Server"
    #id: web_camera_enable_switch
    #restore_mode: RESTORE_DEFAULT_OFF  # OFF au démarrage
    #optimistic: true
    #turn_on_action:
      #- lambda: |-
          #auto *web_cam = id(web_cam_srv);
          #if (web_cam != nullptr) {
            #web_cam->set_enabled(true);
          #}
    #turn_off_action:
      #- lambda: |-
          #auto *web_cam = id(web_cam_srv);
          #if (web_cam != nullptr) {
            #web_cam->set_enabled(false);
          #}  

  - platform: network_camera
    name: "Camera 1"
    camera_id: security_cam_1
    id: camera_1_switch  



  - platform: template
    name: "LVGL Camera Display"
    id: lvgl_display_enable_switch
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    turn_on_action:
      - lambda: |-
          auto *lvgl_disp = id(camera_display);  
          if (lvgl_disp != nullptr) {
            lvgl_disp->set_enabled(true);
          }
    turn_off_action:
      - lambda: |-
          auto *lvgl_disp = id(camera_display);  
          if (lvgl_disp != nullptr) {
            lvgl_disp->set_enabled(false);
          }
  #- platform: template
    #id: lvgl_display_enable_switch
    #name: "LVGL Camera Display"
    #turn_on_action:
      #- lambda: |-
          #// Configure canvas FIRST (LVGL is ready, user activated)
          #auto canvas = id(camera_canvas);
          #auto *lvgl_disp = id(camera_display);
          #if (canvas != nullptr && lvgl_disp != nullptr) {
            #lvgl_disp->configure_canvas(canvas);
          #}
          #// THEN enable camera timer
          #lvgl_disp->set_enabled(true);

  - platform: gpio
    pin: GPIO53 
    name: "Audio Amplifier"
    id: audio_amplifier
    restore_mode: ALWAYS_OFF 

globals:

  - id: speed_value
    type: int
    initial_value: "0"

  - id: va_is_listening
    type: bool
    initial_value: "false"
  # Audio samples for chart display
  - id: audio_sample_left
    type: int
    initial_value: "0"
  - id: audio_sample_right
    type: int
    initial_value: "0" 

  - id: nfs_speed
    type: int
    initial_value: "0"
  - id: nfs_rpm
    type: int
    initial_value: "800"
  - id: nfs_gear
    type: int
    initial_value: "1"
  - id: nfs_accelerating
    type: bool
    initial_value: "true"  
  - id: scatter_angle
    type: float
    initial_value: "0"
  - id: ecg_counter
    type: int
    initial_value: "0"
  - id: bar_value
    type: int
    initial_value: "200"
  - id: faded_value
    type: int
    initial_value: "50"

  - id: cam1_state
    type: bool
    initial_value: 'false'

  - id: sleep_display_start
    type: uint32_t
    initial_value: '0'  
  # Etat de verrouillage de l'ecran
  - id: display_lock
    type: bool
    initial_value: 'false'

  # Timestamp de debut du timeout sur face_unlock_page
  - id: unlock_timeout_start
    type: uint32_t
    initial_value: '0'

  # Duree du timeout sur face_unlock_page (en secondes)
  - id: face_unlock_timeout_sec
    type: int
    initial_value: '145'

  - id: is_minimized
    type: bool
    restore_value: no
    initial_value: 'true'

  - id: current_image_index
    type: int
    initial_value: '1'

  - id: max_images
    type: int
    initial_value: '8'
  - id: slideshow_active
    type: bool
    initial_value: 'false'  # Démarre en pause

  - id: slideshow_delay
    type: int
    initial_value: '5000'   # en ms (5s)

  - id: alarm_panel_pending_action
    type: std::string
    restore_value: no
    initial_value: ""


  - id: current_radio_station
    type: int
    restore_value: true
    initial_value: '0'  # Commence avec Fun Radio (0=Fun, 1=Skyrock, 2=Sud, 3=RTL2)  

  - id: display_timeout
    type: int
    restore_value: true
    initial_value: "2"

  - id: global_is_assisting
    type: bool
    restore_value: false  

  - id: timer_running
    type: bool
    restore_value: no
    initial_value: 'false' # Indique si le timer est en cours d'exécution    

  - id: timer_started
    type: bool
    restore_value: no
    initial_value: "false"
  
  - id: is_alarm_active
    type: bool
    initial_value: 'false'

  - id: is_timer_finished
    type: bool
    initial_value: 'false'

  - id: timer_active
    type: bool
    initial_value: 'false'

  - id: wifi_connection
    type: bool
    restore_value: no
    initial_value: "false"

  - id: api_connection
    type: bool
    restore_value: no
    initial_value: "false"

  - id: ota_active
    type: bool
    initial_value: 'false'

  - id: mic_muted
    type: bool
    restore_value: no
    initial_value: 'false'

  - id: init_in_progress
    type: bool
    restore_value: false
    initial_value: "true"

  - id: auto_off_timer_active
    type: bool
    initial_value: 'false'
    

  - id: countdown_time
    type: int
    restore_value: no
    initial_value: '0'
  - id: total_timer_time
    type: int
    restore_value: no
    initial_value: '0'    

  - id: current_pin
    type: std::string
    initial_value: ""   

  - id: current_track_id
    type: int
    initial_value: '0'
  - id: is_playing
    type: bool
    initial_value: 'false'
  - id: volume_level
    type: int
    initial_value: '50'
  - id: track_count
    type: int
    initial_value: '0'  

  - id: show_playlist
    type: bool
    initial_value: 'false'
  - id: current_time
    type: int
    initial_value: '0'
  - id: total_time
    type: int
    initial_value: '180'  

  - id: current_radio_track_id
    type: int
    initial_value: '-1'
    
  - id: current_music_track_id
    type: int
    initial_value: '-1' 

  - id: current_volume
    type: float  
    initial_value: '0.5'
  - id: is_muted
    type: bool
    initial_value: 'false'
  - id: volume_before_mute
    type: float
    initial_value: '0.5'
  # Nouveau global pour empêcher le sleep pendant les interactions
  - id: touch_active
    type: bool
    initial_value: 'false'

  - id: idle_delay_seconds
    type: int
    initial_value: '300' 

  - id: s_saver_visible
    type: bool
    restore_value: no
    initial_value: "false"   

  - id: repeat_modes
    type: std::vector<std::string>
    initial_value: '{"all", "one", "off"}'
  - id: repeat_icons
    type: std::vector<std::string>
    initial_value: '{"${repeat_all_icon}", "${repeat_one_icon}", "${repeat_off_icon}"}'
  - id: current_repeat_mode_idx
    type: int
    initial_value: '0'
  - id: tmp_repeat_mode
    type: std::string
    restore_value: no
    initial_value: '"all"'
  - id: tmp_repeat_icon
    type: std::string
    restore_value: no
    initial_value: '"${repeat_all_icon}"'
  - id: cover_url
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: duration_slider_user_interaction
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: slider_position
    type: float
    restore_value: no
    initial_value: '0.5'
  - id: pending_cover_url
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: pending_repeat_value
    type: std::string
    restore_value: no
    initial_value: '""'

  - id: camera_streaming_active
    type: bool
    restore_value: no
    initial_value: 'false' 


color:

  - id: color_sky_blue
    hex: 3FA7F3
  - id: color_slate_blue_gray
    hex: 343645
  - id: color_steel_blue
    hex: 606682
  - id: color_misty_blue
    hex: 9BA2BC
  - id: color_black
    hex: 0d0d0d
  - id: color_dark_gray
    hex: 333333
  - id: color_gray
    hex: 666666
  - id: color_light_gray
    hex: 999999
  - id: color_white
    hex: f2f0eb
  - id: color_red
    hex: ff0000
  - id: color_crimson
    hex: f5075c
  - id: color_light_blue
    hex: 2fc0ff
  - id: color_blue
    hex: 4C9FFF
  - id: color_yellow
    hex: e7c12c
  - id: color_light_yellow
    hex: f0d45c
  - id: color_amber
    hex: f4a900
  - id: color_mint
    hex: 39d19c
  - id: color_light_mint
    hex: 66dcb3
  - id: color_light_green
    hex: 00ff00
  - id: color_green
    hex: 5CA848
  - id: color_orange
    hex: f07c40
  - id: color_deep_orange
    hex: ff6600
  - id: color_violet
    hex: 926BC7
  - id: color_dark_blue
    hex: 4867aa
  - id: color_deep_purple
    hex: 543D72  



  - id: color_nova
    hex: 93A4EC

  - id: color_navy
    hex: aad6ec

  - id: color_cyan
    hex: 00FFFF  
  - id: color_magenta
    hex: FF00FF  

  - id: color_aqua
    hex: "00ffff"          

  # Nova Colors
  - id: nova_color # pink
    hex: "e38de3"
  - id: pri_color # light (mantle)
    hex: "24273a"
  - id: sec_color # dark (crust)
    hex: "181926"
  - id: text_color
    hex: "cad3f5"
  - id: off_color
    hex: "5b6078"


  - id: blue_color
    hex: "6b93e3"
  - id: green_color
    hex: "a6da95"
  - id: yellow_color
    hex: "ffd17a"
  - id: orange_color
    hex: "e0752b"
  - id: red_color
    hex: "de455c"  

  - id: lcars_space_white
    hex: "f5f6fa"
  - id: lcars_violet_creme
    hex: "ddbbff"
  - id: lcars_green
    hex: "33cc99"
  - id: lcars_magenta
    hex: "cc4499"
  - id: lcars_blue
    hex: "4455ff"
  - id: lcars_yellow
    hex: "ffcc33"
  - id: lcars_violet
    hex: "9944ff"
  - id: lcars_orange
    hex: "ff7700"
  - id: lcars_african_violet
    hex: "cc88ff"
  - id: lcars_text_purple
    hex: "cc77ff"
  - id: lcars_red
    hex: "dd4444"
  - id: lcars_emerald
    hex: "00bb00"
  - id: lcars_crimson
    hex: "cc0000"
  - id: lcars_navy_gray
    hex: "2C374B"
  - id: lcars_slate_gray
    hex: "6E748C"
  - id: lcars_teal
    hex: "2A7092"
  - id: lcars_coral
    hex: "FA6851"
  - id: lcars_charcoal
    hex: "51596C"

  - id: color_primary
    hex: '4A90E2'
  - id: color_secondary
    hex: '2ECC71'
  - id: color_text
    hex: 'FFFFFF'
  - id: color_background
    hex: '1A1A1A'
  - id: color_inactive
    hex: '666666'  

  - id: active_timer_color
    hex: "26ed3a"
  - id: paused_timer_color
    hex: "3b89e3"
  - id: active_ota_color
    hex: "ffff00"
  - id: active_mute_color
    hex: "ff0000"



font:



  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
      italic: true
    id: font_request
    size: 15
    glyphsets:
      - ${font_glyphsets}
  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: font_response
    size: 15
    glyphsets:
      - ${font_glyphsets}

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_16
    size: 16
    glyphsets:
      - ${font_glyphsets}

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_18
    size: 18
    glyphsets:
      - ${font_glyphsets}   


  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_20
    size: 20
    glyphsets:
      - ${font_glyphsets} 

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_23
    size: 23
    glyphsets:
      - ${font_glyphsets}  


  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_26
    size: 26
    glyphsets:
      - ${font_glyphsets}   

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_28
    size: 28
    glyphsets:
      - ${font_glyphsets}  

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_32
    size: 32
    glyphsets:
      - ${font_glyphsets}                      

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_24
    size: 24
    glyphsets:
      - ${font_glyphsets}           

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_36
    size: 36
    glyphsets:
      - ${font_glyphsets} 

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_42
    size: 42
    glyphsets:
      - ${font_glyphsets}                   

  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: nunito_60
    size: 60
    glyphsets:
      - ${font_glyphsets}      
  - file:
      type: gfonts
      family: ${font_family}
      weight: 300
    id: font_timer
    size: 30
    glyphsets:
      - ${font_glyphsets} 

  - file: "https://github.com/BigBobbas/ESP32-S3-Box3-Custom-ESPHome/raw/main/fonts/materialdesignicons-webfont.ttf"
    id: mdi46
    size: 46
    bpp: 4
    glyphs: [
      "\U000F0BC4",#alarm away
      "\U000F0384",#music
      "\U000F07C5",#sound
      "\U000F1322",#tools
      "\U000F07AE",#cctv
      "\U000F0493",#settings cog
      "\U000F05CB",#voice
      "\U000F0502",#screen settings
      "\U000F1C6F",#info
      "\U000F0521",#scr 
      "\U000F04B2",#sleep
      "\U000F1110",#s_saver
      "\U000F0D90",#screen off
      "\U000F009E",#bell
      "\U000F04DB",#stop
      "\U000F18DD",#light_mut
      "\U000F062C",#source
      "\U000F10FE",#kubernetes
      "\U000F02A4",#github
      "\U000F06B2",#angular
      "\U000F0439",#radio
      "\U000F0BB1",#next
      "\U000F036B",#videocall
      "\U000F1A13",#heure
      "\U000F0F30",#meteo
      "\U000F1923",#timer
      "\U000F056E",#dashboard
      "\U000F07DC",#micro-sd
      "\U000F0CB8",#music_play
      "\U000F08D6",#settings
      "\U000F0565",#arming
      "\U000F050F",#temp sensor
      "\U000F0150",#clock
      "\U000F081A",#door
      "\U000F06D9",#garage
      "\U000F1A8B",#shutter
      "\U000F02E9",#Gallery
      "\U000F0C7B",#recognition
      "\U000F057C",#vlc
      "\U000F05C3",#youtube
      "\U000F18DE",#light
      "\U000F0675",#application
      
      ]

  - file: "https://github.com/BigBobbas/ESP32-S3-Box3-Custom-ESPHome/raw/main/fonts/materialdesignicons-webfont.ttf"
    id: mdi36
    size: 36
    bpp: 4
    glyphs: [
      "\U000F0BC4",#alarm away
      "\U000F0384",#music
      "\U000F07C5",#sound
      "\U000F1322",#tools
      "\U000F07AE",#cctv
      "\U000F0493",#settings cog
      "\U000F05CB",#voice
      "\U000F0502",#screen settings
      "\U000F1C6F",#info
      "\U000F0521",#scr 
      "\U000F04B2",#sleep
      "\U000F1110",#s_saver
      "\U000F0D90",#screen off
      "\U000F009E",#bell
      "\U000F04DB",#stop
      "\U000F18DD",#light_mut
      "\U000F062C",#source
      "\U000F10FE",#kubernetes
      "\U000F02A4",#github
      "\U000F06B2",#angular
      "\U000F0439",#radio
      "\U000F0BB1",#next
      "\U000F036B",#videocall
      "\U000F1A13",#heure
      "\U000F0F30",#meteo
      "\U000F1923",#timer
      "\U000F056E",#dashboard
      "\U000F07DC",#micro-sd
      "\U000F0CB8",#music_play
      "\U000F08D6",#settings
      "\U000F0565",#arming
      "\U000F050F",#temp sensor
      "\U000F0150",#clock
      "\U000F081A",#door
      "\U000F06D9",#garage
      "\U000F1A8B",#shutter
      "\U000F02E9",#Gallery
      "\U000F0C7B",#recognition
      "\U000F057C",#vlc
      "\U000F05C3",#youtube
      "\U000F18DE",#light
      "\U000F0675",#application
      "\U000F00DF"

      
      ]      

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_24
    size: 24
    bpp: 4
    glyphs: [
      "\U000F068A", # shield home
      "\U000F1828", # shield moon
      "\U000F099D", # shield lock
      "\U000F06BB", # shield plane
      "\U000F099E", # shield off
      "\U000F0498", # shield
    ]

  - file: "fonts/Icons.ttf"
    id: icons_32
    size: 32
    bpp: 4
    glyphs: [
      "\U0000e900",
      "\U0000e901",
      "\U0000e902",
      "\U0000e903",
      "\U0000e904",
      "\U0000e905",
      "\U0000e906",
      "\U0000e907",
      "\U0000e908",
      "\U0000e909",
      "\U0000e90a",
      "\U0000e90b",
      "\U0000e90c",
      "\U0000e90d",
      "\U0000e90e",
      "\U0000e90f",
      "\U0000e910",
      "\U0000e911",
      "\U0000e912",
      "\U0000e913",
      "\U0000e914",
      "\U0000e915",
      "\U0000e916",
      "\U0000e917",
      "\U0000e918",
      "\U0000e919",

    ]
  - file: "fonts/Icons.ttf"
    id: icons_36
    size: 36
    bpp: 4
    glyphs: [
      "\U0000e900",
      "\U0000e901",
      "\U0000e902",
      "\U0000e903",
      "\U0000e904",
      "\U0000e905",
      "\U0000e906",
      "\U0000e907",
      "\U0000e908",
      "\U0000e909",
      "\U0000e90a",
      "\U0000e90b",
      "\U0000e90c",
      "\U0000e90d",
      "\U0000e90e",
      "\U0000e90f",
      "\U0000e910",
      "\U0000e911",
      "\U0000e912",
      "\U0000e913",
      "\U0000e914",
      "\U0000e915",
      "\U0000e916",
      "\U0000e917",
      "\U0000e918",
      "\U0000e919",

      ]

  - file: "fonts/Icons.ttf"
    id: icons_29
    size: 29
    bpp: 4
    glyphs: [
      "\U0000e900",
      "\U0000e901",
      "\U0000e902",
      "\U0000e903",
      "\U0000e904",
      "\U0000e905",
      "\U0000e906",
      "\U0000e907",
      "\U0000e908",
      "\U0000e909",
      "\U0000e90a",
      "\U0000e90b",
      "\U0000e90c",
      "\U0000e90d",
      "\U0000e90e",
      "\U0000e90f",
      "\U0000e910",
      "\U0000e911",
      "\U0000e912",
      "\U0000e913",
      "\U0000e914",
      "\U0000e915",
      "\U0000e916",
      "\U0000e917",
      "\U0000e918",
      "\U0000e919",

      ]      


  - file: "fonts/icons_v2.ttf"
    id: icons_38
    size: 38
    bpp: 4
    glyphs: [
      "\U0000e909", # power
      "\U0000e90c", # back step
      "\U0000e90d", # forward step
      "\U0000e912", # repeat_all
      "\U0000e913", # repeat_off
      "\U0000e914", # repeat_one
      "\U0000e90a", # play
      "\U0000e90b", # pause
      "\U0000e91c", # stop
      "\U0000e923", # locate
      "\U0000e924", # docked
      "\U0000e915",#spotlight_group_icon
    ]

  - file: "fonts/icons_v2.ttf"
    id: icons_48
    size: 48
    bpp: 4
    glyphs: [
      "\U0000e90a", # play
      "\U0000e90b", # pause
      "\U0000e91f", # arrow_up
      "\U0000e920", # arrow_down
      "\U0000e91c", # stop
      "\U0000e923", # locate
      "\U0000e924", # docked
      "\U0000e93b", # air_conditioner 
      "\U0000e936", # heating

    ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_media
    size: 60 #50
    bpp: 8
    glyphs: [
      "\U000F040A", # mdi-media_play
      "\U000F03E4", # mdi-media_pause
      "\U000F04AE", # mdi-media_previous_track
      "\U000F04AD", # mdi-media_next_track 
      "\U000F040E", # mdi-media_play_pause
      "\U000F0662", # skip-next-circle-outline
      "\U000F0664", # skip-previous-circle-outline
      "\U000F0453", # refresh
      "\U000F03E3", # pause
      "\U000F050F",#temp sensor
      "\U000F024A",#garden/flower
      "\U000F0EBA",#stats
      "\U000F1C6F",#info
      "\U000F075A",#music
      "\U000F036F",#voice settings
      "\U000F0502",#screen settings
      "\U000F08D6",#settings
      "\U000F068A",#alarm home
      "\U000F0BC4",#alarm away
      "\U000F1828",#armed night
      "\U000F099E",#disarmed
      "\U000F0565",#arming
      "\U000F1A12",#home 
      "\U000F058E",#humidity         
      "\U000F0590",#weather
      "\U000F07AE",#cctv
      "\U000F1322",#tools
      "\U000F0493",#settings cog
      "\U000F0521",#toggle on
      "\U000F0439",#radio_active
      "\U000F0CB8",#music_play
      "\U000F1A13",#heure
      "\U000F0F30",#meteo
      "\U000F1923",#timer
      "\U000F02A4",#github
      "\U000F062C",#source
      "\U000F18DD",#light_mut
      "\U000F056E",#dashboard
      "\U000F07DC",#micro-sd
      "\U000F0150",#clock
      "\U000F0384",#music-box
      "\U000F035C",#menu
      "\U000F075D",#volume-plus
      "\U000F075E",#volume-minus
      "\U000F0581",#volume-off
      "\U000F1AE1",#timer_play
      "\U000F02E9",#Gallery
      "\U000F07D1",#home-automation
      "\U000F18DE",#ceiling-light-multiple-outline
      "\U000F0450",# Icône rafraîchir
      "\U000F061A", # illumination (lux)

                      

      ]    

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_40
    size: 40
    bpp: 4
    glyphs: [
      "\U000F068A", # shield home
      "\U000F1828", # shield moon
      "\U000F099D", # shield lock
      "\U000F06BB", # shield plane
      "\U000F099E", # shield off
      "\U000F0498", # shield
    ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_32
    size: 32
    bpp: 4
    glyphs: [
      "\U000F068A", # shield home
      "\U000F1828", # shield moon
      "\U000F099D", # shield lock
      "\U000F06BB", # shield plane
      "\U000F099E", # shield off
      "\U000F0498", # shield
      "\U000F09A0", # code pin
      "\U000F0644", # Reconnaissance Facial
    ]
    
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_52
    size: 52
    bpp: 4
    glyphs: [
      "\U000F068A", # shield home
      "\U000F1828", # shield moon
      "\U000F099D", # shield lock
      "\U000F06BB", # shield plane
      "\U000F099E", # shield off
      "\U000F0498", # shield
      "\U000F0826", # home
      "\U000F1A46", # away
    ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_68
    size: 68
    bpp: 4
    glyphs: [
      "\U000F068A", # shield home
      "\U000F1828", # shield moon
      "\U000F099D", # shield lock
      "\U000F06BB", # shield plane
      "\U000F099E", # shield off
      "\U000F0498", # shield
    ]             

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: mdi_35
    size: 35 #50
    bpp: 8
    glyphs: [
      "\U000F061A", # chip

      ] 
  - file: "fonts/icons_v2.ttf"
    id: icons_28
    size: 28
    bpp: 4
    glyphs: [
      "\U0000e902", # exit
      "\U0000e926", # fan
      "\U0000e927", # room_plan
      "\U0000e938", # humidity 
      "\U0000e937", # co2
      "\U0000e93a", # air quality (tvoc)
      "\U0000e939", # temperature 
      "\U0000e92f", # illumination (lux)

    ]



  - file: "gfonts://Roboto"
    id: roboto_32
    size: 32

  - file: "gfonts://Roboto"
    id: roboto_36
    size: 36    
  - file: "gfonts://Roboto"
    id: roboto_42
    size: 42      
  - file: "gfonts://Roboto"
    id: roboto_48
    size: 48       

  - file: "gfonts://Roboto"
    id: roboto_60
    size: 60        

  - file: "gfonts://Roboto"
    id: roboto_30
    size: 30

  - file: "gfonts://Roboto"
    id: roboto_26
    size: 26

  - file: "gfonts://Roboto"
    id: roboto_24
    size: 24    

  - file: "gfonts://Roboto"
    id: roboto_20
    size: 20

  - file: "gfonts://Roboto"
    id: roboto_18
    size: 18    
  
  - file: "gfonts://Roboto"
    id: roboto_16
    size: 16
    
  - file: "gfonts://Roboto"
    id: roboto_14
    size: 14
  - file: "gfonts://Roboto"
    id: roboto_12
    size: 12
  - file: "gfonts://Roboto"
    id: roboto_10
    size: 10   




image:

  defaults:
    byte_order: little_endian
    transparency: alpha_channel
    type: rgb565
  images:

                
  #- file: http://192.168.1.158:8080/iryQdAwo/cheon.jpg                             
    #id: testone
    #resize: 1280x720

  #- file: "/img/anuvious.jpg"    
    #id: test
    #resize: 1280x720
    
  #- file:
      #source: sd_card
      #path: "img/anuvious.jpg"
    #id: test
    #resize: 1280x720

  #- file: http://192.168.1.158:8080/ZAPTjwuz/simulation.jpg                  
    #id: wallpaper
    #resize: 1280x720    




touchscreen:
  - platform: gt911
    id: touch
    i2c_id: bsp_bus
    reset_pin: GPIO23
    update_interval: 50ms   # polling (pas d'interruption)
    on_touch:
      - lambda: |-
          ESP_LOGD("touchscreen", "Touch detected at (%d, %d)", touch.x, touch.y);
      - light.turn_on: backlight           
    transform:
      swap_xy: false
      mirror_x: false
      mirror_y: false



output:
  - platform: ledc
    pin: GPIO32
    id: backlight_pwm
    frequency: 1000Hz
    inverted: true


light:
  - platform: monochromatic
    output: backlight_pwm
    name: "Display Backlight"
    id: backlight
    restore_mode: RESTORE_DEFAULT_ON
    default_transition_length: 250ms


display:
  - platform: mipi_dsi
    id: main_display
    model: WAVESHARE-ESP32-P4-WIFI6-TOUCH-LCD-7B
    reset_pin:
      number: 33
    rotation: 180
    update_interval: never
    auto_clear_enabled: false
    dimensions:
      width: 1024
      height: 600



lvgl:
  use_ppa: true
  byte_order: little_endian
  displays:
    - main_display
  touchscreens:
    - touch

  on_idle:
    - timeout: !lambda |-
        int timeout = id(auto_off).state;
        return (timeout == -1) ? 86400000 : (timeout * 1000);
      then:
        - lambda: |-
            static bool canvas_configured = false;
            if (!canvas_configured) {
              auto canvas = id(camera_canvas);
              if (canvas != nullptr) {
                id(camera_display).configure_canvas(canvas);
                canvas_configured = true;
                ESP_LOGI("lvgl", "Canvas configuré pour caméra 640x480");
              }
            }

    ### Auto-Lock (indépendant de Screen Off)
    #- timeout: !lambda |-
        #int timeout = id(face_unlock_timeout_sec);
        #return (timeout == -1) ? 86400000 : (timeout * 1000);
      #then:
        - if:
            condition:
              and:
                - lambda: 'return id(face_unlock_timeout_sec) > 0;'
                - lambda: 'return !id(display_lock);'
            then:
              - lambda: |-
                  id(display_lock) = true;
                  ESP_LOGI("lock", "🔒 Auto-Lock après inactivité");
              - lvgl.page.show: page_sleep
              - light.turn_on: backlight

              #- delay: 40s
              #- light.turn_off: backlight
              #- lvgl.page.show: page_sleep
 





  style_definitions:
    - id: page_content
      bg_color: 0x000000
      width: 100%
      height: 100%
      pad_all: 0
      pad_row: 0
      pad_column: 0


    - id: button_style
      bg_color: 0x000000 #black
      bg_grad_color: 0x005782 #blue
      bg_grad_dir: VER
      bg_opa: COVER
      border_color: 0x000000
      border_width: 1
      text_color: 0xFFFFFF
      ############## ADD SHADOW
      shadow_color: 0xFFFFFF
      shadow_width: 20
      shadow_offset_x: 0
      shadow_offset_y: 0
      shadow_opa: 50%
      radius: 40
      
    - id: button_pressed_style
      bg_color: 0x666666 #grey
      bg_grad_color: 0x00334d #dark blue
      ############## ADD SHADOW
      shadow_color: 0xFFFFFF
      shadow_width: 20
      shadow_offset_x: 0
      shadow_offset_y: 0
      shadow_opa: 50%
      radius: 40
      
    - id: button_checked_style
      bg_color: 0x000000 #black
      bg_grad_color: 0x002233 #darker blue
      bg_grad_dir: VER
      text_color: yellow
      ############## ADD SHADOW
      shadow_color: 0xFFFFFF
      shadow_width: 20
      shadow_offset_x: 0
      shadow_offset_y: 0
      shadow_opa: 50%
      radius: 40
      
    - id: button_standard_style
      bg_color: 0x2F8CD8
      bg_grad_color: 0x005782
      shadow_width: 0

    - id: round_mask
      radius: 50%  # Crée un cercle parfait
      clip_corner: true


    - id: menu_button
      radius: 40      
      #text_font: nunito_20
      text_align: CENTER
      bg_color: 0x2F8CD8
      bg_grad_color: 0x0460BD
      bg_grad_dir: VER
      border_width: 5
      border_color: 0x1e84eb
      border_opa: 70%
      outline_width: 1
    - id: time_style
      text_color: 0xD5D5D5
      bg_opa: TRANSP
      radius: 5
      border_color: 0xE9E9E9
      border_width: 0
      border_opa: 50%
      pad_all: 0
      shadow_width: 0
      shadow_opa: TRANSP
    - id: card
      text_color: 0xD5D5D5
      bg_color: 0x222222
      bg_opa: COVER
      radius: 20
      outline_width: 0
      border_width: 0
      #border_opa:
      pad_all: 0 
    - id: weather_style
      text_color: 0xD5D5D5
      bg_color: 0
      bg_opa: TRANSP
      outline_width: 0
      border_width: 0
      #border_opa:
      radius: 0
      pad_all: 0
    - id: meter_style
      text_color: 0xD5D5D5
      bg_color: 0x222222
      bg_opa: COVER
      radius: 10
      outline_width: 0
      border_width: 0
      #border_opa:
      pad_all: 0      
    - id: button_light
      bg_color: 0xCCCCCC
      bg_grad_color: 0xFF4400
      bg_grad_dir: HOR
      border_width: 8
      border_color: 0x222222
      border_opa: 50%
      outline_width: 1
    - id: button_menu
      text_color: 0xD5D5D5
      bg_color: 0x222222
      bg_opa: COVER
      radius: 20
      pad_all: 5
    - id: button_checked
      bg_color: 0xFF4400
      bg_opa: COVER
      text_color: 0xD5D5D5
      radius: 20
      pad_all: 5 
    - id: sound_page
      bg_opa: TRANSP
      border_opa: TRANSP
      radius: 0
      text_color: 0xCCCCCC  # Gris clair pour le texte
      width: 100%
      height: 100%


    - id: home_page
      bg_opa: TRANSP
      border_opa: TRANSP
      radius: 0
      text_color: 0xFFFFFF
      width: 100%
      height: 100%

    - id: controls_page
      bg_opa: TRANSP
      border_opa: TRANSP
      radius: 0
      text_color: 0xFFFFFF
      width: 100%
      height: 100%  

    - id: main_content
      bg_opa: TRANSP
      border_opa: TRANSP
      radius: 0
      text_color: 0xFFFFFF
      width: 100%
      height: 100%

    - id: f1_page
      bg_opa: TRANSP
      border_opa: TRANSP
      radius: 0
      text_color: 0xFFFFFF
      width: 100%
      height: 100%

    - id: style_line
      line_color: 0x0000FF
      line_width: 8
      line_rounded: true
    - id: date_style
      #text_font: nunito_24
      align: center
      text_color: 0x333333
      bg_opa: cover
      radius: 4
      pad_all: 2

        ####Header_Footer##########
    - id: header_footer
      bg_color: 0x2F8CD8
      bg_grad_color: 0x005782
      bg_grad_dir: VER
      bg_opa: COVER
      border_width: 0
      radius: 0
      pad_all: 0
      pad_row: 0
      pad_column: 0
      border_color: 0x0077b3
      text_color: 0xFFFFFF
      width: 100%
      height: 30

    - id: music_style
      text_font: montserrat_16
      text_color: 0x504d6d
      bg_opa: TRANSP
    
    - id: title_style
      text_font: montserrat_14
      text_color: 0x101010
      bg_opa: TRANSP
    
    - id: btn_round_style
      radius: 10
      bg_opa: COVER
    
    - id: spectrum_style
      bg_opa: TRANSP
      border_width: 0     

    - id: style_bg_dark
      bg_color: 0x1a1a1a
      bg_opa: COVER
      border_width: 0
      radius: 0
      
    - id: style_card
      bg_color: 0x2d2d2d
      bg_opa: COVER
      border_width: 0
      radius: 15
      pad_all: 20
      
    - id: style_header
      bg_color: 0x000000
      bg_opa: COVER
      border_width: 0
      radius: 0
      pad_all: 0
      
    - id: style_button
      bg_color: 0x444444
      bg_opa: COVER
      border_width: 0
      radius: 25
      pad_all: 0


  pages:
      - id: page_home
        bg_color: color_black
        on_load:
          then:
            - lvgl.image.update:
                id: update_wallpaper
                src: peaceful
            - script.execute: update_weather_display  
            
        widgets:        
          # Fond d'écran sombre
          - obj:
              id: background
              width: 1024
              height: 600
              x: 0
              y: 0
              #bg_color: color_black
              bg_opa: TRANSP
              border_width: 0
              radius: 0           
          # Section Living Room
          #- label:
              #x: 37
              #y: 47
              #text: "FOLDER"
              #text_color: color_black

                     
          - image:
              
              id: update_wallpaper
              src: peaceful
              width: 1024
              height: 600
              ##x: 0
              ##y: 0  

          - obj:
              id: weather_steel
              x: 30
              y: 30
              width: 258
              height: 120
              pad_all: 0
              align: TOP_LEFT
              bg_color: color_steel_blue
              border_opa: TRANSP
              border_width: 0
              shadow_opa: TRANSP
              radius: 15
              widgets:
                - lottie:
                    id: weather_sunny
                    src: "/sdcard/weather/clear-day.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100

                - lottie:
                    id: weather_falling_stars
                    src: "/sdcard/weather/falling-stars.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100   

                - lottie:
                    id: weather_clear_night
                    src: "/sdcard/weather/clear-night.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100  

                - lottie:
                    id: weather_rainy
                    src: "/sdcard/weather/extreme.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100   

                - lottie:
                    id: weather_lightning
                    src: "/sdcard/weather/thunderstorms-night-extreme-rain.json"
                    hidden: true
                    loop: true 
                    x: 30
                    y: 15
                    width: 100
                    height: 100
 
                - lottie:
                    id: weather_lightning_nigtht
                    src: "/sdcard/weather/thunderstorms-night.json"
                    hidden: true
                    loop: true 
                    x: 30
                    y: 15
                    width: 100
                    height: 100

                - lottie:
                    id: weather_lightning_rain
                    src: "/sdcard/weather/thunderstorms-rain.json"
                    hidden: true
                    loop: true 
                    x: 30
                    y: 15
                    width: 100
                    height: 100   

                - lottie:
                    id: weather_lightning_day_rain
                    src: "/sdcard/weather/thunderstorms-day-rain.json"
                    hidden: true
                    loop: true 
                    x: 30
                    y: 15
                    width: 100
                    height: 100                                        

                - lottie:
                    id: weather_cloudy
                    src: "/sdcard/weather/cloudy.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100   

                - lottie:
                    id: weather_cloudy_night
                    src: "/sdcard/weather/partly-cloudy-night.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100  

                - lottie:
                    id: weather_cloudy_night_rain
                    src: "/sdcard/weather/partly-cloudy-night-rain.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100  

                - lottie:
                    id: weather_cloudy_day_rain
                    src: "/sdcard/weather/partly-cloudy-day-rain.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100   

                - lottie:
                    id: weather_fog
                    src: "/sdcard/weather/fog.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100     

                - lottie:
                    id: weather_fog_day
                    src: "/sdcard/weather/fog-day.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100   

                - lottie:
                    id: weather_fog_night
                    src: "/sdcard/weather/fog-night.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100      

                - lottie:
                    id: weather_cloudy_day_fog
                    src: "/sdcard/weather/partly-cloudy-day-fog.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100                                                                              
         
                - lottie:
                    id: weather_overcast
                    src: "/sdcard/weather/overcast.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100  

                - lottie:
                    id: weather_overcast_day
                    src: "/sdcard/weather/overcast-day.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100  

                - lottie:
                    id: weather_overcast_night
                    src: "/sdcard/weather/overcast-night.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100   

                - lottie:
                    id: weather_hail
                    src: "/sdcard/weather/hail.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100   

                - lottie:
                    id: weather_snow
                    src: "/sdcard/weather/snow.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100

                - lottie:
                    id: weather_dust_wind
                    src: "/sdcard/weather/dust-wind.json"
                    hidden: true
                    x: 30
                    y: 15
                    width: 100
                    height: 100                                                             
                    

                - label:
                    id: weather_label
                    text: "Chargement..."
                    x: 15  
                    y: 5    # Centre le label dans son parent
                    #text_align: CENTER  # Centre le texte dans le label
                    text_color: 0xFFFFFF
                    text_font: montserrat_20  # Ou votre police préférée
        


                - label:
                    id: chart_temp_value
                    x: 184 #30
                    y: 30 #35
                    text: "--°c"
                    text_color: color_red
                    text_font: nunito_36
  

          #- lottie:
              #id: Showtime
              #src: "/sdcard/lottie/portal base.json"
              #file: "test_prod_lottie/falling-stars.json"
              #x: 6
              #y: 6
              #width: 100
              #height: 100                                               

          - chart:
              id: sys_chart
              x: 700
              y: 60
              width: 270
              height: 130
              type: BAR
              point_count: 4
              update_mode: SHIFT
              bg_color: 0x1a1a2e
              border_width: 1
              
              border_color: 0x333333
              div_line_count_hor: 0
              div_line_count_ver: 0
              items:
                #line_width: 8
                bg_opa: 80%
              axis_primary_y:
                min_value: 0
                max_value: 50
              series:
                - id: psram_series
                  color: color_deep_orange
                - id: frigo_power_series
                  color: color_crimson
                - id: temp32_series
                  color: color_light_yellow                  
          - label:
              id: chip_temperature32_label
              x: 710
              y: 65
              text: "--°C"
              text_color: color_red 
              text_font: roboto_24 

          - label:
              id: frigo_power_label
              x: 903
              y: 65
              text: "--W"
              text_color: color_light_yellow 
              text_font: roboto_24               

          #- canvas:
              #id: gif_canvas
              #width: 240
              #height: 132
              #x: 450
              #y: 64
              #bg_color: 0x1a1a2e  

          #- canvas:
              #id: gif_canvas2
              #width: 172
              #height: 148
              #x: 450
              #y: 64
              #bg_color: 0x1a1a2e                            
          #- image:
              #id: update_wallpaper2
              #src: cat
              #width: 1024
              #height: 600
              #x: 300
              #y: 64 

          #- label:
              #text: "HOME CONTROL"
              #x: 20
              #y: 15
              #text_color: 0xFFFFFF
              #text_font: roboto_32
              #text_align: LEFT

          - label:
              id: alarm_panel_status
              #align: CENTER
              x: 300
              y: 15
              text: "${shield_arming_icon}"
              text_color: color_blue
              text_font: mdi_icons_32   

          - label:
              id: date_label
              text: "Tuesday, Apr 23"
              x: 580
              y: 15
              text_align: CENTER
              text_color: 0xFFFFFF
              text_font: roboto_32
          - label:
              id: time_label
              text: "12:34"
              x: 900
              y: 15
              text_align: CENTER
              text_color: 0xFFFFFF
              text_font: roboto_32  

          - label:
              id: ha_status
              #align: CENTER
              x: 980
              y: 15
              text: "${ha}"
              text_color: color_blue
              text_font: icons_36  



          

          # Alarm panel status
          #- label:
              #id: alarm_panel_status
              
              #x: 1075
              #y: 15
              #text: "${shield_arming_icon}"
              #text_color: color_steel_blue
              #text_font: mdi_icons_40            

          # 3 GROS BOUTONS AU-DESSUS DE SECURITY CAMERAS
          # Bouton Settings
          - button:
              id: btn_settings
              width: 150
              height: 100
              x: 10
              y: 480
              bg_color: color_deep_orange
              bg_opa: COVER
              radius: 15
              on_click:      
                then:
                  - lvgl.page.show: settings_page 
                  - lambda: |-
                      ESP_LOGI("PERF", "=== PAGE SWITCH START: %u ms ===", millis());
                      ESP_LOGI("PERF", "Free heap: %u bytes", esp_get_free_heap_size()); 
                  - lambda: |-
                      ESP_LOGI("PERF", "=== PAGE SWITCH END: %u ms ===", millis());
                      ESP_LOGI("PERF", "Free heap after: %u bytes", esp_get_free_heap_size());                    
              widgets:
                - label:
                    text: "SETTINGS"
                    x: 20
                    y: 55
                    text_color: 0xFFFFFF
                    text_font: roboto_18
                    text_align: left
                - label:
                    text: "${setting}"
                    x: 40
                    y: 8
                    #text_align: CENTER
                    text_color: color_misty_blue
                    text_font: mdi36


          - button:
              id: btn_test
              width: 150
              height: 100 #45
              x: 200 #10
              y: 480
              bg_color: color_steel_blue
              bg_opa: COVER
              radius: 15
              on_click:
                then:
                  - lvgl.page.show: test_page
              widgets:
                - label:
                    text: "CHART"
                    x: 15
                    y: 55 #8
                    text_color: 0xFFFFFF
                    text_font: roboto_18
                    text_align: left
                - label:
                    text: "\U000F0675"
                    x: 40
                    y: 8
                    #text_align: CENTER
                    text_color: color_light_mint
                    text_font: mdi36


          - button:
              id: btn_test2
              width: 150
              height: 100 #45
              x: 380 #10
              y: 480
              bg_color: color_steel_blue
              bg_opa: COVER
              radius: 15
              on_click:
                then:
                  - lvgl.page.show: nfs_dashboard
              widgets:
                - label:
                    text: "NFS"
                    x: 15
                    y: 55 #8
                    text_color: 0xFFFFFF
                    text_font: roboto_18
                    text_align: left
                - label:
                    text: "\U000F062C" #source
                    x: 40
                    y: 8
                    #text_align: CENTER
                    text_color: color_light_mint
                    text_font: mdi36                   
       

          - button:
              id: btn_test3
              width: 150
              height: 100 #45
              x: 380 #10
              y: 220
              bg_color: color_steel_blue
              bg_opa: COVER
              radius: 15
              on_click:
                then:
                  - lvgl.page.show: hall
              widgets:
                - label:
                    text: "HALL"
                    x: 15
                    y: 55 #8
                    text_color: 0xFFFFFF
                    text_font: roboto_18
                    text_align: left
                - label:
                    text: "\U000F05CB" #voice
                    x: 40
                    y: 8
                    #text_align: CENTER
                    text_color: color_light_mint
                    text_font: mdi36     


          - button:
              id: btn_test4
              width: 150
              height: 100 #45
              x: 380 #10
              y: 345
              bg_color: color_steel_blue
              bg_opa: COVER
              radius: 15
              on_click:
                then:
                  - lvgl.page.show: lottie_page
              widgets:
                - label:
                    text: "LOTTIE"
                    x: 15
                    y: 55 #8
                    text_color: 0xFFFFFF
                    text_font: roboto_18
                    text_align: left
                - label:
                    text: "\U000F1322" #tools
                    x: 40
                    y: 8
                    #text_align: CENTER
                    text_color: color_light_mint
                    text_font: mdi36                      
                      
          # Bouton Alarm
          - button:
              id: btn_alarm
              width: 150
              height: 100 #45
              x: 200 #10
              y: 220
              bg_opa: COVER
              radius: 15
              on_press:      
                then:
                  - lvgl.page.show: alarm_panel_page 
                  - lambda: |-
                      ESP_LOGI("PERF", "=== PAGE SWITCH START: %u ms ===", millis());
                      ESP_LOGI("PERF", "Free heap: %u bytes", esp_get_free_heap_size()); 
                  - lambda: |-
                      ESP_LOGI("PERF", "=== PAGE SWITCH END: %u ms ===", millis());
                      ESP_LOGI("PERF", "Free heap after: %u bytes", esp_get_free_heap_size());                       
              widgets:
                - label:
                    text: "ALARM"
                    x: 30
                    y: 55
                    text_color: 0xFFFFFF
                    text_font: roboto_18
                    text_align: left
                - label:
                    text: "${alarm}"
                    x: 45
                    y: 8
                    #text_align: TOP_MID
                    text_color: color_misty_blue
                    text_font: mdi36                       

          #- label:
              #text: "SECURITY CAMERAS"
              #x: 350
              #y: 520
              #text_color: 0xCCCCCC
              #text_font: roboto_30
              #text_align: LEFT
          - button:
              id: btn_light
              width: 150
              height: 100
              x: 10
              y: 220
              bg_color: color_orange
              bg_opa: COVER
              radius: 15
              widgets:
                - label:
                    text: "light"
                    x: 45
                    y: 55
                    text_color: 0xFFFFFF
                    text_font: roboto_18
                    text_align: left
                - label:
                    text: "\U000F18DE"
                    x: 40
                    y: 8
                    #text_align: TOP_MID
                    text_color: color_deep_purple
                    text_font: mdi36 
              on_press:
                then:
                  #- lambda: 'id(display_lock) = false;'  # Déverrouiller d'abord
                  #- delay: 50ms
                  - lvgl.page.show: light_page


              #on_click:
                #then:
                  #- lambda: |-
                      #id(current_image_index) = (id(current_image_index) + 1) % 11;
                  
                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 0;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: sanctuary
                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 1;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: Zephyrus   

                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 2;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: genshin_impact

                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 3;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: irise   

                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 4;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: holohub
                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 5;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: peaceful
                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 6;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: exploration                                                                                                                                                                       
                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 7;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: cheon1 

                  #- if:
                      #condition:
                        #lambda: 'return id(current_image_index) == 8;'
                      #then:
                        #- lvgl.image.update:
                            #id: update_wallpaper
                            #src: abstrac1  
               

              #on_click: 
                    #then:
                      #- lvgl.page.show: alarm_panel_page
                      #- lvgl.page.show: camera_alarm_page
                      


              #on_click:
                #- homeassistant.service:
                    #service: script.open_settings
              #on_click:      
                #then:
                    #- lvgl.page.show: devices_page 
                    #- lvgl.page.show: camera_page                  
                    
          # Bouton Volets
          #- button:
              #id: btn_temp
              #width: 200
              #height: 60
              #x: 615
              #y: 555
              #bg_color: color_steel_blue
              #bg_opa: COVER
              #radius: 15
              #widgets:
                #- label:
                    #text: "CLIMATE"
                    #x: 55
                    #y: 10
                    #text_color: 0xFFFFFF
                    #text_font: roboto_24
                    #text_align: left

                #- label:
                    #text: "\U000F050F"
                    #text_align: left
                    #text_color: color_yellow
                    #text_font: mdi46        
              #on_click:
                #- homeassistant.service:
                    #service: cover.toggle
                    #data:
                      #entity_id: cover.all_shutters
                      
          - button:
              id: btn_player
              width: 150
              height: 100
              x: 10
              y: 345
              bg_color: color_steel_blue
              bg_opa: COVER
              radius: 15
              widgets:
                - label:
                    text: "MEDIA"
                    x: 30
                    y: 55
                    text_color: 0xFFFFFF
                    text_font: roboto_18
                    text_align: left
                - label:
                    text: "\U000F057C"
                    x: 40
                    y: 8
                    #text_align: TOP_MID
                    text_color: color_red
                    text_font: mdi36                         
              #on_click:
                #- homeassistant.service:
                    #service: alarm_control_panel.alarm_arm_home
                    #data:
                      #"entity_id: alarm_control_panel.home_alarm
              on_press:      
                then:
                    - lvgl.page.show: video_page
                    - lambda: |-
                        ESP_LOGI("PERF", "=== PAGE SWITCH START: %u ms ===", millis());
                        ESP_LOGI("PERF", "Free heap: %u bytes", esp_get_free_heap_size()); 
                    - lambda: |-
                        ESP_LOGI("PERF", "=== PAGE SWITCH END: %u ms ===", millis());
                        ESP_LOGI("PERF", "Free heap after: %u bytes", esp_get_free_heap_size());                        

  # ========== AJOUT BOUTON SECURITE SUR PAGE HOME ==========
          #- button:

              #id: btn_security
              #width: 150
              #height: 45
              #x: 400  # Ajustez selon votre layout
              #y: 510
              #bg_color: 0xFF4444
              #bg_opa: COVER
              #radius: 15
              #on_click:
                #then:
                  #- lambda: |-
                      #ESP_LOGI("security", "Ouverture page security");
                      #// Démarrer les caméras en entrant sur la page
                      #id(security_cam_1).set_enabled(true);

                  #- lvgl.page.show: security_page
              #widgets:
                #- label:
                    #text: "SECURITY"
                    #x: 30
                    #y: 8
                    #text_color: 0xFFFFFF
                    #text_font: roboto_18
                    #text_align: left
                #- label:
                    #text: "\U000F07AE"  # MDI shield-lock
                    #text_align: left
                    #text_color: 0xFFFFFF
                    #text_font: mdi36


          - button:
              id: btn_camera
              width: 150
              height: 100
              x: 200
              y: 345
              bg_color: color_deep_purple
              bg_opa: COVER
              radius: 15
              on_click:      
                then:
                  - lvgl.page.show: camera_page 
              widgets:
                - label:
                    text: "CAMERA"
                    x: 30
                    y: 55
                    text_color: 0xFFFFFF
                    text_font: roboto_18
                    text_align: left
                - label:
                    text: "\U000F0C7B"
                    x: 45
                    y: 8
                    #text_align: TOP_MID
                    text_color: color_yellow
                    text_font: mdi36

      - id: light_page
        bg_color: color_slate_blue_gray
        widgets:
          - scale:
              id: speed_scale
              align: CENTER
              width: 280
              height: 280
              mode: ROUND_OUTER
              min_value: 0
              max_value: 200
              rotation: 135
              angle_range: 270
              ticks:
                count: 21
                width: 2
                length: 10
                color: 0x404040
                major:
                  stride: 2
                  width: 4
                  length: 20
                  color: 0xFFFFFF
                  label_show: true
                  label_gap: 12
              sections:
                - id: speed_safe
                  range_from: 0
                  range_to: 120
                  color: 0x00FF00
                  width: 6
                - id: speed_caution
                  range_from: 120
                  range_to: 160
                  color: 0xFFFF00
                  width: 6
                - id: speed_danger
                  range_from: 160
                  range_to: 200
                  color: 0xFF0000
                  width: 6
          - line:
              id: speed_needle
              align: CENTER
              line_width: 6
              line_color: 0xFF0000
              points:
                - 0, 0
                - 0, -110



          # Value display
          - label:
              id: speed_label
              align: CENTER
              y: 20
              text: "0"
              text_color: 0x00FF00
              text_font: montserrat_36

          - label:
              align: CENTER
              y: 55
              text: "km/h"
              text_color: 0x808080         



        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - script.execute: update_weather_display
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms 

      - id: video_page
        bg_color: color_slate_blue_gray
        #on_load:
          #- video_player.play:
              #id: my_video_player
            
        #widgets:
          # Canvas vidéo (géré automatiquement par le composant)
          
          # Bouton Play
          #- obj:
              #id: play_button
              #width: 100
              #height: 100
              #align: BOTTOM_MID
              #y: -40
              #radius: 50
              #clickable: true
              #bg_color: 0x3A3A4C
              #shadow_width: 16
              #shadow_color: 0x000000
              #on_click:
                #- if:
                    #condition:
                      #lambda: 'return id(my_video_player).is_playing();'
                    #then:
                      #- simple_video_player.pause:
                          #id: my_video_player
                      #- lvgl.label.update:
                          #id: play_label
                          #text: "\uF04B"  # Play icon
                    #else:
                      #- simple_video_player.play:
                          #id: my_video_player
                      #- lvgl.label.update:
                          #id: play_label
                          #text: "\uF04C"  # Pause icon
              #widgets:
                #- label:
                    #id: play_label
                    #align: CENTER
                    #text: "\uF04B"

          # Bouton Stop
          #- obj:
              #id: stop_button
              #width: 60
              #height: 60
              #x: -80
              #align: BOTTOM_MID
              #y: -60
              #radius: 30
              #clickable: true
              #bg_color: 0x3A3A4C
              #on_click:
                #- simple_video_player.stop:
                    #id: my_video_player
                #- lvgl.label.update:
                    #id: play_label
                    #text: "\uF04B"
              #widgets:
                #- label:
                    #align: CENTER
                    #text: "\uF04D"  # Stop icon

        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms 

      #- id: security_page
        #bg_color: 0x000000  # Fond noir comme Eufy
        #on_load:
          #- lambda: |-
              #ESP_LOGI("security", "🔒 Page security");
              #auto canvas = id(security_canvas);
              #if (canvas == nullptr) {
                #ESP_LOGE("security", "Canvas sécurity introuvable!");
                #return;
              #}
              #// Canvas plein écran pour les 4 caméras en grille
              #lv_obj_set_size(canvas, 800, 600);
              #lv_obj_set_pos(canvas, 112, 0);  // Centré sur écran 1024x600
              #id(security_display).configure_canvas(canvas);
              #ESP_LOGI("security", "Canvas sécurité configuré: 800x600"); 

        #widgets:
          # ===== TITRE =====
          #- label:
              #id: security_title
              #text: "SECURITY CAMERAS"
              #x: 112
              #y: 10
              #text_color: 0xFFFFFF
              #text_font: roboto_24
              #text_align: LEFT
          # ===== CANVAS PRINCIPAL (affichera la grille 2x2 ou plein écran) =====

          #- canvas:
          #- obj:
              #id: security_canvas
              #width: 800
              #height: 520
              #x: 112
              #y: 50
              #bg_color: 0x000000
              #border_width: 0
              #radius: 0
              #pad_all: 0
          # ===== BOUTON RETOUR =====
          #- button:
              #id: btn_security_back
              #width: 80
              #height: 50
              #x: 930
              #y: 520
              #bg_color: 0xFF4444
              #bg_opa: COVER
              #radius: 10
              #on_click:
                #then:
                  #- lambda: |-
                      #ESP_LOGI("security", "Retour accueil");
                      #// Arrêter toutes les caméras pour économiser bande passante
                      #id(security_cam_1).set_enabled(false);

                  #- lvgl.page.show: page_home
              #widgets:
                #- label:
                    #text: "BACK"
                    #text_color: 0xFFFFFF
                    #text_font: nunito_24
                    #text_align: CENTER
                    #align: CENTER
          # ===== BOUTON START ALL (démarrer toutes les caméras) =====
          #- button:
              #id: btn_start_all_cams
              #width: 80
              #height: 50
              #x: 930
              #y: 100
              #bg_color: 0x00CC44
              #bg_opa: COVER
              #radius: 10
              #on_click:
                #then:
                  #- lambda: |-
                      #ESP_LOGI("security", "▶ Démarrage toutes caméras");
                      #id(security_cam_1).set_enabled(true);

              #widgets:
                #- label:
                    #text: "START"
                    #text_color: 0xFFFFFF
                    #text_font: nunito_20
                    #text_align: CENTER
                    #align: CENTER
          # ===== BOUTON STOP ALL (arrêter toutes les caméras) =====
          #- button:
              #id: btn_stop_all_cams
              #width: 80
              #height: 50
              #x: 930
              #y: 170
              #bg_color: 0xFF4444
              #bg_opa: COVER
              #radius: 10
              #on_click:
                #then:
                  #- lambda: |-
                      #ESP_LOGI("security", "■ Arrêt toutes caméras");
                      #id(security_cam_1).set_enabled(false);


              #widgets:
                #- label:
                    #text: "STOP"
                    #text_color: 0xFFFFFF
                    #text_font: nunito_20
                    #text_align: CENTER
                    #align: CENTER


# ========== PAGE CAMERA ==========
      - id: camera_page
        bg_color: color_slate_blue_gray
        on_load:
          - lambda: |-
              ESP_LOGI("camera", "📷 Page caméra chargée");
              auto canvas = id(camera_canvas);
              if (canvas == nullptr) {
                ESP_LOGE("camera", "Canvas introuvable!");
                return;
              }
              lv_obj_set_size(canvas, 640, 480);
              lv_obj_set_pos(canvas, 192, 60);  
              ESP_LOGI("camera", "Canvas: 800x600 @ (192,60)");

          - lambda: |-
              // Le label et canvas sont accessibles directement par leur id
              id(camera_display).set_stats_label(id(camera_stats_label));
              id(camera_display).configure_canvas(id(camera_canvas));              

        widgets:
          # ===== CANVAS CAMERA =====
          - canvas:
              id: camera_canvas
              width: 640
              height: 480
              x: 192
              y: 30
              bg_color: 0x4682B4
              border_width: 0
              radius: 0
              pad_all: 0

          # Dans votre page LVGL, ajoutez un label:
          - label:
              id: camera_stats_label
              x: 850
              y: 550
              text: "FPS: -- | CPU: --%"
              text_color: 0xFFFFFF

          # ===== BOUTONS GAUCHE (Face Recognition) =====
          
          # Bouton ENROLL (enregistrer visage)
          - button:
              id: btn_enroll_face
              width: 150
              height: 60
              x: 20
              y: 150
              bg_color: 0x00AA00
              bg_opa: COVER
              radius: 10
              on_click:
                then:
                  - lvgl.widget.show: enroll_popup

              widgets:
                - label:
                    text: "ENROLL"
                    text_color: 0xFFFFFF
                    text_font: nunito_24
                    text_align: CENTER
                    align: CENTER

          # Bouton COUNT (nombre de visages)
          - button:
              id: btn_count_faces
              width: 150
              height: 60
              x: 20
              y: 230
              bg_color: 0x0088FF
              bg_opa: COVER
              radius: 10
              on_click:
                then:
                  - lambda: |-
                      int count = id(face_detect).get_enrolled_count();
                      ESP_LOGI("face", "📊 Visages enregistrés: %d", count);
              widgets:
                - label:
                    text: "COUNT"
                    text_color: 0xFFFFFF
                    text_font: nunito_24
                    text_align: CENTER
                    align: CENTER

          # Bouton CLEAR (effacer tous)
          - button:
              id: btn_clear_faces
              width: 150
              height: 60
              x: 20
              y: 310
              bg_color: 0xFF4444
              bg_opa: COVER
              radius: 10
              on_click:
                then:
                  - lambda: |-
                      id(face_detect).clear_all_faces();
                      ESP_LOGI("face", "🗑️ Tous les visages effacés");
              widgets:
                - label:
                    text: "CLEAR FACES"
                    text_color: 0xFFFFFF
                    text_font: nunito_24
                    text_align: CENTER
                    align: CENTER

          # ===== BOUTONS DROITE (Camera Control) =====
          
          # Bouton START (vert)
          - button:
              id: btn_start_streaming
              width: 80
              height: 60
              x: 930
              y: 150
              bg_color: 0x00CC44
              bg_opa: COVER
              radius: 10
              on_click:
                then:
                  - lambda: |-
                      ESP_LOGI("camera", "▶ Démarrage streaming");
                      if (id(tab5_cam).start_streaming()) {
                        ESP_LOGI("camera", "✓ Streaming démarré");
                        lv_obj_set_style_bg_color(id(camera_canvas), lv_color_hex(0x000000), 0);
                      } else {
                        ESP_LOGE("camera", "✗ Échec streaming");
                      }
              widgets:
                - label:
                    text: "START"
                    text_color: 0xFFFFFF
                    text_font: nunito_24
                    text_align: CENTER
                    align: CENTER

          # Bouton STOP (rouge)
          - button:
              id: btn_stop_streaming
              width: 80
              height: 60
              x: 930
              y: 230
              bg_color: 0xFF4444
              bg_opa: COVER
              radius: 10
              on_click:
                then:
                  - lambda: |-
                      ESP_LOGI("camera", "■ Arrêt streaming");
                      id(tab5_cam).stop_streaming();
                      lv_obj_set_style_bg_color(id(camera_canvas), lv_color_hex(0x4682B4), 0);
              widgets:
                - label:
                    text: "STOP"
                    text_color: 0xFFFFFF
                    text_font: nunito_24
                    text_align: CENTER
                    align: CENTER

          # Bouton SNAP (orange)
          - button:
              id: btn_take_snapshot
              width: 80
              height: 60
              x: 930
              y: 310
              bg_color: 0xFF8800
              bg_opa: COVER
              radius: 10
              on_click:
                then:
                  - lambda: |-
                      ESP_LOGI("camera", "📸 Snapshot");
                      if (id(tab5_cam).capture_frame()) {
                        ESP_LOGI("camera", "✓ Frame capturée");
                      }
              widgets:
                - label:
                    text: "SNAP"
                    text_color: 0xFFFFFF
                    text_font: nunito_24
                    text_align: CENTER
                    align: CENTER

          # Bouton BACK (rouge)
          - button:
              id: btn_camera_back
              width: 80
              height: 60
              x: 930
              y: 390
              bg_color: 0xFF4444
              bg_opa: COVER
              radius: 10
              on_click:
                then:
                  - lambda: |-
                      ESP_LOGI("camera", "Retour accueil");
                      id(tab5_cam).stop_streaming();
                  - lvgl.page.show: page_home
              widgets:
                - label:
                    text: "BACK"
                    text_color: 0xFFFFFF
                    text_font: nunito_24
                    text_align: CENTER
                    align: CENTER  

          # ===== POPUP ENREGISTREMENT (SIMPLIFIÉ) =====
          - obj:
              id: enroll_popup
              width: 1024
              height: 600
              x: 0
              y: 0
              bg_color: 0x1a1a2e
              bg_opa: 100%
              hidden: true
              widgets:
                # Titre
                - label:
                    text: "ENREGISTRER UN VISAGE"
                    y: 20
                    align: TOP_MID
                    text_color: 0x00FF00
                    text_font: montserrat_36

                # Zone de saisie du nom
                - textarea:
                    id: name_input
                    width: 800
                    height: 70
                    align: TOP_MID
                    y: 80
                    one_line: true
                    max_length: 20
                    placeholder_text: "Entrez le nom..."
                    bg_color: 0x2d2d44
                    text_color: 0xFFFFFF
                    text_font: montserrat_36
                    border_color: 0x4444AA
                    border_width: 2
                    radius: 10
                    on_ready:
                      then:
                        - lambda: |-
                            const char* name = lv_textarea_get_text(id(name_input));
                            if (name && strlen(name) > 0) {
                              ESP_LOGI("face", "Enregistrement: %s", name);
                              id(face_detect).enroll_face_with_name(name);
                            }
                            lv_textarea_set_text(id(name_input), "");
                        - lvgl.widget.hide: enroll_popup

                # Clavier GRAND
                - keyboard:
                    id: face_keyboard
                    width: 900
                    height: 400
                    align: TOP_MID
                    y: 170
                    mode: TEXT_UPPER
                    textarea: name_input
                    bg_color: 0x2d2d44
                    radius: 10
                    on_cancel:
                      then:
                        - lambda: lv_textarea_set_text(id(name_input), "");
                        - lvgl.widget.hide: enroll_popup
        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms                                        
#######################################################################################################################################################################################
#######################################################################################################################################################################################
      - id: page_sleep
        bg_color: 0x000000
        on_load:
          - lambda: |-
              ESP_LOGI("lock", "🔒 Page veille");
              id(display_lock) = true;
              id(sleep_display_start) = millis();
              
              // Pre-configurer le canvas pour face_unlock_page
              auto canvas = id(face_unlock_canvas);
              if (canvas != nullptr) {
                id(camera_display).configure_canvas(canvas);
              }

          - switch.turn_on: lvgl_display_enable_switch
          
          # Garder le backlight allumé (faible) pour voir l'heure
          - light.turn_on:
              id: backlight
      
        widgets:
          - obj:
              width: 1024
              height: 600
              x: 0
              y: 0
              bg_color: 0x000000
              bg_opa: COVER
              border_opa: TRANSP
          - label:
              id: sleep_time_label
              text: "12:34"
              align: CENTER
              y: -50
              text_color: 0x333333
              text_font: roboto_48
          - label:
              text: "Touch the screen to unlock"
              align: CENTER
              y: 50
              text_color: 0x222222
              text_font: roboto_24
          #- lottie:
              #id: chatbot
              #src: "/sdcard/lottie/Liquid 4 Dot Loader.json"
              #file: "test_prod_lottie/falling-stars.json"
              #align: CENTER
              ##x: 10
              #y: 160
              #width: 160
              #height: 160 

          - lottie:
              id: face_scaning
              file: "lottie/Loading Concept.json"
              #hidden: true
              align: CENTER
              y: 150
              width: 150
              height: 150               

          - obj:
              id: sleep_touch_zone
              width: 1024
              height: 600
              x: 0
              y: 0
              bg_opa: 0%
              border_opa: TRANSP
              on_click:
                then:
                  - lambda: ESP_LOGI("lock", "👆 Touch détecté");
                  - light.turn_on: backlight
                  - lvgl.page.show: face_unlock_page

      # ============ PAGE DÉVERROUILLAGE ============
      - id: face_unlock_page
        bg_color: 0x0d1117

        on_load:
          - lambda: |-
              ESP_LOGI("lock", "Page deverrouillage chargee");
              id(display_lock) = true;
              id(face_detect).reset_last_recognition();
              id(tab5_cam).start_streaming();
              auto canvas = id(face_unlock_canvas);
              if (canvas != nullptr) {
                id(camera_display).configure_canvas(canvas);
              }
              id(unlock_timeout_start) = millis();

        widgets:
          # ===== CANVAS CAMERA (gauche) =====
          - canvas:
              id: face_unlock_canvas
              width: 640
              height: 480
              x: 10
              y: 70
              bg_color: 0x000000
              radius: 8

          # ===== LABEL STATUS (sous le canvas) =====
          - label:
              id: face_status_label
              text: "Aucun visage detecte"
              x: 10
              y: 560
              width: 640
              text_align: CENTER
              text_color: 0x58a6ff
              text_font: roboto_18

          # ===== SECTION CLAVIER PIN (droite) =====
          - obj:
              x: 660
              y: 10
              width: 354
              height: 60
              border_width: 1
              border_color: color_steel_blue
              pad_all: 0
              bg_opa: TRANSP
              shadow_opa: TRANSP
              radius: 15
              widgets:
                - label:
                    id: unlock_code_display
                    align: CENTER
                    text_font: nunito_36
                    text: "enter code"
                    text_color: color_misty_blue
                    text_align: CENTER

          # ===== CLAVIER NUMÉRIQUE =====
          - buttonmatrix:
              id: unlock_keypad
              x: 660
              y: 80
              width: 354
              height: 490
              pad_all: 0
              bg_opa: TRANSP
              border_opa: TRANSP
              items:
                bg_opa: TRANSP
                border_color: color_steel_blue
                border_width: 1
                shadow_opa: TRANSP
                text_font: montserrat_40
                text_color: color_misty_blue
                pressed:
                  bg_color: color_blue
                  text_color: color_white
                  border_color: color_blue
              rows:
                - buttons:
                    - text: 1
                      control:
                        no_repeat: true
                    - text: 2
                      control:
                        no_repeat: true
                    - text: 3
                      control:
                        no_repeat: true
                - buttons:
                    - text: 4
                      control:
                        no_repeat: true
                    - text: 5
                      control:
                        no_repeat: true
                    - text: 6
                      control:
                        no_repeat: true
                - buttons:
                    - text: 7
                      control:
                        no_repeat: true
                    - text: 8
                      control:
                        no_repeat: true
                    - text: 9
                      control:
                        no_repeat: true
                - buttons:
                    - text: "\uF55A"
                      key_code: "*"
                      control:
                        no_repeat: true
                    - text: 0
                      control:
                        no_repeat: true
                    - text: "\uF00C"
                      key_code: "#"
                      control:
                        no_repeat: true

          # ===== BARRE TIMEOUT =====
          - bar:
              id: unlock_timeout_bar
              x: 10
              y: 580
              width: 1004
              height: 12
              value: 100
              bg_color: 0x21262d
              radius: 6
              indicator:
                bg_color: 0x3fb950
                radius: 6

# ========== PAGE YOLO11 DETECTION ==========

      - id: lottie_page
        bg_color: 0x000000



                                                      
                  

        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms               
# ========== PAGE PEDESTRIAN DETECTION ==========

      - id: test_page
        bg_color: 0x000000
 

        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms 

###########################################################################################################################################

      - id: nfs_dashboard
        bg_color: color_black
        widgets:
    

          - arclabel:
              id: curve_text
              text: "The Arc Label is a specialized widget designed to display text along an arc"
              x: 380
              y: 125
              radius: 100
              start_angle: 10
              end_angle: 360
              #rotation: 0
              text_color: color_deep_orange
              text_font: montserrat_24

          - arclabel:
              id: curve_text2
              text: "The Arc Label is a specialized widget"
              x: 350
              y: 100
              radius: 130
              start_angle: 190
              end_angle: 360
              #rotation: 90
              text_color: color_steel_blue
              text_font: nunito_28
          #- arclabel:
              #id: date_text
              #text: ""
              #x: 390
              #y: 155
              #radius: 160   # plus petit que le grand arc
              #start_angle: 120
              #end_angle: 360  # pour suivre tout le cercle intérieur
              ##rotation: 270
              #text_color: color_navy
              #text_font: montserrat_28
              

          #- arclabel:
              #id: curved_label
              #text: "Additional curved text example"
              #x: 350
              #y: 50
              #radius: 100   # encore plus petit
              #start_angle: 0
              #end_angle: 360  # pour cercle intérieur
              #rotation: 270
              #text_color: color_light_mint
              #text_font: montserrat_18


        # Arc pour les chiffres (static)
          #- arclabel:
              #id: hour_markers
              #x: 497
              #y: 90
              #radius: 100
              #start_angle: 0
              #end_angle: 30
              #text_color: color_white
              #text_font: montserrat_18 
              #text: "12 1 2 3 4 5 6 7 8 9 10 11"

        # Arc pour date 
          #- arclabel:
              #id: date_text
              #x: 420
              #y: 95
              #radius: 90
              #start_angle: 40
              #end_angle: 340
              #text_color: color_red
              #text_font: montserrat_24
              #text: ""
                                              
 


        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms 

###################################################################################################################

      - id: Diap_page
        bg_color: color_black

        widgets:
          #- image:
              #id: update_photo
              #src: slideshow_image
              #width: 1280
              #height: 720
              #x: 0
              #y: 0 
       
          - button:
              id: btn_photo
              width: 200
              height: 60
              x: 10
              y: 555
              bg_color: color_steel_blue
              bg_opa: COVER
              radius: 15
              on_click:
                then:

                  - lambda: |
                      // Basculer l'état du diaporama
                      id(slideshow_active) = !id(slideshow_active);
                      
                      if (id(slideshow_active)) {
                        ESP_LOGI("slideshow", "Diaporama démarré");
                      } else {
                        ESP_LOGI("slideshow", "Diaporama mis en pause");
                      }
                            
                  #- component.update: btn_photo # Mettre à jour l'affichage du bouton
              widgets:
                  - label:
                      id: btn_photo_label
                      text: !lambda |
                        if (id(slideshow_active)) {
                          return std::string("PAUSE");
                        } else {
                          return std::string("PLAY");
                        }
                      align: CENTER
                      text_color: color_white


                  - label:
                      id: current_slideshow_interval
                      text: "5s"          # valeur initiale
                      x: 250
                      y: 10
                      text_color: color_white
                      #text_font: FONT_MEDIUM                      

        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms 
   
###########################################################################################################################################################################################


##################################################################################################################################################

      - id: hall
        bg_color: 0x000000
        widgets:
          # HAL Eye (inspired by 2001: A Space Odyssey)
          - obj:
              align: CENTER
              y: -30
              width: 200
              height: 200
              radius: 100
              bg_color: 0x000000
              border_width: 4
              border_color: 0xFF0000
              widgets:
                # Red glow circle
                - obj:
                    align: CENTER
                    width: 150
                    height: 150
                    radius: 75
                    bg_color: 0x330000
                    border_width: 0
                    widgets:
                      # Inner red eye
                      - obj:
                          id: hal_eye
                          align: CENTER
                          width: 80
                          height: 80
                          radius: 40
                          bg_color: 0xFF0000
                          border_width: 0

          # Status text
          - label:
              id: mic_status_label
              align: CENTER
              y: 100
              text: "Listening..."
              text_color: 0xFF0000
              text_font: montserrat_24

          # HAL name
          - label:
              align: BOTTOM_MID
              y: -40
              text: "HAL 9000"
              text_color: 0xFF0000
              text_font: montserrat_20

          # Microphone waveforms (smaller, at bottom)
          - obj:
              align: BOTTOM_MID
              y: -80
              width: 400
              height: 60
              bg_color: 0x1a0000
              radius: 8
              border_width: 1
              border_color: 0x330000
              pad_all: 5
              widgets:
                - chart:
                    id: chart_mic_left
                    x: 0
                    y: 0
                    width: 190
                    height: 50
                    bg_color: 0x0a0000
                    radius: 6
                    border_width: 0
                    type: LINE
                    point_count: 64
                    update_mode: SHIFT
                    div_line_count_hor: 0
                    div_line_count_ver: 0
                    axis_primary_y:
                      min_value: -32768
                      max_value: 32767
                    series:
                      - id: series_mic_left
                        color: 0xFF0000
                        axis: PRIMARY_Y
                    items:
                      bg_opa: TRANSP
                    indicator:
                      width: 0
                      height: 0

                - chart:
                    id: chart_mic_right
                    x: 200
                    y: 0
                    width: 190
                    height: 50
                    bg_color: 0x0a0000
                    radius: 6
                    border_width: 0
                    type: LINE
                    point_count: 64
                    update_mode: SHIFT
                    div_line_count_hor: 0
                    div_line_count_ver: 0
                    axis_primary_y:
                      min_value: -32768
                      max_value: 32767
                    series:
                      - id: series_mic_right
                        color: 0xFF0000
                        axis: PRIMARY_Y
                    items:
                      bg_opa: TRANSP
                    indicator:
                      width: 0
                      height: 0    

        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms                                                       
###############################################################################################################################################


      - id: settings_page
        bg_color: color_black #color_slate_blue_gray
        #on_load:
          #then:
            #- lvgl.image.update:
                #id: update_wallpaper1
                #src: exploration
        widgets:
          #- image:
              #id: update_wallpaper1
              #src: exploration
              #width: 1280
              #height: 720
              #x: 0
              #y: 0 
          # sleep mode:
        # backlight:
          - obj:
              id: backlight_bg
              x: 20
              y: 120
              width: 490
              height: 110
              align: TOP_LEFT
              pad_all: 0
              bg_color: color_blue
              bg_opa: 20%
              border_opa: TRANSP
              border_width: 0
              shadow_opa: TRANSP
              radius: 10
              widgets:

                - label:
                    id: display_backlight_label
                    x: 20
                    align: LEFT_MID
                    text_font: roboto_32
                    text_color: color_blue
                    text: "Backlight"

                - slider:
                    id: display_backlight_brightness_slider
                    x: -25
                    radius: 10
                    bg_color: color_gray
                    align: RIGHT_MID
                    width: 260
                    height: 60
                    min_value: 35
                    max_value: 100
                    value: 100
                    indicator:
                      bg_color: color_deep_orange
                      radius: 10
                    knob:
                      bg_opa: TRANSP
                    on_release:
                      then:
                        - light.turn_on:
                            id: backlight
                            brightness: !lambda return int(x)/ 100.0;


          - obj:
              id: slideshow_bg
              x: 20
              y: 290
              width: 490
              height: 120
              align: TOP_LEFT
              pad_all: 10
              bg_color: color_blue
              bg_opa: 20%
              border_opa: TRANSP
              border_width: 0
              shadow_opa: TRANSP
              radius: 10
              widgets:
                - label:
                    id: display_auto_lock_label
                    x: 10
                    align: LEFT_MID
                    text_font: roboto_32
                    text_color: color_blue
                    text: "Sleep_Display"


                # Bouton moins (-)
                - obj:
                    id: minus_button_slideshow
                    x: 200
                    align: LEFT_MID
                    width: 90
                    height: 90
                    pad_all: 0
                    bg_opa: transp
                    border_opa: transp
                    shadow_opa: TRANSP
                    widgets:
                      - obj:
                          width: 70
                          height: 70
                          align: center
                          clickable: true
                          radius: 50
                          pad_all: 0
                          bg_opa: transp
                          border_opa: transp
                          border_width: 0
                          shadow_width: 8
                          shadow_spread: 2
                          shadow_color: color_black
                          pressed:
                            bg_color: 0x3A3A4C
                            shadow_width: 5
                          on_press:
                            - number.set:
                                id: sleep_display_duration
                                value: !lambda |-
                                  float current = id(sleep_display_duration).state;
                                  if (current > 1) return current - 1;
                                  return current;
                          widgets:
                            - obj:
                                width: 60
                                height: 60
                                align: center
                                clickable: false
                                radius: 45
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                shadow_width: 4
                                shadow_color: 0xFFFFFF
                                shadow_offset_x: -4
                                shadow_offset_y: -2
                                shadow_opa: 30%
                            - obj:
                                width: 65
                                height: 65
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 50
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: minus_label_slideshow
                                      y: -2
                                      align: CENTER
                                      text_font: roboto_32
                                      text_color: color_misty_blue
                                      text: "-"

                # Label affichage valeur actuelle
                - label:
                    id: sleep_display_duration_value
                    x: 285
                    align: LEFT_MID
                    width: 80
                    text_font: roboto_32
                    text_color: color_white
                    text_align: CENTER
                    text: !lambda |-
                      int val = id(sleep_display_duration).state;
                      return (std::to_string(val) + "s").c_str();

                # Bouton plus (+)
                - obj:
                    id: plus_button_auto_lock
                    x: 370
                    align: LEFT_MID
                    width: 90
                    height: 90
                    pad_all: 0
                    bg_opa: transp
                    border_opa: transp
                    border_width: 0
                    shadow_opa: TRANSP
                    widgets:
                      - obj:
                          width: 70
                          height: 70
                          align: center
                          clickable: true
                          radius: 50
                          pad_all: 0
                          bg_opa: transp
                          border_opa: transp
                          border_width: 0
                          shadow_width: 8
                          shadow_spread: 2
                          shadow_color: color_black
                          pressed:
                            bg_color: 0x3A3A4C
                            shadow_width: 5
                          on_press:
                            - number.set:
                                id: sleep_display_duration
                                value: !lambda |-
                                  float current = id(sleep_display_duration).state;
                                  if (current < 30) return current + 1;
                                  return current;
                          widgets:
                            - obj:
                                width: 60
                                height: 60
                                align: center
                                clickable: false
                                radius: 45
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                shadow_width: 4
                                shadow_color: 0xFFFFFF
                                shadow_offset_x: -4
                                shadow_offset_y: -2
                                shadow_opa: 30%
                            - obj:
                                width: 65
                                height: 65
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 50
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: plus_label_auto_lock
                                      y: -2
                                      align: center
                                      text_font: roboto_32
                                      text_color: color_misty_blue
                                      text: "+"


          - obj:
              id: sleep_mode_bg
              x: 20
              y: 450 #280
              width: 490
              height: 120
              align: TOP_LEFT
              pad_all: 10
              bg_color: color_blue
              bg_opa: 20%
              border_opa: TRANSP
              border_width: 0
              shadow_opa: TRANSP
              radius: 10
              widgets:
                - label:
                    id: display_timeout_label
                    x: 10
                    align: LEFT_MID
                    text_font: roboto_32
                    text_color: color_blue
                    text: "Sleep mode"
                
                # Bouton moins (-) avec effet multicouche
                - obj:
                    id: minus_button_main
                    x: 200
                    align: LEFT_MID
                    width: 90
                    height: 90
                    pad_all: 0
                    #clickable: true
                    #radius: 35  # Corrigé: 69/2 = 34.5 ≈ 35
                    bg_opa: transp
                    border_opa: transp
                    shadow_opa: TRANSP
                    widgets:
                      - obj:
                          width: 70
                          height: 70
                          align: center
                          clickable: true
                          radius: 50
                          pad_all: 0
                          bg_opa: transp
                          border_opa: transp
                          border_width: 0
                          shadow_width: 8
                          shadow_spread: 2
                          shadow_color: color_black

                    #border_width: 0
                    #shadow_width: 22
                    #shadow_spread: 2
                          #shadow_color: color_black
                          #shadow_opa: TRANSP
                          pressed:
                            bg_color: 0x3A3A4C
                            shadow_width: 5
                          on_press:
                            #- lvgl.obj.update:
                                #id: minus_button_main
                                #shadow_color: color_sky_blue
                            #- lvgl.label.update:
                                #id: minus_label
                                #text_color: color_sky_blue
                            - number.set:
                                id: auto_off
                                value: !lambda |-
                                  float current = id(auto_off).state;
                                  if (current > -1) return current - 1;
                                  return current;
                         # on_release:
                            #- lvgl.obj.update:
                                #id: minus_button_main
                                #shadow_color: 0x000000
                            #- lvgl.label.update:
                                #id: minus_label
                                #text_color: color_misty_blue
                          widgets:
                            - obj:
                                width: 60
                                height: 60
                                align: center
                                clickable: false
                                radius: 45
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 4
                                shadow_color: 0xFFFFFF
                                shadow_offset_x: -4
                                shadow_offset_y: -2
                                shadow_opa: 30%

                            - obj:
                                width: 65
                                height: 65
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 50
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: minus_label
                                      y: -2
                                      align: CENTER
                                      text_font: roboto_32
                                      text_color: color_misty_blue
                                      text: "-"
                      # Ombre claire (highlight)
                      #- obj:
                          #id: minus_shadow1
                          #width: 75
                          #height: 75
                          #align: CENTER
                          #x: -2
                          #y: -2
                          #clickable: false
                          #radius: 33  # 67/2 = 33.5 arrondi à 33
                          #bg_opa: transp 
                          #border_opa: transp
                          #shadow_width: 4
                          #shadow_color: 0xFFFFFF
                          #shadow_ofs_x: -2
                          #shadow_ofs_y: -2
                          #shadow_opa: 30%
                      # Ombre foncée (profondeur)
                      #- obj:
                          #id: minus_shadow2
                          #width: 75
                          #height: 75
                          #align: CENTER
                          #x: 2
                          #y: 2
                          #clickable: false
                          #radius: 33  # 67/2 = 33.5 arrondi à 33
                          #bg_opa: transp 
                          #border_opa: transp
                          #shadow_width: 8
                          #shadow_color: 0x000000
                          #shadow_ofs_x: 2
                          #shadow_ofs_y: 2
                          #shadow_opa: 50%
                      # Bouton principal interne
                      #- obj:
                          #id: minus_inner
                          #width: 67
                          #height: 67
                          #align: CENTER  # Corrigé: parfaitement centré
                          #clickable: false
                          #radius: 32  # Corrigé: 65/2 = 32.5 arrondi à 32
                          #border_opa: transp
                          #bg_color: color_slate_blue_gray
                          #widgets:
                            #- label:
                                #id: minus_label
                                #align: CENTER  # Déjà correct
                                #text_color: color_misty_blue
                                #text_font: roboto_32
                                #text: "-"
                
                # Affichage valeur actuelle
                - label:
                    id: current_timeout_value
                    x: 285
                    align: LEFT_MID
                    width: 80
                    text_font: roboto_32
                    text_color: color_white
                    text_align: CENTER
                    text: !lambda |-
                      int timeout = id(auto_off).state;
                      if (timeout == -1) return "OFF";
                      return (std::to_string(timeout) + "s").c_str();
                
                # Bouton plus (+) avec effet multicouche
                - obj:
                    id: plus_button_main
                    x: 370
                    align: LEFT_MID
                    width: 90
                    height: 90
                    pad_all: 0
                    #clickable: true
                    #radius: 35  # Corrigé: 69/2 = 34.5 ≈ 35
                    bg_opa: transp
                    border_opa: transp
                    border_width: 0
                    #shadow_width: 22
                    #shadow_spread: 2
                    #shadow_color: 0x000000
                    shadow_opa: TRANSP
                    widgets:
                      - obj:
                          width: 70
                          height: 70
                          align: center
                          clickable: true
                          radius: 50
                          pad_all: 0
                          bg_opa: transp
                          border_opa: transp
                          border_width: 0
                          shadow_width: 8
                          shadow_spread: 2
                          shadow_color: color_black
                          pressed:
                            bg_color: 0x3A3A4C
                            shadow_width: 5
                          on_press:
                            #- lvgl.obj.update:
                                #id: plus_button_main
                                #shadow_color: color_sky_blue
                            #- lvgl.label.update:
                                #id: plus_label
                                #text_color: color_sky_blue
                            - number.set:
                                id: auto_off
                                value: !lambda |-
                                  float current = id(auto_off).state;
                                  if (current < 600) return current + 1;
                                  return current;

                          widgets:                
                            - obj:
                                width: 60
                                height: 60
                                align: center
                                clickable: false
                                radius: 45
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 4
                                shadow_color: 0xFFFFFF
                                shadow_offset_x: -4
                                shadow_offset_y: -2
                                shadow_opa: 30%

                            - obj:
                                width: 65
                                height: 65
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 50
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: plus_label
                                      y: -2
                                      align: center
                                      text_font: roboto_32
                                      text_color: color_misty_blue
                                      text: "+"

                            #on_release:
                              #- lvgl.obj.update:
                                  #id: plus_button_main
                                  #shadow_color: 0x000000
                              #- lvgl.label.update:
                                  #id: plus_label
                                  #text_color: color_misty_blue
                            #widgets:
                              # Ombre claire (highlight)
                              #- obj:
                                  #id: plus_shadow1
                                  #width: 67
                                  #height: 67
                                  #align: CENTER
                                  #x: -2
                                  #y: -2
                                  #clickable: false
                                  #radius: 33  # 67/2 = 33.5 arrondi à 33
                                  #bg_opa: transp 
                                  #border_opa: transp
                                  #shadow_width: 4
                                  #shadow_color: 0xFFFFFF
                                  #shadow_ofs_x: -2
                                  #shadow_ofs_y: -2
                                  #shadow_opa: 30%
                              # Ombre foncée (profondeur)
                              #- obj:
                                  #id: plus_shadow2
                                  #width: 67
                                  #height: 67
                                  #align: CENTER
                                  #x: 2
                                  #y: 2
                                  #clickable: false
                                  #radius: 33  # 67/2 = 33.5 arrondi à 33
                                  #bg_opa: transp 
                                  #border_opa: transp
                                  #shadow_width: 8
                                  #shadow_color: 0x000000
                                  #shadow_ofs_x: 2
                                  #shadow_ofs_y: 2
                                  #shadow_opa: 50%
                              # Bouton principal interne
                              #- obj:
                                  #id: plus_inner
                                  #width: 67
                                  #height: 67
                                  #align: CENTER  # Corrigé: parfaitement centré
                                  #clickable: false
                                  #radius: 32  # Corrigé: 65/2 = 32.5 arrondi à 32
                                  #border_opa: transp
                                  #bg_color: color_slate_blue_gray
                                  #widgets:
                                    #- label:
                                        #id: plus_label
                                        #align: CENTER  # Déjà correct
                                        #text_color: color_misty_blue
                                        #text_font: roboto_32
                                        
                                        #text: "+"

          - obj:
              id: system_info_section
              width: 260        # 320 × 0.80
              height: 232       # 260 × 0.80
              x: 720           # 680 × 0.80
              y: 60            # 80 × 0.80
              bg_color: 0x444444
              bg_opa: COVER
              radius: 12        # 15 × 0.80
              widgets:
                - obj:
                    id: system_info_container
                    x: 0
                    y: 0
                    width: 240        # 300 × 0.80
                    height: 192       # 240 × 0.80
                    align: TOP_LEFT
                    pad_all: 0
                    bg_color: 0x444444
                    bg_opa: 20%
                    border_opa: TRANSP
                    radius: 8         # 10 × 0.80
                    widgets:

                      # --- SRAM ---
                      - obj:
                          y: 8                # 10 × 0.80
                          width: 224          # 280 × 0.80
                          height: 40          # 50 × 0.80
                          align: TOP_MID
                          bg_opa: TRANSP
                          pad_all: 0
                          border_opa: TRANSP
                          widgets:
                            - label:
                                align: TOP_LEFT
                                text: "SRAM Used:"
                                text_font: roboto_16      # 20 × 0.80
                                text_color: color_white
                            - label:
                                id: sram_memory_label
                                align: TOP_RIGHT
                                text: "0/512 KB"
                                text_font: roboto_16
                                text_color: color_green
                            - bar:
                                id: sram_memory_bar
                                y: 24                   # 30 × 0.80
                                width: 216              # 270 × 0.80
                                height: 10              # 12 × 0.80
                                align: TOP_MID
                                pad_all: 0
                                min_value: 0
                                max_value: 100
                                value: 0
                                bg_color: color_gray
                                bg_opa: 50%
                                indicator:
                                  bg_color: color_green

                      # --- PSRAM ---
                      - obj:
                          y: 56               # 70 × 0.80
                          width: 224          # 280 × 0.80
                          height: 40          # 50 × 0.80
                          align: TOP_MID
                          bg_opa: TRANSP
                          pad_all: 0
                          border_opa: TRANSP
                          widgets:
                            - label:
                                align: TOP_LEFT
                                text: "PSRAM Used:"
                                text_font: roboto_16
                                text_color: color_white
                            - label:
                                id: psram_memory_label
                                align: TOP_RIGHT
                                text: "0/8 MB"
                                text_font: roboto_16
                                text_color: color_blue
                            - bar:
                                id: psram_memory_bar
                                y: 24                # 30 × 0.80
                                width: 216           # 270 × 0.80
                                height: 10           # 12 × 0.80
                                align: TOP_MID
                                pad_all: 0
                                min_value: 0
                                max_value: 100
                                value: 0
                                bg_color: color_gray
                                bg_opa: 50%
                                indicator:
                                  bg_color: color_blue

                      # --- CPU Temp ---
                      - obj:
                          y: 104              # 130 × 0.80
                          width: 224
                          height: 24          # 30 × 0.80
                          align: TOP_MID
                          pad_all: 0
                          bg_opa: TRANSP
                          border_opa: TRANSP
                          widgets:
                            - label:
                                align: LEFT_MID
                                text: "CPU Temperature:"
                                text_font: roboto_16
                                text_color: color_white
                            - label:
                                id: chip_temperature_label
                                align: RIGHT_MID
                                text: "0°C"
                                text_font: roboto_16
                                text_color: color_yellow

                      # --- WiFi ---
                      - obj:
                          y: 136              # 170 × 0.80
                          width: 224
                          height: 24          # 30 × 0.80
                          align: TOP_MID
                          pad_all: 0
                          bg_opa: TRANSP
                          border_opa: TRANSP
                          widgets:
                            - label:
                                align: LEFT_MID
                                text: "WiFi Signal:"
                                text_font: roboto_16
                                text_color: color_white
                            - label:
                                id: wifi_signal_label
                                align: RIGHT_MID
                                text: "0 dBm"
                                text_font: roboto_16
                                text_color: color_white

                      # --- IP Address ---
                      - obj:
                          y: 168              # 210 × 0.80
                          width: 224
                          height: 24
                          align: TOP_MID
                          pad_all: 0
                          bg_opa: TRANSP
                          border_opa: TRANSP
                          widgets:
                            - label:
                                align: LEFT_MID
                                text: "IP Address:"
                                text_font: roboto_16
                                text_color: color_white
                            - label:
                                id: ip_address_label
                                align: RIGHT_MID
                                text: "192.168.3.3"
                                text_font: roboto_16
                                text_color: color_white


        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms 


              
########################################################################################################################################################################################################
      #- id: camera_alarm_page
        #bg_color: color_black
        #widgets:
          ## Image de la caméra en plein écran
          #- image:
              #id: cctv_img_lvgl
              #align: CENTER
              #src: cctv_img
              #width: 320
              #height: 240
              #pad_all: 0
              #border_width: 0

          #- button:
              #align: TOP_RIGHT
              #x: 0
              #y: 120
              #width: 50
              #height: 50
              #radius: 25
              #bg_color: 0x000000
              #bg_opa: 100%
              #border_width: 2
              #border_color: color_white
              #id: refresh_camera_btn
              #on_click:
                #then:
                  #- online_image.set_url:
                      #id: cctv_img
                      #url: "${frigate}"  # Ou votre URL d'image
              #widgets:
                #- label:
                    #align: CENTER
                    #text: "\U000F0450"  # Icône rafraîchir
                    #text_font: mdi_media
                    #text_color: color_white



        #on_swipe_up:
          #- lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          #- lvgl.page.show: page_home
          #- light.turn_on: 
              #id: backlight
              #flash_length: 100ms 
#######################################################################################################################################################################################

#########################################################################################################################################################################
      - id: listening_page
        skip: true

            



      #- id: listening_page
        #bg_color: color_black
        #on_load:
          #- script.execute: update_cover_script
        #widgets:
          #- obj:
              #id: cctv_fun
              #width: 320  # Même taille que votre image
              #height: 240
              #align: CENTER  # Centre l'objet sur la page
              #bg_opa: TRANSP  # Fond transparent pour ne voir que l'image
              #border_width: 0  # Pas de bordure

         

        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 100ms 
########################################################################################################################################################################################

      - id: media_player_page


        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms   
                 

###############################################################################################################################################################################################

      - id: alarm_panel_page
        bg_color: color_black
        on_load:
          - lambda: |-
              auto canvas = id(cctv_canvas);  
              if (canvas != nullptr) {
                id(security_cam_1).configure_canvas(canvas);
              }

        
        widgets:
          - obj:
              id: alarm_main_view
              x: 0
              y: 0
              width: 1024
              height: 600
              align: TOP_LEFT
              bg_opa: transp
              border_opa: transp
              widgets:
                # Zone de l'alarme à gauche
                - obj:
                    id: alarm_panel_state_bg
                    x: 30
                    y: 30
                    width: 658
                    height: 120
                    pad_all: 0
                    align: TOP_LEFT
                    bg_color: color_steel_blue
                    bg_opa: 20%
                    border_opa: TRANSP
                    border_width: 0
                    shadow_opa: TRANSP
                    radius: 15
                    widgets:
                      - obj:
                          id: alarm_panel_state_icon_bg
                          x: 30
                          align: LEFT_MID
                          width: 90
                          height: 90
                          radius: 45
                          pad_all: 0
                          bg_color: color_blue
                          bg_opa: 60%
                          shadow_opa: transp
                          border_opa: transp
                          border_width: 0

                      - label:
                          id: alarm_panel_state_icon
                          x: 55
                          align: LEFT_MID
                          text_font: mdi_icons_40
                          text_color: color_green
                          text: "${shield_disarm_icon}"

                      - label:
                          x: 164
                          id: alarm_panel_state_text
                          align: LEFT_MID
                          text_font: nunito_26
                          text_color: color_misty_blue
                          text: ""
                
                - obj:
                    id: alarm_panel_state_control
                    hidden: false
                    x: 30
                    y: 179
                    width: 658
                    height: 389
                    align: TOP_LEFT
                    bg_color: color_steel_blue
                    bg_opa: 20%
                    border_opa: TRANSP
                    shadow_opa: TRANSP
                    radius: 15
                    widgets:
                      # Bouton DISARMED (centre)
                      - obj:
                          id: alarm_panel_button_disarmed
                          width: 299
                          height: 299
                          align: center
                          pad_all: 0
                          bg_opa: transp
                          shadow_opa: transp
                          border_opa: transp
                          widgets:
                            - obj:
                                width: 239
                                height: 239
                                align: center
                                clickable: true
                                radius: 120
                                bg_opa: transp
                                border_opa: transp
                                border_width: 0
                                shadow_width: 38
                                shadow_spread: 6
                                shadow_color: color_black
                                pressed:
                                  bg_color: 0x3A3A4C
                                  shadow_width: 10
                                on_press:
                                  - lambda: |-
                                      id(alarm_panel_pending_action) = std::string("disarm");
                                  - lvgl.widget.show: alarm_panel_keypad_page
                                  - lvgl.widget.hide: alarm_panel_state_bg
                                  - lvgl.widget.hide: alarm_panel_state_control
                            - obj:
                                width: 228
                                height: 228
                                align: center
                                clickable: false
                                radius: 120
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 12
                                shadow_color: 0xFFFFFF
                                shadow_offset_x: -9
                                shadow_offset_y: -5
                                shadow_opa: 30%

                            - obj:
                                width: 228
                                height: 228
                                align: center
                                clickable: false
                                radius: 120
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 12
                                shadow_color: 0x000000
                                shadow_offset_x: 9
                                shadow_offset_y: 5

                            - obj:
                                width: 233
                                height: 233
                                align: center
                                clickable: false
                                radius: 120
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: alarm_panel_state_btn_disarmed
                                      align: center
                                      text_font: mdi_icons_68
                                      text_color: color_steel_blue
                                      text: "${shield_disarm_icon}"

                      # Bouton HOME (haut gauche)
                      - obj:
                          id: alarm_panel_button_home
                          hidden: true
                          width: 164
                          height: 164
                          x: -90
                          y: -90
                          align: center
                          pad_all: 0
                          bg_opa: transp
                          shadow_opa: transp
                          border_opa: transp
                          widgets:
                            - obj:
                                width: 135
                                height: 135
                                align: center
                                clickable: true
                                radius: 75
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                border_width: 0
                                shadow_width: 23
                                shadow_spread: 3
                                shadow_color: color_black
                                pressed:
                                  bg_color: 0x3A3A4C
                                  shadow_width: 8
                                on_press:
                                  - lambda: |-
                                      id(alarm_panel_pending_action) = std::string("arm_home");
                                  - lvgl.widget.show: alarm_panel_keypad_page
                                  - lvgl.widget.hide: alarm_panel_state_bg
                                  - lvgl.widget.hide: alarm_panel_state_control
                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0xFFFFFF
                                shadow_offset_x: -6
                                shadow_offset_y: -3
                                shadow_opa: 30%

                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0x000000
                                shadow_offset_x: 6
                                shadow_offset_y: 3

                            - obj:
                                width: 128
                                height: 128
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 75
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: alarm_panel_state_btn_home
                                      align: center
                                      text_font: mdi_icons_52
                                      text_color: color_steel_blue
                                      text: "${shield_home_icon}"

                      # Bouton AWAY (haut droit)
                      - obj:
                          id: alarm_panel_button_away
                          hidden: true
                          width: 164
                          height: 164
                          x: 90
                          y: -90
                          align: center
                          pad_all: 0
                          bg_opa: transp
                          shadow_opa: transp
                          border_opa: transp
                          widgets:
                            - obj:
                                width: 135
                                height: 135
                                align: center
                                clickable: true
                                radius: 75
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                border_width: 0
                                shadow_width: 23
                                shadow_spread: 3
                                shadow_color: color_black
                                pressed:
                                  bg_color: 0x3A3A4C
                                  shadow_width: 8
                                on_press:
                                  - lambda: |-
                                      id(alarm_panel_pending_action) = std::string("arm_away");
                                  - lvgl.widget.show: alarm_panel_keypad_page
                                  - lvgl.widget.hide: alarm_panel_state_bg
                                  - lvgl.widget.hide: alarm_panel_state_control
                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0xFFFFFF
                                shadow_offset_x: -6
                                shadow_offset_y: -3
                                shadow_opa: 30%

                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0x000000
                                shadow_offset_x: 6
                                shadow_offset_y: 3

                            - obj:
                                width: 128
                                height: 128
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 75
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: alarm_panel_state_btn_away
                                      align: center
                                      text_font: mdi_icons_52
                                      text_color: color_steel_blue
                                      text: "${shield_away_icon}"

                      # Bouton NIGHT (bas gauche)
                      - obj:
                          id: alarm_panel_button_night
                          hidden: true
                          width: 164
                          height: 164
                          x: -90
                          y: 90
                          align: center
                          pad_all: 0
                          bg_opa: transp
                          shadow_opa: transp
                          border_opa: transp
                          widgets:
                            - obj:
                                width: 135
                                height: 135
                                align: center
                                clickable: true
                                radius: 75
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                border_width: 0
                                shadow_width: 23
                                shadow_spread: 3
                                shadow_color: color_black
                                pressed:
                                  bg_color: 0x3A3A4C
                                  shadow_width: 8
                                on_press:
                                  - lambda: |-
                                      id(alarm_panel_pending_action) = std::string("arm_night");
                                  - lvgl.widget.show: alarm_panel_keypad_page
                                  - lvgl.widget.hide: alarm_panel_state_bg
                                  - lvgl.widget.hide: alarm_panel_state_control
                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0xFFFFFF
                                shadow_offset_x: -6
                                shadow_offset_y: -3
                                shadow_opa: 30%

                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0x000000
                                shadow_offset_x: 6
                                shadow_offset_y: 3

                            - obj:
                                width: 128
                                height: 128
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 75
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: alarm_panel_state_btn_night
                                      align: center
                                      text_font: mdi_icons_52
                                      text_color: color_steel_blue
                                      text: "${shield_night_icon}"

                      # Bouton VACATION (bas droit)
                      - obj:
                          id: alarm_panel_button_vacation
                          hidden: true
                          width: 164
                          height: 164
                          x: 90
                          y: 90
                          align: center
                          pad_all: 0
                          bg_opa: transp
                          shadow_opa: transp
                          border_opa: transp
                          widgets:
                            - obj:
                                width: 135
                                height: 135
                                align: center
                                clickable: true
                                radius: 75
                                pad_all: 0
                                bg_opa: transp
                                border_opa: transp
                                border_width: 0
                                shadow_width: 23
                                shadow_spread: 3
                                shadow_color: color_black
                                pressed:
                                  bg_color: 0x3A3A4C
                                  shadow_width: 8
                                on_press:
                                  - lambda: |-
                                      id(alarm_panel_pending_action) = std::string("arm_vacation");
                                  - lvgl.widget.show: alarm_panel_keypad_page
                                  - lvgl.widget.hide: alarm_panel_state_bg
                                  - lvgl.widget.hide: alarm_panel_state_control
                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0xFFFFFF
                                shadow_offset_x: -6
                                shadow_offset_y: -3
                                shadow_opa: 30%

                            - obj:
                                width: 120
                                height: 120
                                align: center
                                clickable: false
                                radius: 68
                                pad_all: 0
                                bg_opa: transp 
                                border_opa: transp
                                shadow_width: 6
                                shadow_color: 0x000000
                                shadow_offset_x: 6
                                shadow_offset_y: 3

                            - obj:
                                width: 128
                                height: 128
                                pad_all: 0
                                align: center
                                clickable: false
                                radius: 75
                                border_opa: transp
                                bg_color: color_slate_blue_gray
                                widgets:
                                  - label:
                                      id: alarm_panel_state_btn_vacation
                                      align: center
                                      text_font: mdi_icons_52
                                      text_color: color_steel_blue
                                      text: "${shield_vacation_icon}"

                # Zone caméra canvas à droite (preview) - 192x144
                - obj:
                    id: camera_preview_container
                    x: 720
                    y: 30
                    width: 250
                    height: 190
                    align: TOP_LEFT
                    bg_color: color_steel_blue
                    bg_opa: 20%
                    border_opa: TRANSP
                    radius: 15
                    clickable: true
                    on_press:
                      - switch.turn_on: camera_1_switch
                      - lvgl.widget.hide: alarm_main_view
                      - lvgl.widget.show: camera_fullscreen_view
                    widgets:
                      #- canvas:
                          #id: cctv_canvas_preview
                          #width: 320 #192
                          #height: 240 #144
                          #x: 29
                          #y: 10
                          #bg_color: 0x000000
                      
                      - label:
                          align: BOTTOM_MID
                          y: -5
                          text_font: nunito_18
                          text_color: color_misty_blue
                          text: "Tap for fullscreen"

                # Zone contrôles caméra
                # Zone contrôles caméra
                - obj:
                    id: camera_controls_bg
                    x: 720
                    y: 240
                    width: 250
                    height: 310
                    align: TOP_LEFT
                    bg_color: color_steel_blue
                    bg_opa: 20%
                    border_opa: TRANSP
                    border_width: 0
                    shadow_opa: TRANSP
                    radius: 10
                    widgets:
                      - label:
                          align: TOP_MID
                          y: 10
                          id: alarm_panel_label_name
                          text_font: nunito_18
                          text_color: color_white
                          text: "Alarm Panel"

                      - button:
                          align: TOP_MID
                          x: 0
                          y: 50
                          width: 200
                          height: 50
                          radius: 25
                          bg_color: 0x27ae60
                          bg_opa: 80%
                          border_width: 1
                          border_color: color_white
                          on_click:
                            - switch.turn_on: camera_1_switch
                          widgets:
                            - label:
                                align: CENTER
                                text_font: nunito_18
                                text_color: color_white
                                text: "Start Camera"

                      - button:
                          align: TOP_MID
                          x: 0
                          y: 120
                          width: 200
                          height: 50
                          radius: 25
                          bg_color: 0xe74c3c
                          bg_opa: 80%
                          border_width: 1
                          border_color: color_white
                          on_click:
                            - switch.turn_off: camera_1_switch
                          widgets:
                            - label:
                                align: CENTER
                                text_font: nunito_18
                                text_color: color_white
                                text: "Stop Camera"

                      - label:
                          align: BOTTOM_MID
                          y: -20
                          text_font: nunito_16
                          text_color: color_misty_blue
                          text: "Camera Controls"

          # Vue caméra plein écran
          - obj:
              id: camera_fullscreen_view
              hidden: true
              x: 0
              y: 0
              width: 1024
              height: 600
              align: TOP_LEFT
              bg_color: color_black
              bg_opa: 100%
              border_opa: transp
              widgets:
                # Canvas plein écran - 640x480
                - canvas:
                    id: cctv_canvas
                    width: 640
                    height: 480
                    x: 192
                    y: 60
                    bg_color: 0x000000

                # Bouton retour
                - button:
                    align: TOP_LEFT
                    x: 20
                    y: 20
                    width: 80
                    height: 50
                    radius: 25
                    bg_color: color_steel_blue
                    bg_opa: 80%
                    border_width: 1
                    border_color: color_white
                    on_click:
                      - switch.turn_off: camera_1_switch
                      - lvgl.widget.hide: camera_fullscreen_view
                      - lvgl.widget.show: alarm_main_view
                    widgets:
                      - label:
                          align: CENTER
                          text_font: nunito_18 
                          text: "Exit"
                          text_color: color_white

                # Bouton stop caméra
                - button:
                    align: TOP_RIGHT
                    x: -20
                    y: 20
                    width: 100
                    height: 50
                    radius: 25
                    bg_color: 0xe74c3c
                    bg_opa: 80%
                    border_width: 1
                    border_color: color_white
                    on_click:
                      - switch.turn_off: camera_1_switch
                    widgets:
                      - label:
                          align: CENTER
                          text: "STOP"
                          text_font: nunito_18
                          text_color: color_white

                # Informations overlay
                #- obj:
                    #align: BOTTOM_MID
                    #x: 0
                    #y: -10
                    #width: 300
                    #height: 50
                    #bg_color: color_steel_blue
                    #bg_opa: 70%
                    #border_opa: transp
                    #radius: 10
                    #widgets:
                      #- label:
                          #id: camera_info_label
                          #align: CENTER
                          #text_font: nunito_16
                          #text_color: color_white
                          #text: "Live Camera Feed - 640x480"

          # Clavier d'alarme
          - obj:
              id: alarm_panel_keypad_page
              hidden: true
              x: 30
              y: 30
              width: 658
              height: 538
              align: TOP_LEFT
              bg_color: color_steel_blue
              bg_opa: 20%
              border_opa: TRANSP
              shadow_opa: TRANSP
              radius: 15
              widgets:
                - obj:
                    width: 598
                    height: 70
                    align: top_mid
                    border_width: 1
                    border_color: color_steel_blue
                    pad_all: 0
                    bg_opa: transp
                    shadow_opa: transp
                    radius: 15
                    widgets:
                      - label:
                          id: alarm_panel_keypad_code_label
                          align: center
                          text_font: nunito_36
                          text: "Enter code"
                          text_color: color_misty_blue
                          text_align: center
                
                - buttonmatrix:
                    id: alarm_panel_keypad
                    width: 598
                    height: 404
                    pad_all: 0
                    bg_opa: transp
                    border_opa: transp
                    x: 3
                    y: 45
                    align: center
                    items:
                      bg_opa: transp
                      border_color: color_steel_blue
                      border_width: 1
                      shadow_opa: transp
                      text_font: montserrat_30
                      text_color: color_misty_blue
                      pressed:
                        bg_color: color_blue
                        text_color: color_white
                        border_color: color_blue
                    rows:
                      - buttons:
                          - text: 1
                            control:
                              no_repeat: true
                          - text: 2
                            control:
                              no_repeat: true
                          - text: 3
                            control:
                              no_repeat: true
                      - buttons:
                          - text: 4
                            control:
                              no_repeat: true
                          - text: 5
                            control:
                              no_repeat: true
                          - text: 6
                            control:
                              no_repeat: true
                      - buttons:
                          - text: 7
                            control:
                              no_repeat: true
                          - text: 8
                            control:
                              no_repeat: true
                          - text: 9
                            control:
                              no_repeat: true
                      - buttons:
                          - text: "\uF55A"
                            key_code: "*"
                            control:
                              no_repeat: true
                          - text: 0
                            control:
                              no_repeat: true
                          - text: "\uF00C"
                            key_code: "#"
                            control:
                              no_repeat: true

        on_swipe_up:
          - lambda: 'lv_indev_wait_release(lv_indev_get_act());'
          - lvgl.page.show: page_home
          - light.turn_on: 
              id: backlight
              flash_length: 50ms 
#################################################################################################################################################################################################                  








####################################################################################################################################################################################################

interval:
  - interval: 60s
    then:
      - lambda: |-
          // Log real memory usage
          const size_t total_sram = 512 * 1024;
          const size_t total_psram = 8 * 1024 * 1024;
          
          size_t free_sram = heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
          size_t used_sram = total_sram - free_sram;
          
          size_t free_psram = heap_caps_get_free_size(MALLOC_CAP_SPIRAM);
          size_t used_psram = total_psram - free_psram;
          
          ESP_LOGI("system_info", "SRAM: %u/%u KB used (%.1f%%)", 
                   used_sram/1024, total_sram/1024, 
                   (used_sram * 100.0) / total_sram);
          
          if (heap_caps_get_total_size(MALLOC_CAP_SPIRAM) > 0) {
            ESP_LOGI("system_info", "PSRAM: %u/%u MB used (%.1f%%)", 
                     used_psram/(1024*1024), total_psram/(1024*1024),
                     (used_psram * 100.0) / total_psram);
          } else {
            ESP_LOGI("system_info", "PSRAM: Not available");
          }




  - interval: 500ms
    then:
      - lambda: |-
          lv_obj_t *current = lv_scr_act();
          
          // ========== GESTION PAGE_SLEEP ==========
          if (current == id(page_sleep)->obj) {
            int duration = (int)id(sleep_display_duration).state;
            
            // Si duration = 0, éteindre immédiatement
            if (duration <= 30) {
              id(backlight).turn_off();
              return;
            }
            
            uint32_t elapsed = (millis() - id(sleep_display_start)) / 1000;
            
            if (elapsed >= duration) {
              // Temps écoulé, éteindre le backlight
              id(backlight).turn_off();
            }
            return;
          }
          
          // ========== GESTION FACE_UNLOCK_PAGE ==========
          if (current != id(face_unlock_page)->obj) return;

          // Vérifier si un visage est détecté - RÉINITIALISER LE TIMEOUT
          int face_count = id(face_detect).get_detected_face_count();
          if (face_count > 0) {
            // Visage détecté = réinitialiser le timeout
            id(unlock_timeout_start) = millis();
          }

          // Timeout désactivé si <= 0
          if (id(face_unlock_timeout_sec) <= 0) return;

          // Calculer le temps restant
          uint32_t elapsed = (millis() - id(unlock_timeout_start)) / 1000;
          int remaining = id(face_unlock_timeout_sec) - elapsed;
          int percent = (remaining * 100) / id(face_unlock_timeout_sec);
          if (percent < 0) percent = 0;
          if (percent > 100) percent = 100;
          lv_bar_set_value(id(unlock_timeout_bar), percent, LV_ANIM_ON);

          // Couleur rouge si < 5 secondes
          if (remaining <= 5) {
            lv_obj_set_style_bg_color(id(unlock_timeout_bar), lv_color_hex(0xf85149), LV_PART_INDICATOR);
          } else {
            lv_obj_set_style_bg_color(id(unlock_timeout_bar), lv_color_hex(0x3fb950), LV_PART_INDICATOR);
          }

          // Mettre à jour le label status
          if (face_count == 0) {
            lv_label_set_text(id(face_status_label), "Aucun visage detecte...");
            lv_obj_set_style_text_color(id(face_status_label), lv_color_hex(0x8b949e), 0);
          } else {
            lv_label_set_text(id(face_status_label), "Visage detecte - Verification...");
            lv_obj_set_style_text_color(id(face_status_label), lv_color_hex(0x58a6ff), 0);
          }

          // Vérifier reconnaissance
          auto result = id(face_detect).get_last_recognition();
          if (result.recognized && result.similarity >= 0.70f) {
            ESP_LOGI("lock", "VISAGE RECONNU! ID=%d sim=%.2f", result.id, result.similarity);
            id(display_lock) = false;
            
            std::string name = id(face_detect).get_last_recognized_name();
            if (!name.empty()) {
              std::string msg = "Bienvenue " + name + "!";
              lv_label_set_text(id(face_status_label), msg.c_str());
            } else {
              lv_label_set_text(id(face_status_label), "Bienvenue!");
            }
            lv_obj_set_style_text_color(id(face_status_label), lv_color_hex(0x3fb950), 0);

            id(tab5_cam).stop_streaming();
            auto canvas = id(camera_canvas);
            if (canvas) id(camera_display).configure_canvas(canvas);
          }

          // Timeout expiré
          if (remaining <= 0) {
            ESP_LOGI("lock", "Timeout - retour veille");
            id(tab5_cam).stop_streaming();
            auto canvas = id(camera_canvas);
            if (canvas) id(camera_display).configure_canvas(canvas);
          }

      # Transition après reconnaissance
      - if:
          condition:
            lambda: |-
              lv_obj_t *current = lv_scr_act();
              return (current == id(face_unlock_page)->obj) && !id(display_lock);
          then:
            - delay: 500ms
            - lvgl.page.show: page_home
            - switch.turn_off: lvgl_display_enable_switch
            

      # Retour veille si timeout
      - if:
          condition:
            lambda: |-
              lv_obj_t *current = lv_scr_act();
              if (current != id(face_unlock_page)->obj) return false;
              if (id(face_unlock_timeout_sec) <= 0) return false;
              uint32_t elapsed = (millis() - id(unlock_timeout_start)) / 1000;
              return elapsed >= id(face_unlock_timeout_sec);
          then:
            - switch.turn_off: lvgl_display_enable_switch
            - switch.turn_off: camera_1_switch 
            - light.turn_off: backlight
            - lvgl.page.show: page_sleep


  #- interval: 50ms
    #then:
      #- lambda: |-
          #static int direction = 1;
          #id(speed_value) += direction * 2;
          #if (id(speed_value) >= 200) direction = -1;
          #if (id(speed_value) <= 0) direction = 1;

    
      #- lvgl.label.update:
          #id: speed_label
          #text:
            #format: "%d"
            #args: [id(speed_value)]


################################################################################################################################          

  #- interval: 10ms
    #then:
      #- lambda: |-
          #// Mettre à jour l'animation GIF sur le canvas
          #if (id(cat).is_loaded() && id(cat).is_animated()) {
            #id(cat).update_canvas_animation(id(gif_canvas), 0, 0);
          #}

      #- lambda: |-
          #// Mettre à jour l'animation GIF sur le canvas
          #if (id(alertBlack).is_loaded() && id(alertBlack).is_animated()) {
            #id(alertBlack).update_canvas_animation(id(gif_canvas2), 0, 0);
          #}          

       

  #- interval: 33ms  # ~30 Hz
    #then:
      #- lambda: |-
          #if (id(tab5_cam).is_streaming()) {
            #id(camera_frame_count)++;
          #}

  #- tab5_camera.take_picture: /camera/test.jpg
  #- interval: 10s
    #then:
      #- online_image.set_url:
          #id: cctv_img
          #url: "${frigate}"

  #- interval: 1s
    #then:
      #- if:
          #condition:
            #lambda: 'return id(slideshow_active) && id(max_images) > 0;'
          #then:
            #- lambda: |-
                #static int counter = 0;
                #counter++;
                #if (counter < id(slideshow_interval).state) return;  // récupérer la valeur du number
                #counter = 0;

                #int current = id(current_image_index);
                #current++;
                #if (current > id(max_images)) {
                  #current = 1;  // Retour au début
                #}
                #id(current_image_index) = current;
                
                #std::string filename = "/diap/NCC" + std::to_string(current) + ".jpg";
                #ESP_LOGI("slideshow", "Chargement image: %s", filename.c_str());

            #- sd_image.load:
                #id: slideshow_image
                #file_path: !lambda |
                  #return "/diap/NCC" + std::to_string(id(current_image_index)) + ".jpg";

            #- lvgl.image.update:
                #id: update_photo
                #src: slideshow_image 




   

key_collector:
  - source_id: alarm_panel_keypad
    min_length: 4
    max_length: 4
    end_keys: "#"
    end_key_required: true
    back_keys: "*"
    allowed_keys: "0123456789*#"
    timeout: 5s
    on_progress:
      - if:
          condition:
            lambda: return (0 != x.compare(std::string{""}));
          then:
            - lvgl.label.update:
                id: alarm_panel_keypad_code_label
                text: !lambda 'return x.c_str();'
          else:
            - lvgl.label.update:
                id: alarm_panel_keypad_code_label
                text_font: nunito_36
                text_color: color_misty_blue
                text: "Enter code"
    on_result:      
      - if:
          condition:
            lambda: 'return x == "${pin_code}";'
          then:
            # Если код верный, отправляем команду в Home Assistant для снятия с охраны

            - if:
                condition:
                  lambda: 'return id(alarm_panel_pending_action) == "disarm";'
                then:
                  - homeassistant.action:
                      action: alarm_control_panel.alarm_disarm
                      data:
                        entity_id: "${alarm_panel_entity}"
                        code: "${pin_code}"
            - if:
                condition:
                  lambda: 'return id(alarm_panel_pending_action) == "arm_home";'
                then:
                  - homeassistant.action:
                      action: alarm_control_panel.alarm_arm_home
                      data:
                        entity_id: "${alarm_panel_entity}"
                        code: "${pin_code}"

            - if:
                condition:
                  lambda: 'return id(alarm_panel_pending_action) == "arm_away";'
                then:
                  - homeassistant.action:
                      action: alarm_control_panel.alarm_arm_away
                      data:
                        entity_id: "${alarm_panel_entity}"
                        code: "${pin_code}"

            - if:
                condition:
                  lambda: 'return id(alarm_panel_pending_action) == "arm_night";'
                then:
                  - homeassistant.action:
                      action: alarm_control_panel.alarm_arm_night
                      data:
                        entity_id: "${alarm_panel_entity}"
                        code: "${pin_code}"

            - if:
                condition:
                  lambda: 'return id(alarm_panel_pending_action) == "arm_vacation";'
                then:
                  - homeassistant.action:
                      action: alarm_control_panel.alarm_arm_vacation
                      data:
                        entity_id: "${alarm_panel_entity}"
                        code: "${pin_code}"

            - lvgl.widget.hide: alarm_panel_keypad_page
            - lvgl.widget.show: alarm_panel_state_bg
            - lvgl.widget.show: alarm_panel_state_control  

  - source_id: unlock_keypad
    min_length: 4
    max_length: 4
    end_keys: "#"
    end_key_required: true
    back_keys: "*"
    allowed_keys: "0123456789*#"
    timeout: 10s
    on_progress:
      - if:
          condition:
            lambda: return (0 != x.compare(std::string{""}));
          then:
            - lvgl.label.update:
                id: unlock_code_display
                text: !lambda |-
                  std::string display = "";
                  for (size_t i = 0; i < x.length(); i++) {
                    display += "* ";
                  }
                  for (size_t i = x.length(); i < 4; i++) {
                    display += "_ ";
                  }
                  return display.c_str();
          else:
            - lvgl.label.update:
                id: unlock_code_display
                text_color: 0xFFFFFF
                text: "_ _ _ _"
    on_result:
      - if:
          condition:
            lambda: 'return x == "${unlock_pin_code}";'
          then:
            # Code correct
            - lvgl.label.update:
                id: unlock_code_display
                text_color: 0x3fb950
                text: "O K"
            - lambda: |-
                ESP_LOGI("unlock", "Code ecran correct - deverrouillage!");
                id(display_lock) = false;
            - delay: 500ms
            - lambda: |-
                id(tab5_cam).stop_streaming();
                auto canvas = id(camera_canvas);
                if (canvas != nullptr) {
                  id(camera_display).configure_canvas(canvas);
                }
            - lvgl.page.show: page_home
          else:
            # Code incorrect
            - lvgl.label.update:
                id: unlock_code_display
                text_color: 0xf85149
                text: "ERREUR"
            - lambda: ESP_LOGW("unlock", "Code ecran incorrect!");
            - delay: 1000ms
            - lvgl.label.update:
                id: unlock_code_display
                text_color: 0xFFFFFF
                text: "_ _ _ _"

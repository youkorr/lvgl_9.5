# =============================================================================
# Current Profile Comparison Chart for ESP32-P4 (800x480 display)
# =============================================================================
# Reproduces a "Current profile comparison" graph with two data series:
#   - MetaShunt V2 (blue line)
#   - PPK2 (orange line)
# X-axis: Time (seconds)
# Y-axis: Current (uA)
#
# Usage: Include this in your ESPHome LVGL pages configuration.
#        Copy the 'globals' and 'interval' sections to your main YAML,
#        and add the page widget tree under your lvgl > pages section.
# =============================================================================

globals:
  - id: chart_data_index
    type: int
    initial_value: "0"
  - id: chart_data_loaded
    type: bool
    initial_value: "false"

# =============================================================================
# DATA LOADING - Populates chart with current profile data on boot
# =============================================================================
interval:
  - interval: 20ms
    then:
      - if:
          condition:
            lambda: 'return !id(chart_data_loaded);'
          then:
            - lambda: |-
                // MetaShunt V2 data (blue) - current in uA
                // Simulates a typical current profile: idle -> spike -> active -> idle
                static const int16_t metashunt_data[] = {
                  12, 15, 10, 18, 14, 11, 16, 13, 20, 15,        // 0.0s - 0.5s: idle (~15 uA)
                  22, 35, 80, 180, 450, 820, 1050, 1220, 1350, 1400, // 0.5s - 1.0s: first spike
                  1380, 1320, 1100, 850, 580, 350, 220, 180, 150, 130, // 1.0s - 1.5s: drop
                  140, 200, 380, 550, 720, 800, 780, 700, 600, 500,  // 1.5s - 2.0s: second spike
                  420, 350, 300, 260, 230, 200, 180, 160, 145, 130,  // 2.0s - 2.5s: gradual decrease
                  120, 110, 100, 95, 88, 82, 78, 72, 68, 65,        // 2.5s - 3.0s: settling
                  60, 55, 52, 48, 45, 42, 40, 38, 35, 32,           // 3.0s - 3.5s: near idle
                  30, 28, 25, 22, 20, 18, 16, 15, 14, 12            // 3.5s - 4.0s: back to idle
                };

                // PPK2 data (orange) - similar profile with slight variations
                static const int16_t ppk2_data[] = {
                  18, 20, 14, 22, 17, 15, 19, 16, 24, 19,           // 0.0s - 0.5s: idle (~18 uA)
                  28, 42, 95, 200, 480, 860, 1100, 1280, 1380, 1420, // 0.5s - 1.0s: first spike (slightly higher)
                  1410, 1360, 1150, 880, 600, 370, 240, 195, 165, 142, // 1.0s - 1.5s: drop
                  155, 220, 400, 580, 750, 830, 810, 730, 620, 520,  // 1.5s - 2.0s: second spike
                  440, 370, 315, 275, 242, 210, 190, 170, 155, 140,  // 2.0s - 2.5s: gradual decrease
                  128, 118, 108, 102, 95, 88, 84, 78, 74, 70,       // 2.5s - 3.0s: settling
                  66, 60, 56, 52, 48, 45, 43, 40, 38, 35,           // 3.0s - 3.5s: near idle
                  33, 30, 28, 25, 22, 20, 18, 17, 16, 15            // 3.5s - 4.0s: back to idle
                };

                static const int total_points = 80;
                int i = id(chart_data_index);

                if (i < total_points) {
                  // Load 4 points per tick for faster loading
                  for (int j = 0; j < 4 && (i + j) < total_points; j++) {
                    // These will be set via the actions below
                  }
                }
            # Load MetaShunt V2 data point
            - lvgl.chart.set_next_value:
                id: current_profile_chart
                series_id: metashunt_series
                value: !lambda |-
                  static const int16_t data[] = {
                    12, 15, 10, 18, 14, 11, 16, 13, 20, 15,
                    22, 35, 80, 180, 450, 820, 1050, 1220, 1350, 1400,
                    1380, 1320, 1100, 850, 580, 350, 220, 180, 150, 130,
                    140, 200, 380, 550, 720, 800, 780, 700, 600, 500,
                    420, 350, 300, 260, 230, 200, 180, 160, 145, 130,
                    120, 110, 100, 95, 88, 82, 78, 72, 68, 65,
                    60, 55, 52, 48, 45, 42, 40, 38, 35, 32,
                    30, 28, 25, 22, 20, 18, 16, 15, 14, 12
                  };
                  int i = id(chart_data_index);
                  if (i < 80) return data[i];
                  return 0;
            # Load PPK2 data point
            - lvgl.chart.set_next_value:
                id: current_profile_chart
                series_id: ppk2_series
                value: !lambda |-
                  static const int16_t data[] = {
                    18, 20, 14, 22, 17, 15, 19, 16, 24, 19,
                    28, 42, 95, 200, 480, 860, 1100, 1280, 1380, 1420,
                    1410, 1360, 1150, 880, 600, 370, 240, 195, 165, 142,
                    155, 220, 400, 580, 750, 830, 810, 730, 620, 520,
                    440, 370, 315, 275, 242, 210, 190, 170, 155, 140,
                    128, 118, 108, 102, 95, 88, 84, 78, 74, 70,
                    66, 60, 56, 52, 48, 45, 43, 40, 38, 35,
                    33, 30, 28, 25, 22, 20, 18, 17, 16, 15
                  };
                  int i = id(chart_data_index);
                  if (i < 80) return data[i];
                  return 0;
            - lambda: |-
                id(chart_data_index)++;
                if (id(chart_data_index) >= 80) {
                  id(chart_data_loaded) = true;
                }

# =============================================================================
# LVGL CONFIGURATION - Current Profile Comparison Chart
# =============================================================================
lvgl:
  displays:
    - display_id: my_display
      pages:
        - id: current_profile_page
          bg_color: 0xFFFFFF
          widgets:
            # ===== TITLE =====
            - label:
                x: 250
                y: 8
                width: 300
                text_align: CENTER
                text: "Current profile comparison"
                text_color: 0x333333
                text_font: montserrat_20

            # ===== LEGEND =====
            # MetaShunt V2 legend (blue square + text)
            - obj:
                x: 240
                y: 38
                width: 14
                height: 14
                bg_color: 0x1F77B4
                radius: 2
                border_width: 0
                scrollable: false
            - label:
                x: 260
                y: 36
                text: "MetaShunt V2"
                text_color: 0x333333
                text_font: montserrat_14

            # PPK2 legend (orange square + text)
            - obj:
                x: 380
                y: 38
                width: 14
                height: 14
                bg_color: 0xFF7F0E
                radius: 2
                border_width: 0
                scrollable: false
            - label:
                x: 400
                y: 36
                text: "PPK2"
                text_color: 0x333333
                text_font: montserrat_14

            # ===== Y-AXIS LABEL =====
            - label:
                x: 5
                y: 220
                text: "uA"
                text_color: 0x666666
                text_font: montserrat_14

            # ===== Y-AXIS SCALE (left side) =====
            - scale:
                id: y_axis_scale
                x: 18
                y: 62
                width: 65
                height: 360
                mode: VERTICAL_LEFT
                min_value: -100
                max_value: 1500
                ticks:
                  count: 17
                  width: 1
                  length: 5
                  color: 0xCCCCCC
                  major:
                    stride: 2
                    width: 1
                    length: 10
                    color: 0x999999
                    label_show: true
                    label_gap: 5

            # ===== CHART =====
            - chart:
                id: current_profile_chart
                x: 80
                y: 62
                width: 680
                height: 360
                type: LINE
                point_count: 80
                update_mode: SHIFT
                # White background with light gray border
                bg_color: 0xFAFAFA
                border_width: 1
                border_color: 0xDDDDDD
                # Grid lines
                div_line_count_hor: 8
                div_line_count_ver: 9
                # Line styling
                items:
                  line_width: 2
                # Point indicator (small dots)
                indicator:
                  radius: 0
                # Y-axis range: -100 to 1500 uA
                axis_primary_y:
                  min_value: -100
                  max_value: 1500
                axis_secondary_y:
                  min_value: -100
                  max_value: 1500
                # Data series
                series:
                  # MetaShunt V2 - Blue
                  - id: metashunt_series
                    color: 0x1F77B4
                    axis: PRIMARY_Y
                  # PPK2 - Orange
                  - id: ppk2_series
                    color: 0xFF7F0E
                    axis: PRIMARY_Y

            # ===== X-AXIS LABELS =====
            - label:
                x: 80
                y: 428
                text: "0s"
                text_color: 0x666666
                text_font: montserrat_12
            - label:
                x: 155
                y: 428
                text: "0.5s"
                text_color: 0x666666
                text_font: montserrat_12
            - label:
                x: 230
                y: 428
                text: "1.0s"
                text_color: 0x666666
                text_font: montserrat_12
            - label:
                x: 305
                y: 428
                text: "1.5s"
                text_color: 0x666666
                text_font: montserrat_12
            - label:
                x: 380
                y: 428
                text: "2.0s"
                text_color: 0x666666
                text_font: montserrat_12
            - label:
                x: 455
                y: 428
                text: "2.5s"
                text_color: 0x666666
                text_font: montserrat_12
            - label:
                x: 530
                y: 428
                text: "3.0s"
                text_color: 0x666666
                text_font: montserrat_12
            - label:
                x: 605
                y: 428
                text: "3.5s"
                text_color: 0x666666
                text_font: montserrat_12
            - label:
                x: 680
                y: 428
                text: "4.0s"
                text_color: 0x666666
                text_font: montserrat_12

            # ===== X-AXIS TITLE =====
            - label:
                x: 350
                y: 452
                width: 100
                text_align: CENTER
                text: "Time (s)"
                text_color: 0x666666
                text_font: montserrat_14
